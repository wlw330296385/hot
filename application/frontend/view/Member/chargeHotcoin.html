<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>充币</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!--标准mui.css-->
    <link rel="stylesheet" href="/static/frontend/css/mui.min.css">
    <!--自定义style.css-->
    <link rel="stylesheet" type="text/css" href="/static/frontend/css/style.css"/>
    <style>
        .charge-form {
            width: 80%;
            margin: 30px auto;
            font-size: 14px;
            color: #737373;
        }
        .charge-form input[type=number]{
            margin-top: 10px;
            padding: 30px 35px;
            font-size: 34px;
            border: none;
            border-radius: 0;
            border-bottom: 1px solid #EEE;
        }
        .charge-form .hot-input { position: relative; }
        .charge-form .hot-input .money{ position: absolute; font-size: 20px; top:30px; }
        .mui-btn-block{
            padding: 10px 0;
            font-size: 16px;
        }
        .tips{
            font-size: 12px;
            color:#999;
            text-align: center;
        }
        select.payType {
            width: 70%;
            float: right;
            padding: 0px 5px;
            margin: 0px;
            direction: rtl;
        }
    </style>
</head>

<body class="whitebg">
<header id="header" class="mui-bar mui-bar-nav subheader">
    <a class="mui-icon mui-icon-closeempty mui-pull-left"></a>
    <h1 class="mui-title">热币（Hotcoin）充值</h1>
</header>
<div class="mui-content whitebg">

        <form action="" class="charge-form">
            <div class="hot-input">
                <label>充币数额</label>
                <span class="mui-pull-right">⇄</span>
                <select name="payType" class="payType">
                    <option value="1">微信支付 </option>
                    <option value="2">钱包余额（￥{$memberInfo['balance']}）支付</option>
                </select>
            </div>
                <div class="hot-input"><span class="money">ℋ</span><input type="number" name="sum" class="input" placeholder=""></div>
                <button type="button" class="mui-btn mui-btn-primary mui-btn-block" id="submitCharge">提交充值</button>
                <div class="tips">支持微信支付和钱包余额支付</div>
        </form>

</div>

</body>
<script src="/static/frontend/js/mui.min.js"></script>
<script src="/static/frontend/js/jquery-3.2.1.min.js"></script>
<script src="/static/frontend/js/wooApi.js"></script>
<script>
    var backTotal = wooApi.GetQueryString('backTotal');
    //初始化
    mui.init({
        swipeBack: true //启用右滑关闭功能
    });

    $(function () {

        if(backTotal!=""){
            $("input[name='sum']").val(backTotal);
        }

        $(".mui-icon-closeempty").click(function () {
            window.parent.closeWindow();
        });


        $("#submitCharge").click(function () {
            var sum = $("input[name='sum']").val();
            if(!(/^[1-9]+?[0-9]*$/).test(sum)){
                mui.alert("请填写数值大于零的整数，谢谢！");
                return false;
            }
            var payType = $("select[name='payType']").val();
            if(payType==1){
                //通过微信支付充币

                //处理url参数
                var backUrl = '{:request()->server("http_referer")}';
                if(backUrl.indexOf("?")!=-1){
                    backUrl = backUrl + '&backTotal='+sum;
                }else{
                    backUrl = backUrl + '?backTotal='+sum;
                }
                backUrl = changeURLArg(backUrl,"backTotal",sum);
                //跳转到支付页面
                top.location = "{:url('/index/wechatpay/wechatpay')}"+'?total='+sum+'&type=2&title=热币充值&backUrl='+backUrl;
            }else{
                //通过钱包余额充币
                if(parseFloat(sum)> parseFloat("{$memberInfo['balance']}") ){
                    mui.alert("操作失败，您要充值的数额大于您的个人余额！")
                    return false;
                }
                //余额充币接口
            }
        });

    })

    //url 目标url
    //arg 需要替换的参数名称
    //arg_val 替换后的参数的值
    //return url 参数替换后的url
    function changeURLArg(url,arg,arg_val){
        var pattern=arg+'=([^&]*)';
        var replaceText=arg+'='+arg_val;
        if(url.match(pattern)){
            var tmp='/('+ arg+'=)([^&]*)/gi';
            tmp=url.replace(eval(tmp),replaceText);
            return tmp;
        }else{
            if(url.match('[\?]')){
                return url+'&'+replaceText;
            }else{
                return url+'?'+replaceText;
            }
        }
        return url+'\n'+arg+'\n'+arg_val;
    }
</script>
</html>