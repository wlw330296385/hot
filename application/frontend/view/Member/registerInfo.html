<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>学球登记</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!--标准mui.css-->
    <link rel="stylesheet" href="/static/frontend/css/mui.min.css">
    <!--自定义style.css-->
    <link rel="stylesheet" type="text/css" href="/static/frontend/css/style.css" />
    <style>
        .tipContent {
            margin: 25px 25px 0 25px;
            line-height: 54px;
            vertical-align: middle;
            display: inline-flex;
        }

        .tipContent span {
            font-size: 3.5rem;
            color: #dd524d !important;
        }

        .tipContent .tipContentText {
            height: 54px;
            padding: 7px 0px;
        }

        .tipContent .tipContentText p {
            margin-bottom: 0;
            line-height: 20px;
        }

        .tipBottom {
            margin: 15px 40px;
        }

        .tipBottom p {
            margin-bottom: 0;
            color: #c3c3c3;
        }

        .registerFrom {
            margin: 0 25px;
            background: none;
        }

        .registerFrom .mui-input-row {
            margin-top: 15px;
            background: #fff;
        }

        .registerFrom label {
            line-height: inherit;
        }

        .registerFrom label .iconfont {
            font-size: 24px !important;
        }

        .registerFrom::before {
            height: 0;
        }

        .registerFrom .mui-input-row::after {
            height: 0;
        }

        .inputHalf {
            width: 47%;
            background: #fff;
        }
    </style>
</head>

<body style="background-image:url('/static/frontend/images/xueqiubg.jpg')">

    <header class="mui-bar mui-bar-nav subheader">
        <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
        <h1 class="mui-title">学球登记</h1>
    </header>

    <div class="mui-content mt55" style="background: none !important">

        <div class="tipContent">
            <span class="iconfont icon-logo-Big"></span>
            <div class="tipContentText">
                <p>Hi,请填写以下信息</p>
                <p>我们将为你推荐最佳课程或教练</p>
            </div>
        </div>

        <form action="" class="mui-input-group registerFrom">
            <input type="hidden" name="__token__" class="data" value="{$Request.token}" />
            <input type="hidden" name="member_id" class="data" value="{$memberInfo['id']}" />
            <div class="mui-input-row" style="background: none">
                <div class="inputHalf fl">
                    <label>
                        <i class="iconfont icon-nav-mine colororange"></i>
                    </label>
                    {if $memberInfo.id>0}
                    <input type="text" class="data" name="name" value="{$memberInfo.member}" placeholder="姓名">{else/}
                    <input type="text" class="data" name="name" value="" placeholder="姓名">{/if}
                </div>
                <div class="inputHalf fr">
                    <label>
                        <i class="iconfont icon-activity-Startingtim colororange"></i>
                    </label>
                    <input type="number" class="data" name="age" value="" placeholder="年龄">
                </div>

            </div>

            <div class="mui-input-row">
                <label>
                    <i class="iconfont icon-home-campus colororange"></i>
                </label>
                <input type="text" class="data" name="school" value="" placeholder="学校">
            </div>

            <div class="mui-input-row">
                <label>
                    <i class="iconfont icon-nav-Home colororange"></i>
                </label>
                <input type="text" class="data" name="address" value="" placeholder="住所">
            </div>

            <div class="mui-input-row">
                <label>
                    <i class="iconfont icon-activity-phone colororange"></i>
                </label>
                {if $memberInfo.id>0}
                <input type="text" class="data" name="telephone" value="{$memberInfo.telephone}" disabled placeholder="电话">{else/}
                <input type="text" class="data" name="telephone" value="" placeholder="电话">{/if}
            </div>

            <div class="mui-input-row smsValidate {if $memberInfo.id>0}hide{else/}show{/if}">
                <label class="colororange">短信验证码</label>
                <input type="button" class="code-btn" value="获取验证码" onclick="sendCode(this)" style="width: 30%;">
                <input id="code" type="number" class="input reg_code reg_validate" placeholder="输入验证码" style="width: 30%;">
            </div>

            <div class="mui-input-row" style="height: auto !important;">
                <textarea name="remarks" class="mui-text-left remarks" rows="4" value="" placeholder="备注:请填写您的备注信息"></textarea>
            </div>
        </form>
        <div class="tipBottom">
            <p>Hi,我是学球小助手</p>
            <p>请填写以下信息</p>
            <p>我们将为你推荐最佳课程或教练</p>
        </div>

        <ul class="mui-table-view operation">
            <li class="mui-table-view-cell mui-col-xs-12 opli bggreen submitAction">
                提交
            </li>
        </ul>

    </div>

    <script src="/static/frontend/js/mui.min.js"></script>
    <script src="/static/frontend/js/jquery-3.2.1.min.js"></script>
    <script src="/static/frontend/js/common.js"></script>
    <script src="/static/frontend/js/wooApi.js"></script> {if $memberInfo.id>0}{else/}
    <script src="/static/frontend/js/smsCode.js"></script>{/if}

    <script>
        mui(".mui-content").on("tap", "a", function () {
            window.top.location.href = this.href;
        });

        //定义全局变量

        $(function () {
            var flagMember = false;
            var flagPhone = false;
            var flagSMS = false;
            var mID = "{$memberInfo.id}";

            //获取定位省市区
            var getLocationTB = getLocationApi("{:url('api/Location/getLocation')}");
            var gCity = getLocationTB['city'];
            var gProvince = getLocationTB['province'];
            var gArea = getLocationTB['area'];
            if (gCity == null || gCity == "undefined") {
                gCity = "";
            }
            if (gProvince == null || gProvince == "undefined") {
                gProvince = "";
            }
            if (gArea == null || gArea == "undefined") {
                gArea = "";
            }

            // 验证姓名是否符合要求
            $("input[name='name']").on("blur", function () {
                var member = $.trim($(this).val());
                $(this).val(member);
                console.log(member)
                //判断会员名格式
                if (((/\s/).test(member)) === true) {
                    flagMember = false;
                    mui.alert("会员名不许有空格");
                    return false;
                } else if ((/^[\u4E00-\u9FA5A-Za-z0-9_]{2,15}$/).test(member) === false) {
                    flagMember = false;
                    mui.alert("会员名只能包含英文、数字或中文，长度为2-15位");
                    return false;
                }

            });

            // 非会员判断的操作
            if (mID == 0) {

                //判断用户名是否存在
                $("input[name='name']").on("blur", function () {
                    var member = $.trim($("input[name=name]").val());
                    mui.ajax("{:url('api/login/isFieldRegisterApi')}", {
                        data: {
                            'field': 'member',
                            'value': member
                        },
                        dataType: 'json', //服务器返回json格式数据
                        type: 'post', //HTTP请求类型
                        timeout: 10000, //超时时间设置为10秒；
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        success: function (data) {
                            console.log(data);
                            if (data.msg == 1) {
                                flagMember = false;
                                mui.alert("该会员名称已经存在，请使用其他名称！");
                                return false;
                            } else {
                                flagMember = true;
                            }
                        },
                        error: function (xhr, type, errorThrown) {
                            console.log(type);
                        }
                    });
                })

                //验证是否注册的手机号
                $('input[name=telephone]').on("blur", function () {
                    var telephone = $(this).val();
                    if (telephone != "") {
                        if (!(/^1[34578]\d{9}$/).test(telephone)) {
                            //判断手机号码格式是否正确
                            mui.toast("请填写正确的手机格式");
                            flagPhone = false;
                        } else {
                            //判断是否已经注册的会员手机号
                            mui.ajax("{:url('api/login/isFieldRegisterApi')}", {
                                data: {
                                    'field': 'telephone',
                                    'value': telephone
                                },
                                dataType: 'json', //服务器返回json格式数据
                                type: 'post', //HTTP请求类型
                                async: false,
                                timeout: 10000, //超时时间设置为10秒；
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                success: function (data) {
                                    console.log(data);
                                    //判断该手机号码是否已经是注册会员
                                    if (data.msg == 1) {
                                        mui.alert("该手机号码已被注册！");
                                        flagPhone = false;
                                    }else{
                                        flagPhone = true;
                                    }
                                },
                                error: function (xhr, type, errorThrown) {
                                    console.log(type);
                                }
                            });
                        }
                    }
                });

                //验证短信验证码
                $('#code').on("blur", function () {
                    console.log(1111)
                    var code = document.getElementById('code').value;
                    var codeReg = /^\d{6,6}$/;
                    if (!codeReg.test(code)) {
                        mui.toast('请填写正确的验证码');
                        flagSMS = false;
                    } else {
                        var telephone = $("input[name=telephone]").val();
                        var result = smsCode.validateSmsCodeApi(telephone, code,
                            "{:url('api/sms/validateSmsCodeApi','','',true)}");
                        if (result.code == 200) {
                            flagSMS = true;
                            // mui.toast(result.msg);
                        } else {
                            flagSMS = false;
                            mui.toast(result.msg);
                        }
                    }
                });

            }


            //点击提交事件
            $(".submitAction").on("tap", function () {
                setTimeout(function () {

                    console.log(1111)
                    var name = $("input[name=name]").val();
                    var age = $("input[name=age]").val();
                    var school = $("input[name=school]").val();
                    var address = $("input[name=address]").val();
                    var remarks = $(".remarks").val();
                    var token = $('input[name=__token__]').val();

                    if (name == '') {
                        mui.toast("请填写姓名");
                        return false;
                    }
                    if (age == '') {
                        mui.toast("请填写年龄");
                        return false;
                    }
                    if (school == '') {
                        mui.toast("请填写在读学校");
                        return false;
                    }
                    if (address == '') {
                        mui.toast("请填写所在居住地");
                        return false;
                    }

                    // 非平台会员提交操作
                    if (mID == 0) {
                        var telephone = $("input[name=telephone]").val();
                        if (flagMember == false) {
                            mui.toast("提交失败，姓名填写有误，请重新填写！");
                            return false;
                        };

                        if (telephone == '') {
                            mui.toast("请输入手机号码");
                            return false;
                        }
                        if (!(/^1[34578]\d{9}$/).test(telephone)) {
                            mui.toast("请填写正确的手机格式");
                            return false;
                        }

                        if (flagPhone == false) {
                            mui.toast("提交失败，姓名填写有误，请重新填写！");
                            return false;
                        };

                        if (flagSMS == false) {
                            mui.toast("提交失败，验证码填写有误");
                            return false;
                        };

                        //如已经通过以上验证则创建会员账号
                        mui.ajax("{:url('api/login/registerApi')}", {
                            data: {
                                member: name,
                                telephone: telephone,
                                province: gProvince,
                                city: gCity,
                                area: gArea,
                                __token__: token,
                            },
                            dataType: 'json', //服务器返回json格式数据
                            type: 'post', //HTTP请求类型
                            async: false,
                            timeout: 10000, //超时时间设置为10秒；
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            success: function (data) {
                                //服务器返回响应，根据响应结果，分析是否登录成功；
                                console.log(data);
                                if (data.code == 200) {
                                    $("input[name='member_id']").val(data.id)
                                    gxToken();
                                } else {
                                    mui.alert(data.msg, '提交失败', '确定', function () {
                                        gxToken();
                                    })
                                }
                            },
                            error: function (xhr, type, errorThrown) {
                                //异常处理；
                                console.log(type);
                            }
                        });

                    }

                    var data = wooApi.getInputData('input', 'data');
                    datas = wooApi.getInputData('select', 'data', data);
                    // 获取其他标签值
                    arrData = wooApi.getDomData('domData', datas);
                    var objData = wooApi.arrTOobj(arrData);
                    objData.remarks = $(".remarks").val();
                    var url = "{:url('api/member/createstudyinterion')}";
                    var ajaxResult = wooApi.asyncF(url, objData);
                    if (ajaxResult.code == 200) {
                        mui.alert('登记成功，工作人员将会尽快与您联系', "", '确定', function () {
                            window.location.href = "{:url('index/index')}"
                        })
                    } else {
                        mui.alert(ajaxResult.msg, '提交失败', function () {});
                        gxToken()
                    }
                })
            })

        });


        // 更新token
        function gxToken() {
            mui.ajax("{:url('api/frontend/reloadtoken')}", {
                data: {},
                dataType: 'json', //服务器返回json格式数据
                type: 'post', //HTTP请求类型
                async: false,
                timeout: 10000, //超时时间设置为10秒；
                headers: {
                    'Content-Type': 'application/json'
                },
                success: function (data) {
                    console.log(data)
                    if (data.code == 200) {
                        $('input[name=__token__]').val(data.data);
                    }
                }
            })
        }

        // 发送短信验证码
        function sendCode(obj) {
            var telephone = $("input[name=telephone]").val();
            var telephoneReg = /^1[34578]\d{9}$/;
            if (!telephoneReg.test(telephone)) {
                mui.toast('请填写正确的手机号码');
            } else {
                var result = smsCode.getMobileCodeApi(obj, telephone,
                    "{:url('api/sms/getMobileCodeApi','','',true)}");
                if (result.code == 200) {
                    // mui.toast(result.msg);
                } else {
                    mui.toast(result.msg);
                }
            }
        }
    </script>
</body>

</html>