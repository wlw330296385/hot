<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>课程订单支付</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!--标准mui.css-->
    <link rel="stylesheet" href="/static/frontend/css/mui.min.css">
    <!--icon扩展样式icons-extra.css-->
    <link rel="stylesheet" type="text/css" href="/static/frontend/css/icons-extra.css"/>
    <!--App自定义的css-->
    <link rel="stylesheet" type="text/css" href="/static/frontend/css/app.css"/>
    <!--自定义style.css-->
    <link rel="stylesheet" type="text/css" href="/static/frontend/css/style.css"/>
</head>

<body class=whitebg>

<header id="header" class="mui-bar mui-bar-nav subheader">
    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left arrow"></a>
    <h1 class="mui-title">确认订单</h1>
</header>
<div class="mui-content">

    <!--课程订单支付-->
        <div class="list">
            <ul class="mui-table-view">
                <li class="mui-table-view-cell mui-media listli mb">
                    <a href="javascript:;">
                        <img class="mui-media-object mui-pull-left" src="{$lessonInfo.cover}">
                        <div class="mui-media-body wd45">
                            {$lessonInfo.lesson}
                            <p class="mui-ellipsis">{$lessonInfo.gradecate}</p>
                        </div>
                        <div class="price-frame singup-num">
                            {$lessonInfo.students}人已报名
                        </div>
                    </a>
                </li>
            </ul>

            <ul class="mui-table-view">
                <li class="mui-table-view-cell listli">
                    <a class="mui-navigate-right">
                        所属训练营<span class="wd66" >{$lessonInfo.camp}</span>
                    </a>
                </li>
                <li class="mui-table-view-cell listli">课程单价<span><b class="colororange">￥{$lessonInfo.cost}</b>（元）</span></li>
                <li class="mui-table-view-cell listli">所选课量<span><b class="colororange total"></b>（节）</span></li>
                <li class="mui-table-view-cell listli">训练时间<span>{$lessonInfo.week} {$lessonInfo.lesson_time}</span></li>
                <li class="mui-table-view-cell listli">训练地点<span>{$lessonInfo.location}</span></li>
                <li class="mui-table-view-cell listli">所属地区<span>{$lessonInfo.province} {$lessonInfo.city} {$lessonInfo.area}</span></li>
                <li class="mui-table-view-cell listli"><span>课程总价<b class="colororange total_fee"></b></span></li>
            </ul>

            <div class="mui-input-group mb44">

                <div class="page-header mb mt">
                    <span class="title">学员信息</span>
                    <span class="fr"><span id="addBtn" class="mui-btn mui-btn-blue">添加学生</span></span>
                </div>
                <div id="oldStudent">
                    <div class="mui-input-row">
                        <a href="#" class="mui-navigate-right">
                            <label>学员姓名</label>
                            <span class="select-row">
                        <select class="selectStudent">
                        </select>
                    </span>
                        </a>
                    </div>
                    <div class="mui-input-row">
                        <label>家长姓名</label>
                        <span id="parent"></span>
                    </div>
                    <div class="mui-input-row">
                        <label>手机号码</label>
                        <span class="width" id="emergency_telephone"></span>
                    </div>

                </div>


                <div class="mui-input-row h-auto">
                    <label>备注</label>
                    <textarea rows="5" name="remarks" class="remarks" placeholder="购买留言"></textarea>
                </div>
            </div>

        </div>
            <ul class="mui-table-view operation">
                <li class="mui-table-view-cell mui-media mui-col-xs-6 opli" >还需支付:<b class="colororange total_fee">￥</b></li>
                <li class="mui-table-view-cell mui-media mui-col-xs-3 opli" onclick="helpPay()">请人代付</li>
                <li class="mui-table-view-cell mui-media mui-col-xs-3 opli bggreen" onclick="createBill()">立即支付</li>
            </ul>

</div>


<div id="addStudent" class="mui-popup mui-popup-in" style="display:none;">
    <div class="mui-popup-inner">
        <div class="mui-popup-text">请输入学员信息</div>
        <div class="mui-popup-input">
            <input type="hidden" name="__token__" class="data" value="{$Request.token}" />
            <input type="text" name="student" class="data" placeholder="学员姓名" autofocus="">
            <input type="text" name="parent" class="data" placeholder="家长姓名">
            <input type="text" name="emergency_telephone" class="data telephone" placeholder="联系电话" value="{$memberInfo.telephone}">
        </div>
    </div>
    <div class="mui-popup-buttons">
        <span class="mui-popup-button" id="submitBtn">确定</span><span class="mui-popup-button mui-popup-button-bold" id="cancelAdd">取消</span>
    </div>
</div>
<div class="mui-popup-backdrop" style="display: none;"></div>
</body>
<script src="/static/frontend/js/mui.min.js"></script>
<script src="/static/frontend/js/jquery-3.2.1.min.js"></script>
<script src="/static/frontend/js/wooApi.js?v={:time()}"></script>
<!-- <script src="/static/frontend/js/smsCode.js"></script> -->
<script>
    //初始化
    mui.init({
        swipeBack: true //启用右滑关闭功能
    });

    var isStudent = false;
    var total=wooApi.GetQueryString('total');
    var total_fee = "{$lessonInfo.cost}"*total;
    var strBillInfo = '{$jsonBillInfo}';
    var objBillInfo = JSON.parse(strBillInfo);

    $(function(){

        $('.total').text(total);
        $('.total_fee').text("￥"+total_fee);


        // 添加学生
        $('#addBtn').on('click','',function(){
//            $('#oldStudent').hide();
            $('#addStudent').show();
            $('.mui-popup-backdrop').addClass("mui-active");
            $('.mui-popup-backdrop').show();
        })
        // 取消添加
        $('#cancelAdd').on('click','',function(){
            $('#addStudent').hide();
            $('.mui-popup-backdrop').removeClass("mui-active");
            $('.mui-popup-backdrop').hide();
        })

        //替换学生列表
        $('.selectStudent').on('change',function(){
            $('#parent').text($(this).find("option:selected").attr("data-parent"));
            $('#emergency_telephone').text($(this).find("option:selected").attr("data-telephone"));
        })


        // 获取学生数据
       getStudentList();


        // 提交学生数据
        $('#submitBtn').on('tap','','',function(){
            var telephone = $('.telephone').val();
            var codeRegTelephone = /^((0\d{2,3}-\d{7,8})|(1[3584]\d{9}))$/;
            if (!codeRegTelephone.test(telephone)) {
                mui.toast('请填写正确的手机号码');
                return false;
            }
            var getStudent = $('input[name="student"]').val();
            if(getStudent!='') {
                if(isExistOption(getStudent)){
                    mui.toast(getStudent+"已经存在，请 [ 取消添加 ] 返回选择！");
                    return false;
                }
                var arrData = wooApi.getInputData();
                var objData = wooApi.arrTOobj(arrData);
                var url = "{:url('api/student/createStudentApi')}";
                var ajaxResult = wooApi.asyncF(url,objData);
                // console.log(ajaxResult);

                if(ajaxResult.code == 200){
                    mui.toast(ajaxResult.msg);
                    location.reload()
                }else{
                    mui.toast(ajaxResult.msg);
                }
            }else{
                mui.toast('必须填写学生姓名，谢谢！');
            }
        })

    })

    //判断要新添加的学生是否存在
    function isExistOption(newName){
        var isExist = false;
        var optName ='';
        $(".selectStudent option").each(function () {
            optName = $(this).text();
            if(newName==optName){
                isExist = true;
                return false;
            }
        });
        return isExist;
    }

    // 获取学生数据
    function getStudentList(){
        // 获取学生列表
       var result = wooApi.asyncF("{:url('api/Student/getStudentListApi')}");

       if(result.code == 100){
           $('#oldStudent').hide();
       }else{
           var studentList = result.data;
           isStudent = true;
           // 循环输出其他的学生
           for (var i = 0; i < studentList.length; i++) {
               var strhtml = '<option value="'+studentList[i].id+'" data-parent="'+studentList[i].parent+'" data-telephone="'+studentList[i].emergency_telephone+'">'+studentList[i].student+'</option>';
               $('.selectStudent').append(strhtml)
           }
           $('#parent').text(studentList[0].parent);
           $('#emergency_telephone').text(studentList[0].emergency_telephone);
       }

    }   




    // 请他人代付
    function helpPay(){
        //条件1判断是否没数据
        if(!isStudent){
            mui.alert('请先 [ 添加学生 ] 信息，谢谢！');
            return false;
        }
        //创建订单
        var res =  createBill();
        if(res.code == 200){  
            window.location.href="{:url('frontend/bill/billInfo',['bill_order'=>$billOrder])}";
        }else{
            mui.alert('订单创建失败,请刷新页面或者重新登录','提示','确定',function(){
                location.reload();
            })
        }
    }




    //创建订单
    function createBill(){
        var remarks = $('.remarks').val();
        var student = $('.selectStudent').find("option:selected").text();
        var student_id = $('.selectStudent').val();
        objBillInfo.bill_order = "{$billOrder}";
        objBillInfo.goods_des = student+'购买'+objBillInfo.goods;
        objBillInfo.total = total;
        objBillInfo.student_id = student_id;
        objBillInfo.student = student;
        objBillInfo.remarks = remarks;
        objBillInfo.balance_pay = 0;
        var result = wooApi.asyncF("{:url('api/Bill/updateBillApi')}",objBillInfo);
        if (result.code == 200){
            pay('测试');
        };
    }

    function pay(callback_str){
        var result = wooApi.asyncF("{:url('api/Bill/payApi',['bill_order'=>$billOrder])}",{
            'balance_pay' : total_fee,
            'callback_str':callback_str
        });

        if(result.code == 200){
            mui.alert('欢迎加入本训练营，您的课程购买已完成，请留意课程消息及公告。','购买成功','确定',function(){
                window.location.href="{:url('frontend/bill/billInfo',['bill_order'=>$billOrder])}";
              });
          }else{
            mui.toast(result.msg);
          }
    }

</script>
</html>