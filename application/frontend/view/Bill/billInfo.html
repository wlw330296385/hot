<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>{$billInfo.is_pay}订单</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!--标准mui.css-->
    <link rel="stylesheet" href="/static/frontend/css/mui.min.css">
    <!--自定义style.css-->
    <link rel="stylesheet" type="text/css" href="/static/frontend/css/style.css"/>
    <style>
        label{
            padding: 13px 15px !important;
        }
    </style>
</head>

<body class="whitebg">

    <!-- <header id="header" class="mui-bar mui-bar-nav subheader"> -->
    <!-- <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left arrow"><span class="return"></span></a> -->
    <input type="hidden" name="bill_id" value="{$billInfo.id}">
    <input type="hidden" name="camp" value="{$billInfo.camp}">
    <input type="hidden" name="camp_id" value="{$billInfo.camp_id}">
    <input type="hidden" name="student" value="{$billInfo.student}">
    <input type="hidden" name="student_id" value="{$billInfo.student_id}">
    <input type="hidden" name="member" value="{$billInfo.member}">
    <input type="hidden" name="member_id" value="{$billInfo.member_id}">
    <input type="hidden" name="score_pay" value="{$billInfo.score_pay}">
    <input type="hidden" name="balance_pay" value="{$billInfo.balance_pay}">
    <!-- </header> -->


    <header id="header" class="mui-bar mui-bar-nav subheader">
        <a class=" mui-icon mui-icon-left-nav mui-pull-left arrow" href="{:url('bill/billList')}?member_id={$memberInfo['id']}"><span class="return">我的订单</span></a>
        <h1 class="mui-title" style="font-size: 14px">
            {$billInfo.is_pay}订单
        </h1>
    </header>


    <div class="mui-content mt55">

            <div class="page-header">
                <span class="course"><strong>订单信息</strong></span>
            </div>
            <ul class="mui-table-view list detalis-list mb">
                <li class="mui-table-view-cell listli">订单号<span class="bill_order">{$billInfo.bill_order}</span></li>
                <li class="mui-table-view-cell listli">订单日期<span>{$billInfo.create_time}</span></li>
                <li class="mui-table-view-cell listli">订单金额<span>{$billInfo.price*$billInfo.total}</span></li>
                <li class="mui-table-view-cell listli">支付人<span>{$billInfo.member}</span></li>
                <li class="mui-table-view-cell listli">已付金额<span>{$billInfo.balance_pay}</span></li>
                <li class="mui-table-view-cell listli">支付方式<span>{$billInfo.pay_type}</span></li>
            </ul>

            <div class="page-header">
                <span class="course"><strong>商品信息</strong></span>
            </div>
            <ul class="mui-table-view list detalis-list mb">
               <li class="mui-table-view-cell listli">商品类型<span class="goods_type">{$billInfo.goods_type}</span></li>
               <li class="mui-table-view-cell listli">商品名称<span class="goods">{$billInfo.camp} {$billInfo.goods}</span><input type="hidden" name="goods_id" value="{$billInfo.goods_id}"></li>
               <li class="mui-table-view-cell listli">商品数量<span class="total">{$billInfo.total}</span></li>
               <li class="mui-table-view-cell listli">商品单价<span class="price">{$billInfo.price}</span></li>
               <li class="mui-table-view-cell listli border-b">商品描述<span class="goods_des">{$billInfo.goods_des}</span></li>
           </ul>
           {if isset($refundList[0])}
            <!--判断是否有此订单的退款信息再列车这段-->
            
            <div class="page-header">
                <span class="course"><strong>退款操作</strong></span>
            </div>

            <ul class="mui-table-view list detalis-list mb mt55">
                {volist name="refundList"  id="vol"}
                <li class="mui-table-view-cell listli">
                    <span class="wd58">
                        {$vol.create_time}
                        <br />
                        {$vol.update_time}
                        <br />
                    </span>
                    申请退款时间
                    <br />退款{$vol.status}
                    <br />实际退款金额￥:{$vol.refund}
                </li>
                {/volist}
            </ul>
            
          {/if}

        <ul class="mui-table-view operation">
            <li class="mui-table-view-cell mui-media mui-col-xs-2 opli"><a href="/frontend/"><span class="mui-icon icon iconfont icon-nav-Home"></span></a></li>
            <li class="mui-table-view-cell mui-media mui-col-xs-4 opli"><a href="tel:{$goodsInfo.telephone}">电话咨询</a></li>
            {switch name="billInfo.status"}
            {case  value="0"}
            <li class="mui-table-view-cell mui-media mui-col-xs-6 opli bggreen" id="wxpay" >立即支付</li>
            {/case}
            {case  value="1"}
            <li class="mui-table-view-cell mui-media mui-col-xs-6 opli"><a href="#delete">申请退款</a></li>
            {/case}
            {case  value="-1"}
            <li class="mui-table-view-cell mui-media mui-col-xs-3 opli">退款中</li>
            <li class="mui-table-view-cell mui-media mui-col-xs-3 opli cancel bgred"  disabled="true">撤销退款</li>
            {/case}
            {case  value="-2"}
            <li class="mui-table-view-cell mui-media mui-col-xs-6 opli bggray">已同意</li>
            {/case}
            {case  value="-3"}
            <li class="mui-table-view-cell mui-media mui-col-xs-6 opli bggray">已退款</li>
            {/case}
            {/switch}
        </ul>

</div>

    <div id="delete" class="mui-popover mui-popover-action mui-popover-bottom actionsheet" style="margin-bottom: 0">
        <div class="list camp-list camp-lesson-list detalis-list grade-list coach">
            <ul class="mui-table-view mui-text-left operation">
                <h5 class="mui-text-left">退款申请<a class="mui-icon mui-icon-closeempty" href="#delete"></a></h5>
                <div class="mui-input-row" style="font-size: 14px;color: #737373">

                </div>
                <li class="mui-table-view-cell">
                    <textarea id="question" class="mui-input-clear question" placeholder="请在此处填写申请退款的原因..." value=""></textarea>
                </li>
                <li class="mui-table-view-cell mui-media mui-col-xs-12 opli tjBtn" style="background:#59b200"  disabled="true"><a href="#" >提交申请</a>
                </li>
            </ul>
        </div>
    </div>

<script src="/static/frontend/js/mui.min.js"></script>
<script src="/static/frontend/js/jquery-3.2.1.min.js"></script>
<script src="/static/frontend/js/wooApi.js?v={:time()}"></script>
<script src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
<script>
    //初始化
    mui.init({
        swipeBack: true //启用右滑关闭功能
    });

$(function(){
    
    // 申请退款
    $(".tjBtn").click(function(){

        mui.confirm('您确认要【申请退款】吗?', '', ['取消', '确认'], function (e) {
            if (e.index == 1) {
                var remarks = $(".question").val();
                if(remarks==''){
                    mui.toast("请填写退款理由");
                    return false;
                }
                let data = {
                        "remarks":remarks,
                    };

                mui.ajax("{:url('api/bill/refundBillApi',['bill_id'=>$billInfo['id']])}",{
                    data:data,
                    dataType:'json',//服务器返回json格式数据
                    type:'post',//HTTP请求类型
                    timeout:10000,//超时时间设置为10秒；
                    headers:{'Content-Type':'application/json'},
                    success:function(result){
                        //服务器返回响应，根据响应结果，分析是否登录成功；
                        if(result.code == 200){
                            mui.alert('',result.msg,'确定',function(){
                                location.reload();
                            });
                        }else{
                            mui.alert('',result.msg,'确定',function(){
                            });
                        }
                    },
                    error:function(xhr,type,errorThrown){
                        //异常处理；
                        console.log(type);
                    }
                });
            }
        })

    })

    // 撤销退款
    $(".cancel").click(function(){

        mui.confirm('您确认【撤销退款申请】吗?', '', ['取消', '确认'], function (e) {
            if (e.index == 1) {
                mui.ajax("{:url('api/bill/cancelBillApi',['bill_id'=>$billInfo['id']])}",{
                    data:{},
                    dataType:'json',//服务器返回json格式数据
                    type:'post',//HTTP请求类型
                    timeout:10000,//超时时间设置为10秒；
                    headers:{'Content-Type':'application/json'},
                    success:function(result){
                        //服务器返回响应，根据响应结果，分析是否登录成功；
                        if(result.code == 200){
                            mui.alert('',result.msg,'确定',function(){
                                location.reload();
                            });
                        }else{
                            mui.alert('',result.msg,'确定',function(){
                            });
                        }
                    },
                    error:function(xhr,type,errorThrown){
                        //异常处理；
                        console.log(type);
                    }
                });
            }
        })

    })

    // 立即支付
    $('#wxpay').on('click',function(){
        {if $jsApiParameters === 0}
            alert('订单已支付,不可再支付'); 

        {else /}
            var strJsApiParameters = '{$jsApiParameters}';
            var objJsApiParameters = JSON.parse(strJsApiParameters);
            wx.chooseWXPay({
                timestamp: {$jsApi['timestamp']},
                // timestamp:objJsApiParameters.timeStamp,
                nonceStr: objJsApiParameters.nonceStr,
                package: objJsApiParameters.package,
                signType: 'MD5',
                paySign: objJsApiParameters.paySign,
                success: function (res) {
                    // 支付成功后的回调函数
                    pay(JSON.stringify(res));
                },
                cancel: function() {
                    //mui.toast('取消了支付付款');
                    mui.alert('取消了支付付款');
                },
                fail: function(res) {
                    var errmsg = res.errMsg;
                    // mui.toast(errmsg.slice(12));
                    mui.alert('网络延迟,请刷新页面');
                }
            });
        {/if}
    })




    //支付完成
    function pay(callback_str){

        $.ajax({
            url: "{:url('api/Bill/payApi',['bill_order'=>$billInfo['bill_order']])}",
            data: {
                "balance_pay" : "{$billInfo['total']*$billInfo['price']}",
                "callback_str":callback_str,
                "agent_id":"{$memberInfo.id}",
                "agent":"{$memberInfo.member}",
                "system_remarks":"订单页支付",
            },
            async: false,
            type: 'post',
            dataType:'json',
            complete: function(msg) {
                console.log(msg)
            },
            success:function(msg){
                if(msg.code == 200){
                    mui.alert('支付成功','提示','确定',function(){
                        location.reload();
                      });
                }else{
                    mui.toast(result.msg);
                }
            },
            error:function(msg){
                alert(JSON.stringify(msg));
            }
        });
    }
})
</script>
<script type="text/javascript">
    wx.config({
            //开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
            debug:false,
            appId: "{$jsApi.appId}", // 必填，企业号的唯一标识，此处填写企业号corpid
            timestamp: "{$jsApi.timestamp}", // 必填，生成签名的时间戳
            nonceStr: "{$jsApi.nonceStr}", // 必填，生成签名的随机串
            signature: "{$jsApi.signature}",// 必填，签名，见附录1
            jsApiList:  [
                // 所有要调用的 API 都要加到这个列表中
                'checkJsApi',
                'onMenuShareTimeline',
                'onMenuShareAppMessage',
                'onMenuShareQQ',
                'hideMenuItems',
                'chooseWXPay'
            ]// 必填，需要使用的JS接口列表，所有JS接口列表见附录2
        });


    wx.ready(function () {   
        // 微信支付分享朋友圈页面
        wx.onMenuShareTimeline({
            title: '代付订单', // 分享标题
            link: "{:url('frontend/bill/billinfo',['bill_order'=>$billInfo['bill_order']],'',true)}", // 分享链接，该链接域名必须与当前企业的可信域名一致
            imgUrl: "{$memberInfo['avatar']}", // 分享图标
            success: function () {
                // 用户确认分享后执行的回调函数
            },
            cancel: function () {
                // 用户取消分享后执行的回调函数
            }
        });
        // 分享给朋友
        wx.onMenuShareAppMessage({
            title: '代付订单', // 分享标题
            link: "{:url('frontend/bill/billinfo',['bill_order'=>$billInfo['bill_order']],'',true)}", // 分享链接，该链接域名必须与当前企业的可信域名一致
            imgUrl: "{$memberInfo['avatar']}", // 分享图标
            desc:"{$billInfo['member']}买了{$billInfo['goods']},帮我支付吧!",
            type: '', // 分享类型,music、video或link，不填默认为link
            dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
            success: function () {
                // 用户确认分享后执行的回调函数
            },
            cancel: function () {
                // 用户取消分享后执行的回调函数
            }
        });
        {if condition="$billInfo['status']!=0"}
            wx.hideMenuItems({
            menuList: [ 
            "menuItem:share:appMessage",
            "menuItem:share:timeline",
            "menuItem:share:qq",
            "menuItem:share:weiboApp",
            "menuItem:share:facebook",
            "menuItem:favorite",
            "menuItem:copyUrl",
            "menuItem:originPage",
            "menuItem:readMode",
            "menuItem:openWithQQBrowser",
            "menuItem:openWithSafari",
            ] // 要隐藏的菜单项，只能隐藏“传播类”和“保护类”按钮，所有menu项见附录3

        });
        {/if}

    })
</script>
</body>
</html>