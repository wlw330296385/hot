<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>场地编辑</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!--标准mui.css-->
    <link rel="stylesheet" href="/static/frontend/css/mui.min.css">
    <!--自定义style.css-->
    <link rel="stylesheet" type="text/css" href="/static/frontend/css/style.css" />
    <!--选择器样式-->
    <link href="/static/frontend/css/mui.picker.min.css" rel="stylesheet" />
    <link href="/static/frontend/css/mui.poppicker.css" rel="stylesheet" />
    <link rel="stylesheet" href="/static/frontend/css/webuploader.css">
    <style type="text/css">
        .outdoors {
            vertical-align: middle;
            margin-left: 8px;
        }

        .previewList {
            overflow: hidden;
            padding: 0 10px;
        }

        .previewList li {
            float: left;
            width: 17%;
            position: relative;
            display: flex;
            margin-right: 8px;
        }

        .previewList i {
            position: absolute;
            top: 0;
            right: 0;
            color: #f00;
        }

        .previewList img {
            width: 55px;
            height: 55px;
            margin-right: 0
        }

        #container {
            width: 100%;
            height: 250px;
            margin-top: 30px;
        }

        #mapFrame {
            height: 250px;
            padding-bottom: 0px;
        }

        #map {
            background-color: #EEE;
        }

        #map input[type=button] {
            position: absolute;
            top: 0px;
            right: 0px;
            width: 20%;
            height: 40px !important;
            text-align: center;
            color: #FFF;
        }

        #map .mui-icon-location {
            width: 10%;
            position: absolute;
            top: 0px;
            left: 0px;
            height: 40px !important;
            line-height: 35px;
            background-color: #EEE;
            font-size: 20px;
            padding-right: 0px !important;
            text-align: center;
        }

        #tip {
            color: #333;
            position: absolute;
            top: 0px;
            left: 10%;
            overflow: hidden;
            width: 90%;
        }

        #tip input[type="text"] {
            background-color: #EEE;
            border: 0;
            padding-left: 0px;
            width: 100%;
            height: 40px !important;
            outline: none;
            text-align: left;
        }

        span.getFromMap {
            width: 60%;
            line-height: 18px !important;
        }

        .albumImg {
            position: relative;
        }

        .albumImg .delbtn {
            font-size: 16px;
            right: 12px;
            position: absolute;
            top: 2px;
            color: #fff;
        }

        .albumImg img {
            float: left;
            margin-right: 10px;
            margin-bottom: 5px
        }
    </style>
</head>

<body>
    <header id="header" class="mui-bar mui-bar-nav subheader">
        <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left arrow"></a>
        <h1 class="mui-title">训练营场地编辑</h1>
    </header>

    <div class="mui-content pt">
        <div class="register">
            <form action="" class="mui-input-group">

                <!-- map -->
                <div class="mui-input-row h-auto" id="mapFrame">
                    <div id="map">
                        <div>{:token()}</div>
                        <div id="container"></div>
                        <span class="mui-icon mui-icon-location"></span>
                        <div id="tip">
                            <input type="text" id="keyword" name="keyword" value="" onfocus='this.value=""' placeholder="请输入地址后从下拉菜单中选择（或直接点击地图）" />
                        </div>
                        <!--<input type="button" class="bgblue" id="mapConfirm" value="确认" />-->
                    </div>
                </div>
                <div class="mui-input-row h-auto">
                    <label>场地定位</label>
                    <span class="getFromMap">{$CourtInfo.location}</span>
                    <input type="hidden" name="location" value="{$CourtInfo.location}" class="location getFromMap">
                </div>

                <div class="mui-input-row">
                    <label>场地名称</label>
                    <input type="text" class="court" name="" value="{$CourtInfo.court}">
                    <input type="hidden" name="camp_id" value="{$CourtInfo.camp_id}">
                    <input type="hidden" name="camp" value="{$CourtInfo.camp}">
                </div>

                <div class="mui-input-row" id='showCityPicker3'>
                    <label>所属地区</label>
                    <span id="cityResult3" class="ui-alert" style="color: #000">{$CourtInfo.province} {$CourtInfo.city} {$CourtInfo.area}</span>
                </div>

                <!--  <div class="mui-input-row"><label>地图位置</label>
                    <input type="text" class="" name="">
                </div> -->

                <div class="mui-input-row">
                    <label>营业时间</label>
                    <input type="text" class="open_time" name="" value="{$CourtInfo.open_time}">
                </div>

                <div class="mui-input-row">
                    <label>联系电话</label>
                    <input type="text" class="contract" name="" value="{$CourtInfo.contract}">
                </div>

                <div class="mui-input-row">
                    <label>联系人</label>
                    <input type="text" class="principal" name="" value="{$CourtInfo.principal}">
                </div>

                <div class="mui-input-row">
                    <label>散场(一次)</label>
                    <input type="text" class="chip_rent" name="" value="{$CourtInfo.chip_rent}">
                </div>

                <div class="mui-input-row">
                    <label>包半场(每小时)</label>
                    <input type="text" class="half_rent" name="" value="{$CourtInfo.half_rent}">
                </div>

                <div class="mui-input-row">
                    <label>包全场(每小时)</label>
                    <input type="text" class="full_rent" name="" value="{$CourtInfo.full_rent}">
                </div>

                <div class="mui-input-row">
                    <label>场地类型</label>
                    <span>
                        <input type="radio" class="outdoors" name="outdoors" value="1" data-name="室内" /> 室内
                        <input type="radio" class="outdoors" name="outdoors" value="2" data-name="室外" /> 室外
                        <input type="radio" class="outdoors" name="outdoors" value="3" data-name="室内|室外" /> 室内|室外
                    </span>
                </div>

                <div class="mui-input-row h-auto ">
                    <label>温馨提示</label>
                    <textarea rows="5" class="remarks mui-text-left">{$CourtInfo.remarks}</textarea>
                </div>

                <ul class="mui-table-view mt55">
                    <li class="mui-table-view-cell listli detalisli f14" style="line-height: 40px; color: #737373;">
                        <span class="h-auto">场地环境</span>
                        <a class="mui-navigate-right fr wd60">
                            <div id="uploader-demo1" class="fr pdr15">
                                <div id="fileList" class="uploader-list"></div>
                                <div id="filePicker1">选择图片</div>
                            </div>
                        </a>
                    </li>
                    <li class="mui-table-view-cell listli albumBox">
                        {if !empty($CourtInfo['covers'])} {volist name="$CourtInfo['covers']" id="v"}
                        <div class="fl albumImg">
                            <i class="delbtn mui-icon mui-icon-close"></i>
                            <img src="{$v}">
                        </div>{/volist} {/if}
                    </li>
                </ul>

                <ul class="mui-table-view operation list">
                    <li class="mui-table-view-cell mui-media mui-col-xs-12 opli bggreen updateBtn" style="color: #fff">提交场地</li>
                </ul>

            </form>
        </div>
    </div>

    <script src="/static/frontend/js/mui.min.js"></script>
    <script src="/static/frontend/js/jquery-3.2.1.min.js"></script>
    <!-- 选择器 -->
    <script src="/static/frontend/js/mui.picker.min.js"></script>
    <script src="/static/frontend/js/mui.poppicker.js"></script>
    <script src="/static/frontend/js/city.data-3.js"></script>
    <script>
        var uploadApiUrl = "{:url('api/upload/imgwupload', ['usage' => 'court'])}";
    </script>
    <script src="/static/frontend/libs/webuploader.cert.js?v=<?php echo time();?>"></script>
    <!--获取地址-->
    <script src="https://webapi.amap.com/maps?v=1.4.0&key=7568bf7e7c18c65a1fecd44762bcbd83"></script>

    <script>
        var lng = '{$CourtInfo.lng}';
        var lat = '{$CourtInfo.lat}';
        // map(选择具体地址)
        {if $CourtInfo.lng == '' || $CourtInfo.lat == ''}
        var map = new AMap.Map('container', {
            resizeEnable: true,
            zoom: 13
        });
        {else}
        var map = new AMap.Map('container', {
            resizeEnable: true,
            zoom: 13,
            center:[lng,lat]
        });
        {/if}

        //点击获取地址
        AMap.plugin(['AMap.Geocoder', 'AMap.PlaceSearch', 'AMap.Autocomplete', 'AMap.Geolocation'], function () {
            var geocoder = new AMap.Geocoder({

            });
            var marker = new AMap.Marker({
                map: map,
                bubble: true
            })

            map.on('click', function (e) {
                marker.setPosition(e.lnglat);
                geocoder.getAddress(e.lnglat, function (status, result) {
                    if (status == 'complete') {
                        var glocation = result.regeocode.formattedAddress;
                        // alert(result.regeocode.formattedAddress)
                        if(window.confirm('你确定定位到【'+glocation+'】吗？')){
                            $(".getFromMap").val(glocation);
                            $(".getFromMap").text(glocation);
                            lng = e.lnglat.lng;
                            lat = e.lnglat.lat;
                        }else{
                            return false;
                        }
                    }
                })
            })

            var autoOptions = {
                city: "深圳市", //城市，默认全国
                input: "keyword"//使用联想输入的input的id
            };
            autocomplete = new AMap.Autocomplete(autoOptions);
            var placeSearch = new AMap.PlaceSearch({
                city: '',
                map: map
            })
            AMap.event.addListener(autocomplete, "select", function (e) {
                //TODO 针对选中的poi实现自己的功能
                placeSearch.setCity(e.poi.adcode);
                placeSearch.search(e.poi.name);
                console.log(e.poi)
                console.log(e.poi.location.lng)
                console.log(e.poi.location.lat)
                lng = e.poi.location.lng;
                lat = e.poi.location.lat;
                $(".getFromMap").val(e.poi.name);
                $(".getFromMap").text(e.poi.name);
            });
        });

    </script>
    <script>
        //初始化
        mui.init({
            swipeBack: true //启用右滑关闭功能
        });

        //选择器
        var getProvince = '{$CourtInfo.province}';
        var getCity = '{$CourtInfo.city}';
        var getArea = '{$CourtInfo.area}';
        (function ($, doc) {
            $.init();
            $.ready(function () {
                _getParam = function (obj, param) {
                    return obj[param] || '';
                };
                
                var cityPicker3 = new $.PopPicker({
                    layer: 3
                });

                // 设置默认值
                cityPicker3.pickers[0].setSelectedIndex(18);
                cityPicker3.pickers[1].setSelectedIndex(2);
                cityPicker3.pickers[2].setSelectedIndex(2);
                
                cityPicker3.setData(cityData3);
                var showCityPickerButton = doc.getElementById('showCityPicker3');
                var cityResult3 = doc.getElementById('cityResult3');
                showCityPickerButton.addEventListener('tap', function (event) {
                    cityPicker3.show(function (items) {
                        cityResult3.innerText = _getParam(items[0], 'text') + " " + _getParam(items[1], 'text') + " " + _getParam(items[2], 'text');
                        //返回 false 可以阻止选择框的关闭
                        //return false;
                        getProvince = _getParam(items[0], 'text');
                        getCity = _getParam(items[1], 'text');
                        getArea = _getParam(items[2], 'text');
                    });
                }, false);
            });
        })(mui, document);

        var covers = [];
        $(function () {

            //多图上传start·····································································
            // 初始化Web Uploader
            var uploader = WebUploader.create({
                auto: true,
                server: uploadApiUrl,
                pick: '#filePicker1',
                accept: {
                    title: 'Images',
                    extensions: 'gif,jpg,jpeg,bmp,png',
                    mimeTypes: 'image/*'
                }
            });
            // 上传成功
            uploader.on('uploadSuccess', function (file, responce) {
                if (eval('responce').status == 0) {
                    mui.toast('上传失败,请重试', { 'duration': 'long' });
                } else {
                    mui.toast('上传成功', { 'duration': 'long' });
                    var $li = '<div class="fl albumImg"><i class="delbtn mui-icon mui-icon-close"></i><img src="' + responce.path + '"></div>';
                    $(".albumBox").append($li);
                }
            });

            //删除操作
            $(document).on('tap', '.delbtn', function () {
                $(this).parent().remove();
            });
            //多图上传end·····································································


            $("input[name='outdoors']").filter(function (index) {
                return $(this).attr("data-name") == "{$CourtInfo.outdoors}"
            }).prop("checked", true);


            // map(选择具体地址)
//            $("#mapConfirm").on('tap', '', function () {
//                var mapkeyword = $("input[name='keyword']").val();
//                $(".getFromMap").val(mapkeyword);
//                $(".getFromMap").text(mapkeyword);
//            });

            //场地编辑
            $(".updateBtn").click(function () {
                var covers = [];
                $(".albumImg img").each(function () {
                    var src = $(this).attr('src')
                    covers.push(src);
                }).get().join(",");
                // 上面获取图片地址
                var court = $(".court").val();
                var court_id = "{$CourtInfo.id}";
                var province = getProvince;
                var city = getCity;
                var area = getArea;
                var location = $(".location").val();
                var open_time = $(".open_time").val();
                var contract = $(".contract").val();
                var principal = $(".principal").val();
                var outdoors = $("input:radio:checked").val();
                var chip_rent = $(".chip_rent").val();
                var half_rent = $(".half_rent").val();
                var full_rent = $(".full_rent").val();
                var remarks = $(".remarks").val();

                if (court != '' && location != '' && open_time != '' && contract != '' && principal != '' && chip_rent != '' && half_rent != '' && full_rent != '' && outdoors != '') {
                    mui.ajax("{:url('api/court/updateCourtApi',['court_id'=>$CourtInfo['id'],'camp_id'=>$CourtInfo['camp_id']])}", {
                        data: {
                            "court": court,
                            "court_id": court_id,
                            "province": getProvince,
                            "city": getCity,
                            "area": getArea,
                            "location": location,
                            "open_time": open_time,
                            "contract": contract,
                            "principal": principal,
                            "chip_rent": chip_rent,
                            "half_rent": half_rent,
                            "full_rent": full_rent,
                            "outdoors": outdoors,
                            "remarks": remarks,
                            "covers": covers,
                            "lng": lng,
                            "lat": lat,
                        },
                        dataType: 'json',//服务器返回json格式数据
                        type: 'post',//HTTP请求类型
                        timeout: 10000,//超时时间设置为10秒；
                        headers: { 'Content-Type': 'application/json' },
                        success: function (data) {
                            //服务器返回响应，根据响应结果，分析是否登录成功；
                            console.log(data)
                            if (data.code == 200) {
                                mui.alert('场地修改成功。', function () {
                                    window.location.href = "{:url('camp/courtlistofcamp',['camp_id'=>$CourtInfo.camp_id])}";
                                });
                            } else {
                                mui.toast(data.msg)
                            }
                        },
                        error: function (xhr, type, errorThrown) {
                            //异常处理；
                            console.log(type);
                        }
                    });
                } else {
                    mui.toast("选项不能为空");
                }
            })
        })
    </script>
</body>

</html>