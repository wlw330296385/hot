<!DOCTYPE html>
<html>
<head>
	<title>我的卡券</title>
	<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!--标准mui.css-->
    <link rel="stylesheet" href="/static/frontend/css/mui.min.css">
    <!--自定义style.css-->
    <link rel="stylesheet" type="text/css" href="/static/frontend/css/style.css"/>
	<link rel="stylesheet" type="text/css" href="/static/frontend/css/coupon.css" />
</head>
<body>


	<header id="header" class="mui-bar mui-bar-nav for-tab">
		<div class="camp-lesson-list">
			<div class="mui-segmented-control mb">
				<a class="mui-control-item mui-icon mui-icon-left-nav" href="{:url('member/index')}"></a>
				<a class="mui-control-item mui-active" href="#changeList">礼品券</a>
			</div>
		</div>
	</header>

	<div class="mui-content">

		<div class="tab-pullRefresh">
			<div id="itemCouponList" class="mui-scroll-wrapper mui-control-content mui-active">
				<div class="mui-scroll" style="padding-top:15px;">
						{volist name="itemCouponList" id="vol"}
						<div class="coupon">
							<div class="orangebg">
								<div class="cNum">{$vol.itemCoupon.price}<span>元</span></div>
								<div class="cFrom">{$vol.itemCoupon.organization}</div>
								<div class="cID">ID:{$vol.coupon_number}</div>
								<div class="cName">{$vol.item_coupon}</div>
								<div class="cDate">{$vol.itemCoupon.start} 至 {$vol.itemCoupon.end}</div>
								<i></i>
							</div>
							<div class="tips">
								<a href="{:url('frontend/Coupon/itemCouponInfo',['item_coupon_id'=>$vol['itemCoupon']['id']])}">查看卡券详情<span class="mui-icon mui-icon-forward"></span></a>

									{if strtotime($vol.itemCoupon.start) > time() || strtotime($vol.itemCoupon.end) < time()}
									<button type="button" class="mui-btn"  disabled="true"  >已失效 </button>
									{elseif $vol.status == 1}
									<button type="button" class="mui-btn bggreen useCard" data-itemCouponID="{$vol.itemCoupon.id}"   data-itemCouponMemberID = "{$vol.id}"   >立即使用  </button>
									{else /}
									<button type="button" class="mui-btn"  disabled="true"  >已使用 </button>
									{/if}
							</div>
						</div>
						{/volist}
				</div>
			</div>
		</div>

	</div>

</body>
</html>
<script src="/static/frontend/js/mui.min.js"></script>
<script src="/static/frontend/js/jquery-3.2.1.min.js"></script>
<script src="/static/frontend/js/wooApi.js?v={:time()}"></script>

<script type="text/javascript">
	//初始化
    mui.init({
        swipeBack: true //启用右滑关闭功能
    });

    mui("body").on("tap", "a", function () {
        window.top.location.href = this.href;
    });

    $(function(){

    	$('.useCard').on('tap',function(){
    		var itemCouponID = $(this).attr("data-itemCouponID");
    		var itemCouponMemberID = $(this).attr("data-itemCouponMemberID");
    		var r = confirm('使用后不可在使用,确定使用吗?')
    		if(r===true){
	    		var objData = {
	    			item_coupon_id:itemCouponID,
	    			item_coupon_member_id : itemCouponMemberID
	    		}
	    		var ajaxResult = wooApi.asyncF("{:url('api/item_coupon/useItemCoupon')}", objData);
	    		if(ajaxResult.code == 200){
	    			$(this).attr("disabled", true);
	    			$(this).text('已使用');
	    			
	    		}
	    		mui.toast(ajaxResult.msg);    			
    		}
    	})

        //初始化全局变量
        var onItemCount = 1;

        mui('#itemCouponList').pullRefresh({
            down: {
                //下拉刷新
                height: 50,//可选.默认50.触发下拉刷新拖动距离
                auto: true,//可选,默认false.自动下拉刷新一次
                contentdown: "下拉可以刷新",//可选，在下拉可刷新状态时，下拉刷新控件上显示的标题内容
                contentover: "释放立即刷新",//可选，在释放可刷新状态时，下拉刷新控件上显示的标题内容
                contentrefresh: "正在刷新...",//可选，正在刷新状态时，下拉刷新控件上显示的标题内容
                callback: pulldownRefreshOn
            },
            up: {
                //上拉加载
                height: 150,//可选.默认50.触发上拉加载拖动距离
                //auto:true,//可选,默认false.自动上拉加载一次
                contentrefresh: '正在加载...',
                contentnomore: '没有更多数据了',//可选，请求完毕若没有更多数据时显示的提醒内容；
                callback: pullupRefreshOn
            }
        });

        //下拉刷新具体业务实现（上架）
        function pulldownRefreshOn() {
            setTimeout(function () {
                onItemCount = 1;//刷新并显示第一页
                var page = onItemCount;
                var gType = 1;//代表下拉刷新
                toItemCouponList('itemCouponList', page, gType, 1);//具体取数据的方法
            }, 100);
        }

        //上拉加载具体业务实现（上架）
        function pullupRefreshOn() {
            setTimeout(function () {
                onItemCount++;//翻下一页
                var page = onItemCount;
                var gType = 2;//代表上拉加载
                toItemCouponList('itemCouponList', page, gType, 1);//具体取数据的方法
            }, 100);
        }


    })

    //接口获取数据并追加到页面
    var toItemCouponList = function (wList, page, gType, status) {
        //搜索关键字不能完全为空，否则查询为空
        var url = "{:url('api/lesson/getLessonListByPageApi','','',true)}" + '/?page=' + page;
        var campID = "{$camp_id}";
        mui.ajax({
            url: url,
            data: {
                camp_id: campID,
                status: status
            },
            dataType: 'json',//服务器返回json格式数据
            type: 'post',//HTTP请求类型
            timeout: 10000,//超时时间设置为10秒；
            headers: {'Content-Type': 'application/json'},
            //processData:false,
            success: function (data) {

                var newli = '';
                if (data.code == 200) {
                    for (var i = 0; i <= data.data.data.length - 1; i++) {
                        var urls = "{:url('lesson/LessonInfoOfCamp')}" + '/lesson_id/' + data.data.data[i].id + '/camp_id/' + campID;
                        newli += '<li class="mui-table-view-cell mui-media listli">';
                        if (status == 1) {
//                            newli += '<div class="mui-slider-right mui-disabled" data-id="' + data.data.data[i].id + '"><span class="mui-btn mui-btn-grey" data-action="editstatus">设为下架</span><span class="mui-btn mui-btn-red" data-action="setprivate">设为私密课程</span></div>';
                            newli += '<div class="mui-slider-right mui-disabled" data-id="' + data.data.data[i].id + '"><span class="mui-btn mui-btn-grey" data-action="editstatus">设为下架</span><span class="mui-btn mui-btn-red" data-action="setprivate">';
                            if (data.data.data[i].isprivate ===1 ) {
                                newli += '撤销私密课程';
                            } else {
                                newli += '设为私密课程';
                            }
                            newli += '</span></div>';
                        } else {
                            newli += '<div class="mui-slider-right mui-disabled" data-id="' + data.data.data[i].id + '"><span class="mui-btn mui-btn-grey" data-action="editstatus">设为上架</span><span class="mui-btn mui-btn-red" data-action="del">删除</span></div>';
                        }

//                        newli += '<div class="mui-slider-handle"><a href="' + urls + '"><img class="mui-media-object mui-pull-left" src="' + data.data.data[i].cover + '"><div class="mui-media-body wd60">' + data.data.data[i].lesson + '<p class="mui-ellipsis">' + data.data.data[i].gradecate + '</p></div><div class="price-frame"><p class="price">￥' + data.data.data[i].cost + '</p><p class="address">' + data.data.data[i].area + '</p></div></a></div>';
                        newli += '<div class="mui-slider-handle"><a href="' + urls + '"><img class="mui-media-object mui-pull-left" src="' + data.data.data[i].cover + '"><div class="mui-media-body wd60">' + data.data.data[i].lesson;
                        if (data.data.data[i].isprivate ===1) {
                            newli += '<font style="color:red">&nbsp;&nbsp;[私密]</font>';
                        }
                        newli += '<p class="mui-ellipsis">' + data.data.data[i].gradecate_setion + data.data.data[i].gradecate + '</p></div><div class="price-frame"><p class="price">￥<strong>' + data.data.data[i].cost + '</strong></p><p class="address">' + data.data.data[i].area + '</p></div></a></div>';

                        newli += '</li>';
                    }
                }
                if (gType == 1) {
                    //上拉刷新
                    $("ul.lesson" + status).empty().append(newli);
                    mui('#' + wList).pullRefresh().endPulldownToRefresh();
                    mui('#' + wList).pullRefresh().refresh(true);
                    if (newli == '') {
                        $("ul.lesson" + status).append('<li class="nodata"><p>没有相关数据哦</p></li>');
                    }
                } else {
                    //下拉加载 gType==2
                    $("ul.lesson" + status).append(newli);
                }

                if (newli != '') {
                    mui('#' + wList).pullRefresh().endPullupToRefresh(false);
                } else {
                    mui('#' + wList).pullRefresh().endPullupToRefresh(true);
                }

            },
            error: function (xhr, type, errerThrown) {
                mui.toast('网络异常,请稍候再试');
                mui('#' + wList).pullRefresh().endPullupToRefresh(true);
            }
        });
    };

</script>