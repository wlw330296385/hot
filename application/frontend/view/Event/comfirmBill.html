<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>活动订单支付</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!--标准mui.css-->
    <link rel="stylesheet" href="/static/frontend/css/mui.min.css">
    <!--自定义style.css-->
    <link rel="stylesheet" type="text/css" href="/static/frontend/css/style.css" />
    <style>
        .show {
            display: block;
        }
        
        .hide {
            display: none;
        }
    </style>
</head>

<body class=whitebg>

    <header id="header" class="mui-bar mui-bar-nav subheader">
        <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left arrow"></a>
        <h1 class="mui-title">确认订单</h1>
    </header>
    <div class="mui-content">

        <div class="list">
            <ul class="mui-table-view">
                <li class="mui-table-view-cell mui-media listli mb">
                    <a href="javascript:;">
                        <img class="mui-media-object mui-pull-left" src="{$eventInfo.cover}">
                        <div class="mui-media-body wd45 domData" name="event">{$eventInfo.event}
                            <p class="mui-ellipsis domData" name="event_type">{$eventInfo.event_type}</p>
                        </div>
                        <div class="price-frame">
                            <p class="price"><span class="nofloat">已报名{$eventInfo.participator}人</span></p>
                            <input type="hidden" name="participator" value="{$eventInfo.participator}" class="data">
                            <p class="price"><span class="nofloat">剩余<font class="surplus"></font>名额</span></p>
                        </div>
                    </a>
                </li>
            </ul>
            <div class="page-header">
                <span class="course">活动信息</span>
            </div>

            <ul class="mui-table-view">
                <input type="hidden" name="__token__" class="data" value="{$Request.token}" />
                <input type="hidden" name="target_type" value="{$eventInfo.target_type}" class="target_type data">
                <input type="hidden" name="organization_id" value="{$eventInfo.organization_id}" class="data">
                <input type="hidden" name="target_id" value="{$eventInfo.target_id}" class="data">
                <input type="hidden" name="price" value="{$eventInfo.price}" class="data">
                <li class="mui-table-view-cell listli {eq name='eventInfo.organization' value='2||3'}show{else/}hide{/eq}">所属训练营<span class="domData" name="organization">{$eventInfo.organization}</span></li>
                <li class="mui-table-view-cell listli {eq name='eventInfo.organization' value='3'}show{else/}hide{/eq}">所属班级<span class="domData" name="target">{$eventInfo.target}</span></li>
                <li class="mui-table-view-cell listli">活动单价<span><b class="colororange">￥{$eventInfo.price}</b>（元）</span></li>
                <li class="mui-table-view-cell listli">活动开始时间<span class="domData" name="starts">{$eventInfo.starts}</span></li>
                <li class="mui-table-view-cell listli">活动结束时间<span class="domData" name="ends">{$eventInfo.ends}</span></li>
                <li class="mui-table-view-cell listli">活动地点<span class="domData" name="location">{$eventInfo.location}</span></li>
                <li class="mui-table-view-cell listli">所属地区<span class="domData" name="address">{$eventInfo.province} {$eventInfo.city} {$eventInfo.area}</span></li>
                <li class="mui-table-view-cell listli">联系人<span class="domData" name="contract">{$eventInfo.member}</span></li>
                <li class="mui-table-view-cell listli">联系电话<span class="domData" name="telephone">{$eventInfo.telephone}</span></li>
            </ul>

            <div class="page-header">
                <span class="course">报名信息</span>
            </div>

            <div class="mui-input-group mb44">

                <div id="oldStudent">
                    <input type="hidden" name="__token__" class="data" value="{$Request.token}" />
                    <div class="mui-input-row">
                        <label>报名人数</label>
                        <input type="text" name="participator" value="" class="participator data" placeholder="请输入报名人数">
                    </div>
                    <div class="mui-input-row">
                        <label>联系人</label>
                        <input type="text" name="contract" class="data" value="">
                    </div>
                    <div class="mui-input-row">
                        <label>联系电话</label>
                        <input type="text" name="telephone" class="data" value="">
                    </div>
                    <div class="mui-input-row">
                        <label>备注</label>
                        <textarea name="remarks" class="data" value="" placeholder="备注信息填写"></textarea>
                    </div>
                </div>

            </div>
            <ul class="mui-table-view operation">
                <li class="mui-table-view-cell mui-media mui-col-xs-8 opli">需要支付:<b class="colororange eventTotal">￥</b></li>
                <li class="mui-table-view-cell mui-media mui-col-xs-4 opli bggreen" onclick="wxpay()">立即支付</li>
            </ul>
        </div>
    </div>

    <script src="/static/frontend/js/mui.min.js"></script>
    <script type="text/javascript" src="/static/frontend/js/wooApi.js"></script>
    <script type="text/javascript">
        //初始化
        mui.init({
            swipeBack: true //启用右滑关闭功能
        });

        $(function () {
            // 需要支付的费用
            $(".participator").on("blur", '', function () {
                var eventPrice = "{$eventInfo.price}";
                var participator = $(".participator").val();
                var eventTotal = eventPrice * participator;
                console.log(eventTotal)
                $(".eventTotal").text('￥' + eventTotal);
            });

            var surplus = "{$eventInfo.max}" - "{$eventInfo.participator}";
            $(".surplus").text(surplus)
        });


        // 获取数据
        // function wxpay() {
        //     var data = wooApi.getInputData('input', 'data');
        //     datas = wooApi.getInputData('select', 'data', data);
        //     // 获取其他标签值
        //     arrData = wooApi.getDomData('domData', datas);
        //     var objData = wooApi.arrTOobj(arrData);
        //     var remarks = $('textarea.data').val();
        //     objData.remarks = remarks;
        //     var url = "{:url('api/event/joinEventApi',['event_id'=>$eventInfo['id']])}";
        //     var ajaxResult = wooApi.asyncF(url, objData);
        //     if (ajaxResult.code == 200) {
        //         mui.alert(ajaxResult.msg, '活动创建成功', '确定', function () {
        //             var goUrl = "{:url('event/eventlist')}";
        //             window.top.location.href = goUrl;
        //         })
        //     } else {
        //         mui.alert(ajaxResult.msg, '活动创建失败', '确定', function () {
        //             mui.get("{:url('api/frontend/reloadtoken')}", function (data) {
        //                 if (data.code === 200) {
        //                     $('input[name=__token__]').val(data.data);
        //                 }
        //             }, 'json');
        //         })
        //     }
        // }

        // 立即支付
        function wxpay() {
            //条件1判断是否没数据
            if (!isStudent) {
                mui.alert('请先 [ 添加学生 ] 信息，谢谢！');
                return false;
            }
            //创建订单
            var res = createBill();
            if (res.code == 200) {
                if (typeof WeixinJSBridge == "undefined") {
                    if (document.addEventListener) {
                        document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
                    } else if (document.attachEvent) {
                        document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                        document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
                    }
                } else {
                    onBridgeReady();
                }
            } else {
                mui.alert('订单创建失败,请刷新页面或者重新登录', '提示', '确定', function () {
                    location.reload();
                })
            }
        }

        // 请他人代付
        function helpPay() {
            //条件1判断是否没数据
            if (!isStudent) {
                mui.alert('请先 [ 添加学生 ] 信息，谢谢！');
                return false;
            }
            //创建订单
            var res = createBill();
            if (res.code == 200) {
                window.location.href = "{:url('frontend/bill/billInfo',['bill_order'=>$billOrder])}";
            } else {
                mui.alert('订单创建失败,请刷新页面或者重新登录', '提示', '确定', function () {
                    location.reload();
                })
            }
        }


        function onBridgeReady() {
            var strJsApiParameters = '{$jsApiParameters}';
            var objJsApiParameters = JSON.parse(strJsApiParameters);
            WeixinJSBridge.invoke(
                'getBrandWCPayRequest', {
                    "appId": objJsApiParameters.appId,     //公众号名称，由商户传入     
                    "timeStamp": "{:time()}",         //时间戳，自1970年以来的秒数     
                    "nonceStr": objJsApiParameters.nonceStr, //随机串     
                    "package": objJsApiParameters.package,
                    "signType": "MD5",         //微信签名方式：     
                    "paySign": objJsApiParameters.paySign, //微信签名
                    'payType': objJsApiParameters.payType
                },
                function (res) {
                    if (res.err_msg == "get_brand_wcpay_request:ok") {
                        pay(JSON.stringify(res));
                    }     // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。 
                }
            );
        }


        //创建订单
        function createBill() {
            var remarks = $('.remarks').val();
            var student = $('.selectStudent').find("option:selected").text();
            var student_id = $('.selectStudent').val();
            objBillInfo.bill_order = "{$billOrder}";
            objBillInfo.goods_des = student + '购买' + objBillInfo.goods;
            objBillInfo.total = total;
            objBillInfo.student_id = student_id;
            objBillInfo.student = student;
            objBillInfo.remarks = remarks;
            objBillInfo.balance_pay = 0;
            var result = wooApi.asyncF("{:url('api/Bill/updateBillApi')}", objBillInfo);
            return result;
        }

        function pay(callback_str) {
            var result = wooApi.asyncF("{:url('api/Bill/payApi',['bill_order'=>$billOrder])}", {
                'balance_pay': total_fee,
                'callback_str': callback_str
            });

            if (result.code == 200) {
                mui.alert('欢迎加入本训练营，您的课程购买已完成，请留意课程消息及公告。', '购买成功', '确定', function () {
                    window.location.href = "{:url('frontend/bill/billInfo',['bill_order'=>$billOrder])}";
                });
            } else {
                mui.toast(result.msg);
            }
        }
    </script>

</body>

</html>