<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>活动录入</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!--标准mui.css-->
    <link rel="stylesheet" href="/static/frontend/css/mui.min.css">
    <!--自定义style.css-->
    <link rel="stylesheet" type="text/css" href="/static/frontend/css/style.css" />
    <!--选择器样式-->
    <link href="/static/frontend/css/mui.picker.min.css" rel="stylesheet" />
    <link href="/static/frontend/css/mui.poppicker.css" rel="stylesheet" />
    <link rel="stylesheet" href="/static/frontend/css/webuploader.css">
    <style>
        .mui-input-row a.mui-navigate-right {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .mui-popover-arrow {
            left: auto;
            right: 6px;
        }
        
        .mui-popover {
            height: 300px;
        }
        
        .mui-toast-container {
            top: 250px
        }
        
        .number {
            width: 20% !important;
        }
        
        .box {
            max-height: 300px;
            overflow: scroll;
            border-bottom: 1px solid #ddd;
        }
        
        .editor .image-items .mui-input-group .mui-input-row {
            height: initial;
        }
        
        .pdr {
            padding-right: 30px !important;
        }
        
        #newdiv .tips {
            color: #AAAAAA;
            line-height: normal;
        }
        
        .show {
            display: block;
        }
        
        .hide {
            display: none;
        }
    </style>
</head>

<body>

    <header id="header" class="mui-bar mui-bar-nav subheader">
        <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left arrow"><span class="return">返回</span></a>
        <h1 class="mui-title">{$eventInfo.organization}</h1>
    </header>

    <div class="mui-content">

        <div class="camp-list camp-lesson-list detalis-list grade-list editor mt">

            <ul class="mui-table-view list mb">
                <li class="mui-table-view-cell mui-media listli">
                    <a href="javascript:;" class="mui-navigate-right">
                        <div class="mui-media-body wd83">
                            <strong class="grade domData" name="event">{$eventInfo.event}</strong>
                            <p class="mui-ellipsis" style="text-indent: 0" data-id="{eventInfo.organization_id}">{$eventInfo.event_type}</p>
                            <input type="hidden" name="organization" value="{$eventInfo.organization}" class="data">
                            <input type="hidden" name="organization_id" value="{$eventInfo.organization_id}" class="data">
                            <input type="hidden" name="event" value="{$eventInfo.event}" class="data">
                            <input type="hidden" name="event_id" value="{$eventInfo.id}" class="data">
                            <input type="hidden" name="organization_type" value="{$eventInfo.organization_type}" class="data">
                        </div>
                    </a>
                </li>
            </ul>


            <div class="image-items">

                <form class="mui-input-group">
                    <div class="mui-input-row h-auto">
                        <a class="portraits filePicker" onclick="add_id(3)">
                            <label>上传合照</label>
                            <img id="preview_3">
                            <input type="hidden" class="data" name="cover" value="{$eventInfo.cover}">
                        </a>
                    </div>
                </form>

                <form class="mui-input-group">
                    <div class="mui-input-row">
                        <label>活动人员</label>
                    </div>
                    <div class="box" id="inactiveList">
                       
                    </div>

                    <div class="operation-btn">
                        <span class="mui-badge">0</span>
                        <a class="all">全选</a>
                        <a class="cancel">取消</a>
                        <a class="del">[删除]</a>
                        <a href="#addMember" id="setMemberBox" class="mui-icon mui-icon-personadd add"></a>
                    </div>
                </form>

            </div>

            <form action="" class="mui-input-group">

                <div class="mui-input-row {eq name='eventInfo.target_type' value='3'}show{else/}hide{/eq}">
                    <a href="#target" class="mui-navigate-right">
                        <label>具体对象</label>
                        <span class="targetCont" name="target">{$eventInfo.target}</span>
                        <input type="hidden" name="target_id" value="{$eventInfo.target_id}" class="">
                    </a>
                </div>

                <div class="mui-input-row picker btn" id="demo3" data-options='{"beginYear":2017,"endYear":2050}'>
                    <div class="mui-navigate-right">
                        <label>活动时间</label>
                        <span id="result" class="ui-alert domData" name="event_times">{$eventInfo.event_times}</span>
                    </div>
                </div>

                <div class="mui-input-row">
                    <label>活动地点</label>
                    <input type="text" name="location" value="{$eventInfo.location}" class="data location" placeholder="请输入活动地点">
                </div>

                <div class="mui-input-row" id='showCityPicker3'>
                    <div class="mui-navigate-right">
                        <label>所属地区</label>
                        <span id="cityResult3" class="ui-alert domData" name="address">{$eventInfo.province} {$eventInfo.city} {$eventInfo.area}</span>
                    </div>
                </div>

                <div class="mui-input-row">
                    <label>联系人</label>
                    <input type="text" name="contract" class="data" value="{$eventInfo.contract}" placeholder="请输入联系人">
                </div>

                <div class="mui-input-row">
                    <label>联系电话</label>
                    <input type="text" name="telephone" class="data" value="{$eventInfo.telephone}" placeholder="请输入联系电话">
                </div>

                <div class="mui-input-row mt55">
                    <label>活动简介</label>
                    <input type="text" name="event_des" class="data" value="{$eventInfo.event_des}" placeholder="请输入活动简介">
                </div>

            </form>

            <ul class="mui-table-view operation">
                <li class="mui-table-view-cell mui-media mui-col-xs-12 opli bggreen operationBtn" style="color: #fff">
                    提交录入
                </li>
            </ul>

        </div>


        <!--学员名单-->
        <div id="addMember" class="mui-popover">
            <div class="mui-popover-arrow"></div>
            <div class="page-header">
                <span class="course wd36"><strong>报名名单</strong></span>
                <span class="fr"><button class="mui-btn-blue" id="memberConfirm">确认</button></span>
            </div>
            <div class="mui-scroll-wrapper">
                <div class="mui-scroll">
                    <form id="newdiv" class="mui-input-group addMemberList"></form>
                </div>
            </div>
        </div>

        <script src="/static/frontend/js/mui.min.js"></script>
        <script src="/static/frontend/js/jquery-3.2.1.min.js"></script>
        <!-- 选择器 -->
        <script src="/static/frontend/js/mui.picker.min.js"></script>
        <script src="/static/frontend/js/mui.poppicker.js"></script>
        <script src="/static/frontend/js/city.data-3.js"></script>
        <script src="/static/frontend/js/common.js"></script>
        <script src="/static/frontend/js/wooApi.js"></script>
        <script>
            var uploadApiUrl = "{:url('api/upload/imgwupload', ['usage' => 'event'])}";
        </script>
        <script src="/static/frontend/libs/webuploader.cert.js?v=<?php echo time();?>"></script>
        <script src="/static/frontend/js/uploadcert.js?v=<?php echo time();?>"></script>
        <script>
            //初始化
            mui.init({
                swipeBack: true //启用右滑关闭功能
            });

            //弹出菜单
            mui('.mui-scroll-wrapper').scroll();

            //弹出框滚动必须写在mui专用的初始化
            (function ($) {
                $(".mui-scroll-wrapper").scroll({
                    //bounce: false,//滚动条是否有弹力默认是true
                    indicators: true //是否显示滚动条,默认是true
                });
                // 关闭弹出菜单
                $("body").on('tap', '.mui-backdrop', function () {
                    mui(".mui-popover.mui-active").popover("toggle");
                })
            })(mui);

            //选择器
            var getAddress = '';
            (function ($, doc) {
                $.ready(function () {
                    var _getParam = function (obj, param) {
                        return obj[param] || '';
                    };

                    //选择地区
                    var cityPicker3 = new $.PopPicker({
                        layer: 3
                    });

                    // 设置默认值
                    cityPicker3.pickers[0].setSelectedIndex(18);
                    cityPicker3.pickers[1].setSelectedIndex(2);
                    cityPicker3.pickers[2].setSelectedIndex(2);

                    cityPicker3.setData(cityData3);
                    var showCityPickerButton = doc.getElementById('showCityPicker3');
                    var cityResult3 = doc.getElementById('cityResult3');
                    showCityPickerButton.addEventListener('tap', function (event) {

                        cityPicker3.show(function (items) {
                            cityResult3.innerText = _getParam(items[0], 'text') + " " + _getParam(items[1], 'text') + " " + _getParam(items[2], 'text');
                            //返回 false 可以阻止选择框的关闭
                            //return false;
                            getAddress = _getParam(items[0], 'text') + " " + _getParam(items[1], 'text') + " " + _getParam(items[2], 'text');
                        });
                    }, false);

                    //选择时间
                    var result = $('#result')[0];
                    var btns = $('.btn');
                    btns.each(function (i, btn) {
                        btn.addEventListener('tap', function () {
                            var optionsJson = this.getAttribute('data-options') || '{}';
                            var options = JSON.parse(optionsJson);
                            var id = this.getAttribute('id');
                            var picker = new $.DtPicker(options);
                            picker.show(function (rs) {
                                result.innerText = rs.text;
                                picker.dispose();

                            });
                        }, false);
                    });
                });
            })(mui, document);

            //更新学员序号
            function changeIndex() {
                var i = 1;
                $(".checkboxCont").each(function () { //循环checkboxCont
                    $(this).find("label").text(i++);//更新序号
                });
            }

            // var memberData = '';
            memberData = [];
            $(function () {

                //全选
                $(".all").click(function () {
                    $(".checkboxCont").find('input').prop('checked', true)
                })

                //取消全选
                $(".cancel").click(function () {
                    $(".checkboxCont").find('input').prop('checked', false)
                })

                //删除
                $(".del").click(function () {
                    $("input[name='member']:checked").each(function () { // 遍历选中的checkbox
                        var n = $(this).parents("checkboxCont").index();  // 获取checkbox所在行的顺序
                        $(".checkboxCont:eq(" + n + ")").remove();
                    });
                });

                // 具体对象
                $(".target").click(function () {
                    var target = $.trim($(this).text());
                    var target_id = $(this).attr('data-id');
                    $(".target_id").val(target_id);
                    $(".targetCont").text(target);
                    mui("#target").popover("toggle");
                })
                // 费用结算人
                $(".cost").click(function () {
                    var cost = $.trim($(this).text());
                    var cost_id = $(this).attr('data-id');
                    $(".cost_id").val(cost_id);
                    $(".costCont").text(cost);
                    mui("#cost").popover("toggle");
                })

                //报名人员列表复选框赋值
                $("#setMemberBox").on('tap', '', function () {
                    //每次打开先清空所有选择
                    $("input[name='checkbox-member']").prop("checked", false);
                    //然后遍历出对应所选
                    $(".stdList").each(function (i) {
                        var id = $(this).attr("data-id");
                        var member_id = $(this).attr("data-member_id");
                        var member = $(this).attr("data-member");
                        $("#newdiv").find("input[name='checkbox-member']").filter(function (index) {
                            return $(this).attr("data-member_id") == member_id
                        }).prop("checked", true);
                    });
                });

                //角标随checkboxCont的数量变化
                $(document).on('click', '.del', function () {
                    totalNum = $(".checkboxCont").length;
                    $(".mui-badge").text(totalNum);
                });

                // 选择添加报名人员点击事件
                $("#memberConfirm").on('click', function () {

                    $("#inactiveList").empty();
                    memberData = [];//报名人员列表数组

                    $(".addMemberList input[type=checkbox]:checked").each(function () {
                        var str = '<div class="mui-input-row mui-checkbox checkboxCont"><label class="number"></label><font>' + $(this).val() + '</font><input name="member" value="' + $(this).val() + '" data-id="' + $(this).attr("data-id") + '" data-member="' + $(this).attr("data-member") + '" data-member_id="' + $(this).attr("data-member_id") + '" data-status="' + $(this).attr("data-status") + '" type="checkbox"><input type="hidden" class="stdList" data-id="' + $(this).attr("data-id") + '" data-member="' + $(this).attr("data-member") + '" data-member_id="' + $(this).attr("data-member_id") + '" data-status="' + $(this).attr("data-status") + '"></div>';
                        var id = $(this).attr("data-id");
                        var member_id = $(this).attr("data-member_id");
                        var member = $(this).attr("data-member");
                        var status = $(this).attr("data-status");
                        $("#inactiveList").append(str);
                        console.log(id)
                        console.log(member_id)
                        memberData.push({ member: member, member_id: member_id, id: id, status: 3 });
                    });

                    console.log(memberData)

                    changeIndex();//调用-更新序号
                    mui("#addMember").popover("toggle");
                    totalNum = $(".checkboxCont").length;
                    $(".mui-badge").text(totalNum);
                });

                // 已报名的人
                toSignUpList();

                $(".operationBtn").on("click", '', function () {
                    var data = wooApi.getInputData('input', 'data');
                    datas = wooApi.getInputData('select', 'data', data);
                    // 获取其他标签值
                    arrData = wooApi.getDomData('domData', datas);
                    var objData = wooApi.arrTOobj(arrData);
                    objData.memberData = JSON.stringify(memberData);
                    console.log(memberData);
                    var url = "{:url('api/event/recordEventApi',['event_id'=>$eventInfo['id']])}";
                    var ajaxResult = wooApi.asyncF(url, objData);
                    if (ajaxResult.code == 200) {
                        mui.alert(ajaxResult.msg, '活动录入成功', '确定', function () {
                            window.location.href = "{:url('frontend/event/eventListOfCamp',['event_id'=>$eventInfo['id']])}";
                        })
                    } else {
                        mui.alert(ajaxResult.msg, '活动录入失败', '确定', function () {

                        })
                    }
                });
            });

            //获取已经报名人员列表
            var toSignUpList = function () {
                var event_id = "{$eventInfo.id}";
                mui.ajax("{:url('api/event_member/getEventMemberListNoPageApi',['event_id'=>$eventInfo.id])}", {
                    data: {
                        'event_id': event_id,
                    },
                    dataType: 'json',//服务器返回json格式数据
                    type: 'post',//HTTP请求类型
                    timeout: 10000,//超时时间设置为10秒；
                    headers: { 'Content-Type': 'application/json' },
                    success: function (data) {
                        //服务器返回响应，根据响应结果，分析是否登录成功；
                        console.log(data)
                        var div = '';
                        if (data.code == 200) {
                            for (var i = 0; i <= data.data.length - 1; i++) {
                                div = div + '<div class="mui-input-row mui-checkbox mui-left"><label>' + data.data[i].member + '</label><input name="checkbox-member" class="member" value="' + data.data[i].member + '" data-member="' + data.data[i].member + '" data-member_id="' + data.data[i].member_id + '" data-status="' + data.data[i].status + '" type="checkbox" data-id="' + data.data[i].id + '"></div>'
                            }
                            $("#newdiv").empty();
                            $("#newdiv").append(div);
                        }
                    },
                    error: function (xhr, type, errorThrown) {
                        //异常处理；
                        console.log(type);
                    }
                });
            };
        </script>
</body>

</html>