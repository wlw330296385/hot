<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>微信支付</title>
	<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<!--标准mui.css-->
	<link rel="stylesheet" href="/static/frontend/css/mui.min.css">
	<!--自定义style.css-->
	<link rel="stylesheet" type="text/css" href="/static/frontend/css/style.css"/>
	<style>
		.charge-form {
			width: 80%;
			margin: 30px auto;
			font-size: 14px;
			color: #737373;
			text-align: center;
		}
		.charge-form .sum{
			padding: 30px 35px;
			font-size: 30px;
		}
		.charge-form .sum span{
			font-size: 36px;
		}
		.mui-btn-block{
			padding: 10px 0;
			font-size: 16px;
		}
		.tips{
			font-size: 12px;
			color:#999;
			text-align: center;
		}
	</style>
</head>

<body class="whitebg">
<header id="header" class="mui-bar mui-bar-nav subheader">
	<span class="mui-icon mui-icon-closeempty mui-pull-left"></span>
	<h1 class="mui-title">微信支付</h1>
</header>
<div class="mui-content whitebg">

	<form action="" class="charge-form">
		<label></label>
		<div class="sum colororange">￥<span></span></div>
		<button type="button" class="mui-btn mui-btn-block bggreen" id="submit">确定支付</button>
		<a href="#" class="backUrl tips">返回修改金额</a>
	</form>

</div>

</body>
<script src="/static/frontend/js/mui.min.js"></script>
<script src="/static/frontend/js/jquery-3.2.1.min.js"></script>
<script src="/static/frontend/js/wooApi.js?v={:time()}"></script>
<script src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
<script>


    var total = wooApi.GetQueryString('total');
    var title = wooApi.GetQueryString('title');
    var title = wooApi.GetQueryString('title');
    var type = wooApi.GetQueryString('type');
    var backUrl = wooApi.GetQueryString('backUrl');

    $(function () {

        $(".charge-form label").text(title+'金额');
        $(".sum span").text(total);

        $(".mui-icon-closeempty,.backUrl").click(function () {
            console.log(backUrl);
            backUrl = changeURLArg(backUrl,"backTotal",total);

            console.log(backUrl);
            window.location.href = backUrl
        });

        wx.ready(function(){
	        $(document).on('tap','#submit',function () {

	            {if $jsApiParameters === 0}
	            alert('订单已支付,不可再支付');

	        	{else /}
		            var strJsApiParameters = '{$jsApiParameters}';
		            var objJsApiParameters = JSON.parse(strJsApiParameters);
		            wx.chooseWXPay({
		                timestamp: {$jsApi['timestamp']},
		                nonceStr: objJsApiParameters.nonceStr,
		                package: objJsApiParameters.package,
		                signType: 'MD5',
		                paySign: objJsApiParameters.paySign,
		                success: function (res) {
		                    // 支付成功后的回调函数
		                    charge(JSON.stringify(res));
		                },
		                cancel: function() {
		                    mui.toast('取消了支付付款');
		                    // mui.alert('取消了支付付款');
		                },
		                fail: function(res) {
		                    var errmsg = res.errMsg;
		                    mui.alert(errmsg);
		                }
		            });
		        {/if}


	        });
        })


        wx.checkJsApi({
		    jsApiList: ['chooseWXPay'], // 需要检测的JS接口列表，所有JS接口列表见附录2,
		    success: function(res) {
			    // 以键值对的形式返回，可用的api值true，不可用为false
			    // 如：{"checkResult":{"chooseImage":true},"errMsg":"checkJsApi:ok"}
			    console.log(res);
			},

		});


    })


    function charge(remarks){
    	$.ajax({
            url: "{:url('api/Charge/ChargeApi',['charge_order'=>$billOrder])}",
            data: {
                "charge" : total,
                "type":type,
            },
            async: false,
            type: 'post',
            dataType:'json',
            complete: function(msg) {
                console.log(msg)
            },
            success:function(msg){
                if(msg.code == 200){
                    mui.alert(msg.msg,'提示','确定',function(){
                        //支付成功后刷新父窗口页面
                        window.location.href = backUrl;
                      });
                }else{
                    mui.alert(msg.msg,'提示','确定',function(){
                    //支付失败后刷新父窗口页面
                    window.location.reload();
                	});
                }
            },
            error:function(msg){
                alert(JSON.stringify(msg));
            }
        });
    }

    //url 目标url
    //arg 需要替换的参数名称
    //arg_val 替换后的参数的值
    //return url 参数替换后的url
    function changeURLArg(url,arg,arg_val){
        var pattern=arg+'=([^&]*)';
        var replaceText=arg+'='+arg_val;
        if(url.match(pattern)){
            var tmp='/('+ arg+'=)([^&]*)/gi';
            tmp=url.replace(eval(tmp),replaceText);
            return tmp;
        }else{
            if(url.match('[\?]')){
                return url+'&'+replaceText;
            }else{
                return url+'?'+replaceText;
            }
        }
        return url+'\n'+arg+'\n'+arg_val;
    }

</script>

<script type="text/javascript">
    wx.config({
            //开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
            debug:false,
            appId: "{$jsApi.appId}", // 必填，企业号的唯一标识，此处填写企业号corpid
            timestamp: {$jsApi.timestamp}, // 必填，生成签名的时间戳
            nonceStr: "{$jsApi.nonceStr}", // 必填，生成签名的随机串
            signature: "{$jsApi.signature}",// 必填，签名，见附录1
            jsApiList:  [
                // 所有要调用的 API 都要加到这个列表中
                'checkJsApi',
                'chooseWXPay',
            ]// 必填，需要使用的JS接口列表，所有JS接口列表见附录2
        });

    
</script>
</html>