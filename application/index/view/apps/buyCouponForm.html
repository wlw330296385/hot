<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>动漫节 - 投篮卡</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!--标准mui.css-->
    <link rel="stylesheet" href="/static/frontend/css/mui.min.css">
    <!--自定义style.css-->
    <link rel="stylesheet" type="text/css" href="/static/frontend/css/style.css" />
    <!-- webuploader -->
    <link rel="stylesheet" href="/static/frontend/css/webuploader.css">
    <style>
        .tipContent {
            margin: 0px 28px;
            line-height: 54px;
            vertical-align: middle;
        }

        .tipContent .tipContentText{
            padding: 15px 0 5px;
        }

        .tipContent .tipContentText p {
            line-height: 20px;
            color: #666;
        }

        .registerFrom {
            margin: 0px 25px;
            background: none;
            padding-bottom:20px;
            border-bottom: 1px solid #DDD;
        }
        .registerFrom p{
            color:#666;
            padding: 20px 0 0;
        }

        .registerFrom .mui-input-row {
            margin-top: 15px;
            background: #fff;
        }

        .tipBottom {
            margin: 30px;
            text-align: center;
        }
        .tipBottom p.f12 {
            color: #999;
            font-size: 12px;
        }
        #eventDes {
            margin-top: 0;
            display: none;
        }
        #showSuccess {
            display: none;
            padding: 20px;
            text-align: center;
        }
        #showSuccess h4,#showSuccess p{
            color:#FFF;
        }
        .nobg {
            background: transparent !important;
        }
        .nobg::after {
            background: none !important;
        }
        .selectTotal, .selectDom{
            padding: 5px 8px !important;
        }
        .mui-input-group:before{
            background: none;
        }
        .mui-input-row .mui-numbox {
            float: none;
        }
        #myCoupon{
            display: none;
        }

    </style>
</head>

<body>

<header class="mui-bar mui-bar-nav">
    <h1 class="mui-center mui-title">{$eventInfo.event}</h1>
</header>

<div class="mui-content mt55" style="background: none !important">
    <div id="showSuccess" class="bggreen">
        <h4>恭喜您购买成功！</h4>
        <p>祝您好运，赢取游戏大奖！</p>
    </div>

    <ul class="mui-table-view list" id="eventDes">
        <li class="listli desimg">{$eventInfo.event_des}</li>
    </ul>
    <div class="tipContent border-b">
        <div class="tipContentText">
            <p>
                <strong>购买说明：</strong>
            </p>
            <p>{$eventInfo.apps_des}</p>
        </div>
    </div>

    <form action="" class="mui-input-group registerFrom {if $memberInfo.id>0}hide{else/}show{/if}">
        <input type="hidden" name="__token__" class="data" value="{$Request.token}" />
        <input type="hidden" name="member_id" class="data" value="{$memberInfo['id']}" />
        <input type="hidden" name="type" class="data" value="2" />
        <input type="hidden" name="f_id" class="data" value="{$eventInfo.id}" />
        <input type="hidden" name="event" class="data" value="{$eventInfo.event}" />
        <p>
            <strong>首次购买需登记以下信息，以便联系领奖！</strong>
        </p>
        <div class="mui-input-row mName">
            <label class="colororange">会员名</label>
            <input type="text" class="data" name="member" value="{$memberInfo.member}" placeholder="会员名（没填默认为电话号码）">
            <input type="hidden" class="data" name="realname" value="{$memberInfo.realname}" placeholder="姓名">
        </div>

        <div class="mui-input-row">
            <label class="colororange">联系电话</label>
            <input type="text" class="data telephone" name="telephone" value="{$memberInfo.telephone}" placeholder="联系电话">
        </div>

        <div class="mui-input-row smsValidate {if $memberInfo.id>0}hide{else/}show{/if}">
            <label class="colororange">短信验证码</label>
            <input type="button" class="code-btn" value="获取验证码" onclick="sendCode(this)" style="width: 30%;">
            <input id="code" type="text" class="input reg_code reg_validate" placeholder="输入验证码" style="width: 30%;">
        </div>
    </form>


    <div class="tipContent" id="sDom">
        <div class="tipContentText border-b">
            <p>
                <strong>请选择您要购买的种类：</strong>
            </p>
            <p>
                {volist name='$eventInfo.doms' id="vol"}
                <button type="button" class="mui-btn selectTotal selectDom" value="{$vol.price}" data="{$key}"><span>{$vol.name}</span><div>¥{$vol.price}</div></button>
                {/volist}
            </p>
        </div>
        <div class="tipContentText border-b">
            <p>
                <strong>请选择你要购买几张票：</strong>
            </p>
            <div class="mui-input-row h-auto">
                <div class="mui-numbox" data-numbox-min='1'>
                    <button class="mui-btn mui-btn-numbox-minus" type="button">-</button>
                    <input class="mui-input-numbox data" type="number" name="total" value="1">
                    <button class="mui-btn mui-btn-numbox-plus" type="button">+</button>
                </div>
            </div>
        </div>
    </div>




    <div class="endDate"></div>

    <div class="tipBottom">
        <p><strong>结束日期：{$eventInfo.ends} {if $eventInfo.is_max=="已满人"}（已满人）{/if}</strong></p>
        <br />
        <p>本活动最终解释权归{$eventInfo.organization}所有<br />
        <span class="f12">Power by HotTech | 技术支持（篮球管家）</span>
        </p>
    </div>

    <ul class="mui-table-view operation">
        <li class="mui-table-view-cell mui-col-xs-12 opli bggreen" id="submitAction">
            提交
        </li>
    </ul>

    <ul class="mui-table-view operation" id="myCoupon">
        <li class="mui-table-view-cell mui-col-xs-12 opli bgorange">
            查看我的卡券
        </li>
    </ul>
</div>


<script src="/static/frontend/js/mui.min.js"></script>
<script src="/static/frontend/js/jquery-3.2.1.min.js"></script>
<script src="/static/frontend/libs/yzvalidate.js"></script>
<script src="/static/frontend/js/common.js"></script>
<script src="/static/frontend/js/city.data-3.js"></script>
<script src="/static/frontend/js/wooApi.js"></script>
<script src="/static/frontend/js/smsCode.js"></script>
<script>

    //弹出菜单
    mui('.mui-scroll-wrapper').scroll();

//    var wxOpenID = "{$memberInfo.openid}";

    //定义全局变量
    var flagPhone = false;
    var flagSMS = false;
    var flagMember = false;
    var flagCreate = true;
    var mID = "{$memberInfo.id}";
    var getCurrTel = "";

    var showDetail = wooApi.GetQueryString('showDetail');
    var showSuccess = wooApi.GetQueryString('showSuccess');

    var paySuccess = wooApi.GetQueryString('paySuccess');
    var callbackStr = wooApi.GetQueryString('callbackStr');
    var backTotal = wooApi.GetQueryString('backTotal');
    var backDomName = wooApi.GetQueryString('backDomName');
    var billOrder = wooApi.GetQueryString('billOrder');

    $(function () {

        //支付成功后返回创建活动会员记录以及卡券记录
        if(paySuccess=="yes"&&callbackStr!=""&&backTotal!=""&&backDomName!=""&&billOrder!=""){
            $("input[name='total']").val(backTotal);
            var $option =$(".selectDom span").map(function(){
                if ($(this).text() == backDomName) {
                    return this;
                }
            });
            $option.addClass('bggreen');
            //支付成功执行更新订单状态
            pay();
        }

        /////////////////////////////////////


        var time = Number("{$eventInfo.end}");
        var timestamp = Date.parse(new Date())/1000;

        if("{$eventInfo.status}"=="下架"){
            //活动下架提示，并隐藏表单
            $(".operation").empty().append('<li class="mui-table-view-cell mui-col-xs-12 opli bggray">活动下架</li>');
            $("#eventDes").show();
            $(".registerFrom").hide();
            $("#sDom").hide();
        }else if(timestamp>time){
            //判断当前时间是否大于活动结束时间
            $(".operation").empty().append('<li class="mui-table-view-cell mui-col-xs-12 opli bggray">活动已经结束</li>');
            $("#eventDes").show();
            $(".registerFrom").hide();
            $("#sDom").hide();
        }else if("{$eventInfo.is_max}"=="已满人"){
            //活动已满人提示，并隐藏表单
            $(".operation").empty().append('<li class="mui-table-view-cell mui-col-xs-12 opli bggray">活动已满人</li>');
            $("#eventDes").show();
            $(".registerFrom").hide();
            $("#sDom").hide();
        }

        if(showDetail=="yes"){
            $("#eventDes").show();
        }
        if(showSuccess=="yes"){
            $(".registerFrom").hide();
            $(".operation").hide();
            $("#sDom").hide();
            $("#showSuccess").show();
            $("#eventDes").show();
            $("#myCoupon").show();
        }



        // 测试openid
        $('.tipBottom .f12').on('click', function () {
            mui.toast('te'+wxOpenID+'st');
        })


        //获取定位省市区
        var getLocationTB = getLocationApi("{:url('api/Location/getLocation')}");
        var gCity = getLocationTB['city'];
        var gProvince = getLocationTB['province'];
        var gArea = getLocationTB['area'];
        if (gCity == null || gCity == "undefined") {
            gCity = "";
        }
        if (gProvince == null || gProvince == "undefined") {
            gProvince = "";
        }
        if (gArea == null || gArea == "undefined") {
            gArea = "";
        }


        //如果套餐选项只有一个就自动选上
        if($('.selectDom').length==1){
            $('.selectDom').addClass('bggreen');
        }

        // 选择套餐
        $('.selectDom').on('click', function () {
            $('.selectDom').removeClass('bggreen');
            $(this).addClass('bggreen');
            $('.price-frame strong').text($(this).val());
        })

        //验证短信验证码
        $('#code').on("blur", function () {
            var code = document.getElementById('code').value;
            var codeReg = /^\d{6,6}$/;
            if (!codeReg.test(code)) {
                mui.toast('请填写正确的验证码');
                flagSMS = false;
            } else {
                var telephone = $(".telephone").val();
                var result = smsCode.validateSmsCodeApi(telephone, code, "{:url('api/sms/validateSmsCodeApi','','',true)}");
                if (result.code == 200) {
                    flagSMS = true;
                    mui.toast(result.msg);
                } else {
                    flagSMS = false;
                    mui.toast(result.msg);
                }
            }
        });

        //获取电话焦点时记录当前手机号，用于离开焦点后判断是否有修改
        $('.telephone').on("focus", function () {
            getCurrTel = $(this).val()
            console.log(getCurrTel)

        });

        //验证是否注册的手机号
        $('.telephone').on("blur", function () {
            var telephone = $(this).val();
            if (telephone != "") {
                if(getCurrTel!=telephone) {
                    //非会员或会员但修改了号码（帮别人报名）
                    if (!(/^1[34578]\d{9}$/).test(telephone)) {
                        //判断手机号码格式是否正确
                        mui.toast("请填写正确的手机格式");
                        flagPhone = false;
                        return false;
                    } else {

                        //判断是否已经注册的会员手机号
                        mui.ajax("{:url('api/login/isFieldRegisterApi')}", {
                            data: {
                                'field': 'telephone',
                                'value': telephone
                            },
                            dataType: 'json',//服务器返回json格式数据
                            type: 'post',//HTTP请求类型
                            async: false,
                            timeout: 10000,//超时时间设置为10秒；
                            headers: {'Content-Type': 'application/json'},
                            success: function (data) {
                                console.log(data);
                                //判断该手机号码是否已经是注册会员
                                if (data.msg == 1) {
                                    mui.alert("该手机号码是本平台已注册会员、请让本人自行报名，谢谢！");
                                    flagPhone = false;
                                } else {
                                    flagPhone = true;
                                }
                            },
                            error: function (xhr, type, errorThrown) {
                                console.log(type);
                            }
                        });

                    }
                }
            }else{
                flagPhone = false;
            }

        });

        $("input[name='member']").on("blur", function () {

            var member = $.trim($(this).val());
            $(this).val(member);

            //判断会员名格式
            if (((/\s/).test(member)) === true) {
                flagMember = false;
                mui.alert("会员名不许有空格");
                return false;
            } else if ((/^[\u4E00-\u9FA5A-Za-z0-9_]{2,15}$/).test(member) === false) {
                flagMember = false;
                mui.alert("会员名只能包含英文、数字或中文，长度为2-15位");
                return false;
            }

            //判断用户名是否存在
            hasMemberName(member)
        });


        $("#submitAction").on("click", "", function () {


            if($('.selectDom.bggreen').length==0){
                mui.toast("请选择您要购买的种类");
                return false;
            }
            var total = $("input[name='total']").val();
            var domName = $('.selectDom.bggreen').find("span").text();
            var domPrice = $('.selectDom.bggreen').attr("value");

            var member = $("input[name='member']").val();
            var telephone = $("input[name='telephone']").val();
            var token = $('input[name=__token__]').val();

            //如果是否没填手机号码
            if(telephone==""||telephone==null||telephone==undefined){
                mui.toast("提交失败，手机号填写有误，请重新填写");
                return false;
            }
            //如果没填会员名称，会员名和真实姓名都默认为电话号码
            if(member==""){
                $("input[name='member']").val(telephone);
                $("input[name='realname']").val(telephone);
                hasMemberName(telephone)
            }
            //如果是非会员，判断是否通过验证
            if (mID == "") {
                if (flagMember == false) {
                    mui.toast("提交失败，会员名填写有误，请重新填写！");
                    return false;
                };
                if (flagPhone == false) {
                    mui.toast("提交失败，手机号填写有误，请重新填写");
                    return false;
                };
                if (flagSMS == false) {
                    mui.toast("提交失败，验证码填写有误");
                    return false;
                };
                //如已经通过以上验证则创建会员账号
                mui.ajax("{:url('api/login/registerApi')}", {
                    data: {
                        member: member,
                        telephone: telephone,
                        province: gProvince,
                        city: gCity,
                        area: gArea,
                        __token__: token,
                        ismyself: 1
                    },
                    dataType: 'json',//服务器返回json格式数据
                    type: 'post',//HTTP请求类型
                    async: false,
                    timeout: 10000,//超时时间设置为10秒；
                    headers: { 'Content-Type': 'application/json' },
                    success: function (data) {
                        //服务器返回响应，根据响应结果，分析是否登录成功；
                        console.log(data);
                        if (data.code == 100) {
                            flagCreate = false;
                            mui.alert(data.msg, '提交失败', '确定', function () {
                                mui.get("{:url('api/frontend/reloadtoken')}", function (data) {
                                    if (data.code === 200) {
                                        $('input[name=__token__]').val(data.data);
                                    }
                                }, 'json');
                            })
                        } else {
                            flagCreate = true;
                            $("input[name='member_id']").val(data.id)
                            console.log(data.id)
                            mui.toast("提交中...");
                        }
                    },
                    error: function (xhr, type, errorThrown) {
                        //异常处理；
                        flagCreate = false;
                        console.log(type);
                    }
                });
            }
            //如果是非会员，检查是否成功注册会员，没成功就中断流程
            if (flagCreate == false) {
                mui.alert('登记信息失败，请重新提交或稍后再试！', '提交失败', '确定', function () {
                    mui.get("{:url('api/frontend/reloadtoken')}", function (data) {
                        if (data.code === 200) {
                            $('input[name=__token__]').val(data.data);
                        }
                    }, 'json');
                })
                return false;
            }


            ///////////////////////////////////////////////////////////////////////
            //   流程开始：  活动已过期或已满人可进行报名，但不会产生 event_member      //
            ///////////////////////////////////////////////////////////////////////
            //1.提交未付款

            var res =  createBill();
            if(res.code == 200){

                //合计支付金额////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// 去除下面/100
                var sum = parseInt(total)*parseInt(domPrice)/100

                //2.去支付页面
                //处理url参数
                var backUrl = '{:request()->server("http_referer")}';
                if(backUrl.indexOf("?")!=-1){
                    backUrl = backUrl + '&backTotal='+total+'&backDomName='+domName+'&billOrder='+billOrder;
                }else{
                    backUrl = backUrl + '?backTotal='+total+'&backDomName='+domName+'&billOrder='+billOrder;
                }
                //去重
                backUrl = changeURLArg(backUrl,"backTotal",total);
                backUrl = changeURLArg(backUrl,"backDomName",domName);
                backUrl = changeURLArg(backUrl,"billOrder",billOrder);
                // 这里是跳转并且支付后返回
                top.location = "{:url('/index/wechatpay/wechatpay')}"+'?total='+sum+'&type=-1&title='+total+'张'+domName+'&backUrl='+backUrl;

            }else{
                mui.alert('订单创建失败,请刷新页面或者重新登录','提示','确定',function(){
                    location.reload();
                })
            }

            //3.订单变成已支付
            // 跳转支付后判断,如果已支付,返回传参,,默认为 {"err_msg":"get_brand_wcpay_request:ok"}
            //pay('{"err_msg":"get_brand_wcpay_request:ok"}');
            //4.joinEvent
            //joinEvent();
            //5.赠送卡券.根据支付哪个套餐送哪张卡券
            //presentItemCoupon(item_coupon_ids);

            ///////////////////////////////////////////////////////////////////////
            //   流程开始结束：  活动已过期或已满人可进行报名，但不会产生 event_member      //
            ///////////////////////////////////////////////////////////////////////


        });

    })

    // 发送短信验证码
    function sendCode(obj) {
        var telephone = $(".telephone").val();
        var telephoneReg = /^1[34578]\d{9}$/;
        if (!telephoneReg.test(telephone)) {
            mui.toast('请填写正确的手机号码');
        } else {
            var result = smsCode.getMobileCodeApi(obj, telephone, "{:url('api/sms/getMobileCodeApi','','',true)}");
            if (result.code == 200) {
                mui.toast(result.msg);
            } else {
                mui.toast(result.msg);

            }
        }
    }


    //判断用户名是否存在
    function hasMemberName(memberName) {
        mui.ajax("{:url('api/login/isFieldRegisterApi')}", {
            data: {
                'field': 'member',
                'value': memberName
            },
            dataType: 'json',//服务器返回json格式数据
            type: 'post',//HTTP请求类型
            async: false,
            timeout: 10000,//超时时间设置为10秒；
            headers: {'Content-Type': 'application/json'},
            success: function (data) {
                console.log(data);
                if (data.msg == 1) {
                    flagMember = false;
                    mui.alert("该会员名称已经存在，请使用其他名称！");
                    return false;
                } else {
                    flagMember = true;
                    $("input[name='realname']").val(memberName);
                }
            },
            error: function (xhr, type, errorThrown) {
                console.log(type);
            }
        });
    }



    //创建订单
    function createBill(){

        var member = $("input[name='member']").val();
        var member_id = $("input[name='member_id']").val();
        var total = $("input[name='total']").val();
        var domName = $('.selectDom.bggreen').find("span").text();
        var domPrice = $('.selectDom.bggreen').attr("value");

        var objBillInfo = {};//订单参数
        objBillInfo.bill_order = "{$billOrder}";
        objBillInfo.goods_des = member+'购买深圳2018动漫展大热篮球投篮卡券';
        objBillInfo.total = total;
        objBillInfo.student_id = member_id;
        objBillInfo.student = member;
        objBillInfo.remarks = member+'购买'+total+'张深圳2018动漫展大热篮球投篮卡券'+domName;
        objBillInfo.balance_pay = 0;
        objBillInfo.goods = "深圳2018动漫展大热篮球投篮卡券";
        objBillInfo.goods_id = "{$eventInfo.id}"
        objBillInfo.price = domPrice;
        objBillInfo.score_pay = 0;
        objBillInfo.organization_type = 1;
        objBillInfo.goods_type = 2;
        objBillInfo.pay_type = 2;
        objBillInfo.camp = '大热篮球';
        objBillInfo.camp_id = 9;

        objBillInfo.__token__ = "{$Request.token}";
        var result = wooApi.asyncF("{:url('api/Bill/updateBillApi')}",objBillInfo);
        return result;
    }

    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// 去除下面/100
    //支付订单
    function pay(){

            var total = $("input[name='total']").val();
            var domPrice = $('.selectDom.bggreen').attr("value");
            var total_fee = parseInt(domPrice)*parseInt(total)/100;

            var url = "{:url('api/Bill/payApi')}/bill_order/"+billOrder;
            var result = wooApi.asyncF(url,{
                'balance_pay' : total_fee,
                'callback_str':callback_str
            });

            if(result.code == 200){
                joinEvent();
            }else{
                mui.toast(result.msg);
            }
    }


    // 提交参加活动
    function joinEvent() {

        var member = $("input[name='member']").val();
        var total = $("input[name='total']").val();
        var domName = $('.selectDom.bggreen').find("span").text();
        var studentList = [{
            student: "{$memberInfo.member}",
            student_id: '0',
            total: total,
            combo: domName,
            member: "{$memberInfo.member}",
            member_id: "{$memberInfo.id}",
            event: "{$eventInfo.event}",
            event_id: "{$eventInfo.id}"
        }];
        let arrData = wooApi.getInputData();
        objData = wooApi.arrTOobj(arrData);
        objData.remarks = member + '购买' + total + '张深圳2018动漫展大热篮球投篮卡券' + domName;
        objData.memberData = JSON.stringify(studentList);
        objData.event = "{$eventInfo.event}";
        let url = "{:url('api/event/joinEventApi',['event_id'=>$eventInfo['id']])}";
        let result = wooApi.asyncF(url + '/total/' + 1, objData);
        if (result.code == 200) {
            presentItemCoupon();
        } else {
            mui.alert(result.msg);
        }

    }

    // 赠送卡券操作
    function presentItemCoupon(){

        var total = $("input[name='total']").val();
        var item_coupon_id = "";
        var domName = $('.selectDom.bggreen').find("span").text();
        //后期考虑套餐对应指定卡券
        if(domName=="单项卡"){
            item_coupon_id = "21";
        }else if(domName=="三项卡"){
            item_coupon_id = "22";
        }
        var result =  wooApi.asyncF("{:url('api/Item_coupon/createItemCouponMemberAllApi')}", {
            'item_coupon_id' : item_coupon_id,
            'total':total
        });

        if(result.code == 200){
            mui.alert("购买成功，请到我的卡券进行使用，谢谢！。",result.msg,function(){
                window.location.href="{:url('index/apps/buycouponForm/event_id')}{$eventInfo.id}?showSuccess=yes";
            });
        }else{
            mui.toast(result.msg);
        }


    }


    //url 目标url
    //arg 需要替换的参数名称
    //arg_val 替换后的参数的值
    //return url 参数替换后的url
    function changeURLArg(url,arg,arg_val){
        var pattern=arg+'=([^&]*)';
        var replaceText=arg+'='+arg_val;
        if(url.match(pattern)){
            var tmp='/('+ arg+'=)([^&]*)/gi';
            tmp=url.replace(eval(tmp),replaceText);
            return tmp;
        }else{
            if(url.match('[\?]')){
                return url+'&'+replaceText;
            }else{
                return url+'?'+replaceText;
            }
        }
        return url+'\n'+arg+'\n'+arg_val;
    }

</script>
</body>

</html>