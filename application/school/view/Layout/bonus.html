

<link rel="stylesheet" type="text/css" href="/static/frontend/css/coupon.css" />
<div id="giftpopover" class="mui-popover">
        <div id="gift-open"></div>
        <span id="gift-close" class="mui-icon mui-icon-closeempty"></span>
        <div class="page-header">
            <h4>{$bonusInfo.bonus}</h4>
            <p>{$bonusInfo.title}</p>
        </div>
        <div class="mui-scroll-wrapper">
            <div class="mui-scroll middle-coupon">
                {volist name= 'couponList' id='vol'}
                <div class="coupon">
                    <div class="orangebg">
                        <div class="cNum">{$vol.price}<span>元</span></div>
                        <div class="cName">{$vol.coupon}</div>
                        <div class="cDate">{$vol.start} 至 {$vol.end}</div>
                        <i></i>
                    </div>
                    <div class="tips">
                        <span>剩余领取：{$vol.max-$vol.publish}</span>
                        <a href="{:url('frontend/Coupon/itemCouponInfo',['item_coupon_id'=>$vol['id']])}">查看卡券详情<span class="mui-icon mui-icon-forward"></span></a>
                    </div>
                </div>
                {/volist}
            </div>
        </div>
        <div class="hbTips"><a href="{$fasturl}">非会员注册后即可领取礼包，立即注册<span class="mui-icon mui-icon-forward"></span></a></div>
    </div>

<script type="text/javascript">
    var item_coupon_ids = JSON.stringify({$item_coupon_ids});
    var isBonus;

    isBonus = localStorage.getItem('isBonus');
    console.log(isBonus);
	$(function(){
        //阻止点击弹出层以外地方退出弹出层
        window.addEventListener('tap', function(e) {
            e.target.className == 'mui-backdrop mui-active' && e.stopPropagation();
        },true)
        //打开获取大礼包
        if(!isBonus){
            mui("#giftpopover").popover('show', document.getElementById("tabbar"));
            $("#gift-open").animate({
                width:'+=20px',
                height:'+=20px',
                left:'-=10px',
                top:'-=10px',
            },"fast",function(){$("#gift-open").animate({
                width:'-=20px',
                height:'-=20px',
                left:'+=10px',
                top:'+=10px',
            },"fast")});
        }
        
        //关闭大礼包弹出层
        mui("body").on("tap", "#gift-close", function () {
            $("#giftpopover").animate({
                width:'-=40px',
                height:'-=40px',
                left:'+=20px',
                top:'+=20px',
            },"fast");
            mui("#giftpopover").popover('hide');
        });
        //打开红包
        $("#gift-open").on("tap", "", function () {
//            $(this).hide();
            $(this).animate({
                top:'-400px',
                opacity:'0'
            },"fast");
            if ({$memberInfo.id} == 0) {
                mui.confirm('请注册成为篮球管家会员领取大礼包，感谢您的支持！', '提示', ['取消', '立即注册'], function (e) {
                    if (e.index === 1) {
                        window.location.href = "{$fasturl}";
                    }

                });
            }else{
                if({$item_coupon_ids}.length >0){
                    // 领取礼包
                    $.post(
                        "{:url('api/bonus/grantBounusApi')}"
                        ,{'bonus_id': {$bonusInfo.id}}
                        ,function(msg){
                            if(msg.code == 200){
                                localStorage.setItem('isBonus',1);
                                mui.confirm('领取成功,查看获得的卡券?', '恭喜!', ['不,谢谢', '立即查看'], function (e) {
                                    if (e.index === 1) {
                                        
                                        window.location.href = "{:url('frontend/coupon/itemcouponlist')}";
                                    }
                                });
                            }else if(msg.code == 101){
                                localStorage.setItem('isBonus',1);
                                mui.toast(msg.msg);
                            }else{
                                mui.toast(msg.msg);
                            }   
                        }
                    );
                }
            }
        });
	})
</script>