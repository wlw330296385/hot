{extend name="layout/common"/}
{block name="page-content"}
<!--<div class="wrapper">-->
<div class="row col-lg-4 col-xs-12">
    <div class="box">
        <div id="platformInfo">
            <div class="box-header with-border">
                <h3 class="box-title">公众号详情</h3>
            </div>
            <div class="box-body">
                <table class="table table-striped table-bordered table-hover">
                    <tbody>
                    <tr>
                        <th>公众号名称</th>
                        <td>{$platformInfo.platform}</td>
                    </tr>
                    <tr>
                        <th>公司名称</th>
                        <td>{$platformInfo.company}</td>
                    </tr>
                    <tr>
                        <th>appsecret</th>
                        <td>{$platformInfo.appsecret}</td>
                    </tr>
                    <tr>
                        <th>appid</th>
                        <td>{$platformInfo.appid}</td>
                    </tr>
                    <tr>
                        <th>encodingaeskey</th>
                        <td>{$platformInfo.encodingaeskey}</td>
                    </tr>
                    <tr>
                        <th>mchid</th>
                        <td>{$platformInfo.mchid}</td>
                    </tr>
                    <tr>
                        <th>key</th>
                        <td>{$platformInfo.key}</td>
                    </tr>
                    <tr>
                        <th>sslcert_path</th>
                        <td>{$platformInfo.sslcert_path}</td>
                    </tr>
                    <tr>
                        <th>sslkey_path</th>
                        <td>{$platformInfo.sslkey_path}</td>
                    </tr>
                    <tr>
                        <th>sms_appid</th>
                        <td>{$platformInfo.sms_appid}</td>
                    </tr>
                    <tr>
                        <th>sms_secret</th>
                        <td>{$platformInfo.sms_secret}</td>
                    </tr>
                    <tr>
                        <th>账号名</th>
                        <td>{$platformInfo.username}</td>
                    </tr>
                    <tr>
                        <th>密码</th>
                        <td>{$platformInfo.password}</td>
                    </tr>
                    <tr>
                        <th>微信号授权</th>
                        <td>{$platformInfo.wechat}</td>
                    </tr>
                    <tr>
                        <th>备注</th>
                        <td>{$platformInfo.remarks}</td>
                    </tr>
                    <tr>
                        <th>状态</th>
                        <td>{$platformInfo.status}</td>
                    </tr>
                    <tr>
                        <th>创建时间</th>
                        <td>{$platformInfo.create_time}</td>
                    </tr>
                    <tr>
                        <th>更新时间</th>
                        <td>{$platformInfo.update_time}</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="box-footer">
                <button type="button" class="btn btn-info" id="goEdit" style="width: 100px; padding: 5px;">编 辑</button>
            </div>
        </div>

        <form role="form" action="" method="post" id="platformEdit" style="display: none;">
            <input type="hidden" name="id" value="{$platformInfo.id}">
            {:token()}
            <div class="box-body">
                <div class="form-group">
                    <label>公众号名称</label>
                    <input type="text" class="form-control" placeholder="请输入公众号名称" name="platform" value="{$platformInfo.platform}" required="required">
                </div>
                <div class="form-group">
                    <label>公司名称</label>
                    <input type="text" class="form-control" placeholder="请输入公司名称" name="company" value="{$platformInfo.company}" required="required">
                </div>
                <div class="form-group">
                    <label>appsecret</label>
                    <!-- Main content -->
                    <input type="text" class="form-control" placeholder="请输入appsecret" name="appsecret" value="{$platformInfo.appsecret}" required="required">
                </div>
                <div class="form-group">
                    <label>appid</label>
                    <!-- Main content -->
                    <input type="text" class="form-control" placeholder="请输入appid" name="appid" value="{$platformInfo.appid}" required="required">
                </div>
                <div class="form-group">
                    <label>encodingaeskey</label>
                    <!-- Main content -->
                    <input type="text" class="form-control" placeholder="请输入encodingaeskey" name="encodingaeskey" value="{$platformInfo.encodingaeskey}" required="required">
                </div>
                <div class="form-group">
                    <label>mchid</label>
                    <!-- Main content -->
                    <input type="text" class="form-control" placeholder="请输入mchid" name="mchid" value="{$platformInfo.mchid}" required="required">
                </div>
                <div class="form-group">
                    <label>key</label>
                    <!-- Main content -->
                    <input type="text" class="form-control" placeholder="请输入key" name="key" value="{$platformInfo.key}" required="required">
                </div>
                <div class="form-group">
                    <label>sslcert_path</label>
                    <!-- Main content -->
                    <input type="text" class="form-control" placeholder="请输入sslcert_path" name="sslcert_path" value="{$platformInfo.sslcert_path}" required="required">
                </div>
                <div class="form-group">
                    <label>sslkey_path</label>
                    <!-- Main content -->
                    <input type="text" class="form-control" placeholder="请输入sslkey_path" name="sslkey_path" value="{$platformInfo.sslkey_path}" required="required">
                </div>
                <div class="form-group">
                    <label>sms_appid</label>
                    <!-- Main content -->
                    <input type="text" class="form-control" placeholder="请输入sms_appid" name="sms_appid" value="{$platformInfo.sms_appid}" required="required">
                </div>
                <div class="form-group">
                    <label>sms_secret</label>
                    <!-- Main content -->
                    <input type="text" class="form-control" placeholder="请输入sms_secret" name="sms_secret" value="{$platformInfo.sms_secret}" required="required">
                </div>
                <div class="form-group">
                    <label>账号名</label>
                    <!-- Main content -->
                    <input type="text" class="form-control" placeholder="请输入账号名" name="username" value="{$platformInfo.username}" required="required">
                </div>
                <div class="form-group">
                    <label>密码</label>
                    <!-- Main content -->
                    <input type="text" class="form-control" placeholder="请输入密码" name="password" value="{$platformInfo.password}" required="required">
                </div>
                <div class="form-group">
                    <label>微信号授权</label>
                    <!-- Main content -->
                    <input type="text" class="form-control" placeholder="请输入微信号授权" name="wechat" value="{$platformInfo.wechat}" required="required">
                </div>
                <div class="form-group">
                    <label>备注</label>
                    <!-- Main content -->
                    <textarea class="textarea" name="remarks" placeholder="请输入备注..." value="{$platformInfo.remarks}" required="required"></textarea>
                </div>
                <div class="form-group">
                    <label>状态</label>
                    <select name="status">
                        <option value="1" selected="selected">正常</option>
                        <option value="-1">禁用</option>
                    </select>
                    <div style="float:right">创建时间：{$platformInfo.create_time} &nbsp;&nbsp; 更新时间：{$platformInfo.update_time}</div>
                </div>

            </div>

            <div class="box-footer">
                <button type="submit" class="btn btn-success" style="width: 100px; padding: 5px;">保  存</button>
                <button type="button" class="btn btn-default" style="width: 100px; padding: 5px;" id="backInfo">返  回</button>
            </div>
        </form>
    </div>
</div>

<div class="col-lg-8 col-xs-12">
    <div class="box">
        <div class="box-header with-border">
            <h3 class="box-title">模板消息对接列表</h3>
        </div>
        <div class="box-body">
            <table class="table table-striped table-bordered table-hover" id="templateList">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>模板名称</th>
                    <th>模板ID</th>
                    <th>备注</th>
                    <th width="100">操作</th>
                </tr>
                </thead>
                <tbody>
                {volist name='templateList' id="vol"}
                <tr class="t{$vol.id}">
                    <td>{$vol.id}</td>
                    <td><a href="{:url('admin/template/templatetemplateList', ['template_id' => $vol['id']])}" target="_blank">{$vol.template}</a></td>
                    <td class="t_id"></td>
                    <td class="remarks"></td>
                    <td><a href="#" class="btn btn-block edit" data-tp_id="" data-t_id="" data-remarks="" data-template_id="{$vol.id}" data-template="{$vol.template}" >编辑</a></td>
                </tr>
                {/volist}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!--</div>-->
<div class="clearfix"></div>

<div id="templateplatformList" style="display: none;">
    <ul>
        {volist name='templateplatformList' id="vol"}
        <li>
            <span class="tp_id">{$vol.id}</span>
            <span class="template_id">{$vol.template_id}</span>
            <span class="template">{$vol.template}</span>
            <span class="t_id">{$vol.t_id}</span>
            <span class="remarks">{$vol.remarks}</span>
        </li>
        {/volist}
    </ul>
</div>

{/block}
{block name='js'}
<!-- CK Editor -->
<script src="/static/plugins/ckeditor/ckeditor.js"></script>
<!-- Bootstrap WYSIHTML5 -->
<script src="/static/plugins/bootstrap-wysihtml5/bootstrap3-wysihtml5.all.min.js"></script>
<script>

    //全局变量，保存编辑前的数据,取消时使用
    var trOrg = '';

    $(function () {
        // Replace the <textarea id="editor1"> with a CKEditor
        // instance, using default configuration.
        CKEDITOR.replace('remarks',{ toolbarCanCollapse:true, toolbarStartupExpanded:false, height:120 });
        //bootstrap WYSIHTML5 - text editor
//    $(".textarea").wysihtml5();


        //设置默认项目
        $('select[name="status"] option[value="{$platformInfo.status}"]').prop("selected", true);


        //进入编辑状态
        $("#goEdit").on("click","", function () {
            $("#platformInfo").hide();
            $("#platformEdit").show();
        });

        //返回浏览状态
        $("#backInfo").on("click","", function () {
            $("#platformEdit").hide();
            $("#platformInfo").show();
        });

        var tID = "";
        $("#templateplatformList li").each(function () {
            tID = ".t"+$(this).find(".template_id").text();

            $(tID).find(".t_id").text($(this).find(".t_id").text());
            $(tID).find(".remarks").text($(this).find(".remarks").text());
            $(tID).find(".edit").attr("data-tp_id",$(this).find(".tp_id").text());
            $(tID).find(".edit").attr("data-t_id",$(this).find(".t_id").text());
            $(tID).find(".edit").attr("data-remarks",$(this).find(".remarks").text());
        });




        //激活编辑状态
        $("#templateList").on("click",".edit", function () {

            //判断是否有其他激活状态的数据，有则还原
            var isActive = $("#templateList tbody tr.active").length;
            if(isActive>0){
                $("#templateList tbody tr.active").empty().append(trOrg);
                $("#templateList tbody tr").removeClass("active");
            }

            //激活当前选中的行
            var tr = $(this).parentsUntil("tr").parent();
            tr.addClass("active");
            //保存原始数据
            trOrg = tr.html();

            var tp_id = $(this).attr("data-tp_id");
            var template_id = $(this).attr("data-template_id");
            var template = $(this).attr("data-template");
            var t_id = $(this).attr("data-t_id");
            var remarks = $(this).attr("data-remarks");
            var trStr = '';
            //拼接编辑表单
            trStr += '<td><input type="text" name="template_id" value="'+template_id+'" readonly="readonly"></td>';
            trStr += '<td><input type="text" name="template" value="'+template+'" readonly="readonly"></td>';
            trStr += '<td><input type="text" name="t_id" value="'+t_id+'"></td>';
            trStr += '<td><input type="text" name="remarks" value="'+remarks+'"></td>';
            trStr += '<td><input type="hidden" name="tp_id" value="'+tp_id+'"><input type="button" class="btn btn-block btn-success" id="saveEdit" value="保存"><input type="button" class="btn btn-block" id="cancelEdit" value="取消"></td>';

            tr.empty().append(trStr);

        });

        //取消编辑状态
        $("#templateList").on("click","#cancelEdit", function () {
            $("#templateList tbody tr.active").empty().append(trOrg);
            $("#templateList tbody tr").removeClass("active");
        });


        //保存编辑状态
        $("#templateList").on("click","#saveEdit", function () {

            var tr = $(this).parentsUntil("tr").parent();

            var platform_id = '{$platformInfo.id}';
            var platform = '{$platformInfo.platform}';
            var tp_id = tr.find('input[name="tp_id"]').val();
            var template_id = tr.find('input[name="template_id"]').val();
            var template = tr.find('input[name="template"]').val();
            var t_id = tr.find('input[name="t_id"]').val();
            var remarks = tr.find('input[name="remarks"]').val();
            var url = '';

            if(t_id==""||remarks==""){
                alert("请填写模板ID和备注！");
                return false;
            }

            //判断是添加还是编辑
            if(tp_id==""||tp_id==null){
                url = "{:url('admin/template/createTemplatePlatformApi')}";
            }else{
                url = "{:url('admin/template/updateTemplatePlatformApi')}"+"/template_plat_id/"+tp_id;
            }

            $.ajax({
                url: url,
                data: {
                    template_id: template_id,
                    template: template,
                    platform_id: platform_id,
                    platform: platform,
                    t_id: t_id,
                    remarks: remarks
                },
                dataType: 'json',//服务器返回json格式数据
                type: 'post',//HTTP请求类型
                timeout: 10000,//超时时间设置为10秒；
                headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
                //processData:false,
                success: function (data) {
                    if(data.code == 200) {
                        window.location.reload()
                    }else{
                        alert(data.msg);
                    }
                },
                error: function (xhr, type, errerThrown) {
                    alert('网络异常,请稍候再试');
                }
            });

        });


    });

</script>
{/block}


