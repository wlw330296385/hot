{extend name="layout/common"/}
{block name="page-content"}
<!--<div class="wrapper">-->
<div class="col-lg-4 col-xs-12">
    <div class="box">
        <div class="box-header with-border">
            <h3 class="box-title">模板消息详情</h3>
            <div class="box-tools"><a href="{:url('admin/template/updateTemplate', ['template_id' => $templateInfo.id])}" class="btn btn-block">编辑</a></div>
        </div>
        <div class="box-body">
            <table class="table table-striped table-bordered table-hover">
                <tbody>

                <tr>
                    <th width="100">ID</th>
                    <td>{$templateInfo.id}</td>
                </tr>
                <tr>
                    <th>模板名称</th>
                    <td>{$templateInfo.template}</td>
                </tr>
                <tr>
                    <th>模板编号</th>
                    <td>{$templateInfo.code}</td>
                </tr>
                <tr>
                    <th>内容示例</th>
                    <td>{$templateInfo.description}</td>
                </tr>
                <tr>
                    <th>应用场景</th>
                    <td>{$templateInfo.scene}</td>
                </tr>
                <tr>
                    <th>备注</th>
                    <td>{$templateInfo.remarks}</td>
                </tr>
                <tr>
                    <th>状态</th>
                    <td>{$templateInfo.status}</td>
                </tr>
                <tr>
                    <th>创建时间</th>
                    <td>{$templateInfo.create_time}</td>
                </tr>
                <tr>
                    <th>更新时间</th>
                    <td>{$templateInfo.update_time}</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
<div class="col-lg-8 col-xs-12">
    <div class="box">
        <div class="box-header with-border">
            <h3 class="box-title">公众号对接列表</h3>
        </div>
        <div class="box-body">
            <table class="table table-striped table-bordered table-hover" id="platformList">
                <thead>
                    <tr>
                        <th>机构ID</th>
                        <th>机构名称</th>
                        <th>模板ID</th>
                        <th>备注</th>
                        <th width="100">操作</th>
                    </tr>
                </thead>
                <tbody>
                {volist name='platformList' id="vol"}
                <tr>
                    <td>{$vol.id}</td>
                    <td>{$vol.platform}</td>
                    <td>{$vol.t_id}</td>
                    <td>{$vol.tp_remarks}</td>
                    <td><a href="#" class="btn btn-block edit" data-tp_id="{$vol.tp_id}" data-platform_id="{$vol.id}" data-platform="{$vol.platform}" data-t_id="{$vol.t_id}" data-remarks="{$vol.tp_remarks}" >编辑</a></td>
                </tr>
                {/volist}
                </tbody>
            </table>
        </div>
    </div>
</div>
<!--</div>-->


{/block}
{block name='js'}
<!-- JQ -->
<script src="/static/plugins/jQuery/jquery-2.2.3.min.js"></script>
<script>
    //全局变量，保存编辑前的数据,取消时使用
    var trOrg = '';

    $(function () {


        //激活编辑状态
        $("#platformList").on("click",".edit", function () {

            //判断是否有其他激活状态的数据，有则还原
            var isActive = $("#platformList tbody tr.active").length;
            if(isActive>0){
                $("#platformList tbody tr.active").empty().append(trOrg);
            }

            //激活当前选中的行
            var tr = $(this).parentsUntil("tr").parent();
            tr.addClass("active");
            //保存原始数据
            trOrg = tr.html();

            var tp_id = $(this).attr("data-tp_id");
            var platform_id = $(this).attr("data-platform_id");
            var platform = $(this).attr("data-platform");
            var t_id = $(this).attr("data-t_id");
            var remarks = $(this).attr("data-remarks");
            var trStr = '';
            //拼接编辑表单
            trStr += '<td><input type="text" name="platform_id" value="'+platform_id+'" readonly="readonly"></td>';
            trStr += '<td><input type="text" name="platform" value="'+platform+'" readonly="readonly"></td>';
            trStr += '<td><input type="text" name="t_id" value="'+t_id+'"></td>';
            trStr += '<td><input type="text" name="remarks" value="'+remarks+'"></td>';
            trStr += '<td><input type="hidden" name="tp_id" value="'+tp_id+'"><input type="button" class="btn btn-block btn-success" id="saveEdit" value="保存"><input type="button" class="btn btn-block" id="cancelEdit" value="取消"></td>';

            tr.empty().append(trStr);

        });

        //取消编辑状态
        $("#platformList").on("click","#cancelEdit", function () {
            $("#platformList tbody tr.active").empty().append(trOrg);
            $("#platformList tbody tr").removeClass("active");
        });


        //保存编辑状态
        $("#platformList").on("click","#saveEdit", function () {

            var tr = $(this).parentsUntil("tr").parent();

            var template_id = '{$templateInfo.id}';
            var template = '{$templateInfo.template}';
            var tp_id = tr.find('input[name="tp_id"]').val();
            var platform_id = tr.find('input[name="platform_id"]').val();
            var platform = tr.find('input[name="platform"]').val();
            var t_id = tr.find('input[name="t_id"]').val();
            var remarks = tr.find('input[name="remarks"]').val();
            var url = '';

            if(t_id==""||remarks==""){
                alert("请填写模板ID和备注！");
                return false;
            }

            //判断是添加还是编辑
            if(tp_id==""||tp_id==null){
                url = "{:url('admin/template/createTemplatePlatformApi')}";
            }else{
                url = "{:url('admin/template/updateTemplatePlatformApi')}"+"/template_plat_id/"+tp_id;
            }

            $.ajax({
                url: url,
                data: {
                    template_id: template_id,
                    template: template,
                    platform_id: platform_id,
                    platform: platform,
                    t_id: t_id,
                    remarks: remarks
                },
                dataType: 'json',//服务器返回json格式数据
                type: 'post',//HTTP请求类型
                timeout: 10000,//超时时间设置为10秒；
                headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
                //processData:false,
                success: function (data) {
                    if(data.code == 200) {
                        window.location.reload()
                    }else{
                        alert(data.msg);
                    }
                },
                error: function (xhr, type, errerThrown) {
                    alert('网络异常,请稍候再试');
                }
            });

        });

    });



</script>
{/block}


