{extend name="layout/common"/}
{block name="page-content"}
<!--<div class="wrapper">-->
<div class="row col-lg-6 col-xs-12">
    <div class="box">
        <div class="box-header with-border">
            <h3 class="box-title">选择主模板消息（可多选）</h3>
        </div>
        <table class="table table-striped table-bordered table-hover">
            <thead>
            <tr>
                <th><input type="checkbox" id="allCheckbox" /></th>
                <th>模板名称</th>
                <th>应用场景</th>
                <th>备注</th>
                <th>状态</th>
                <th>详情</th>
            </tr>
            </thead>
            <tbody>
            {volist name="templateList" id="vol"}
            <tr>
                <td><input type="checkbox" class="tBox" data-template="{$vol.template}" data-template_id="{$vol.template_id}" /></td>
                <td>{$vol.template}</td>
                <td>{$vol.scene}</td>
                <td>{$vol.remarks}</td>
                <td class="status" style="color:red">{if $vol.status == -1}已停用{/if}{if $vol.status == 1}已启用{/if}</td>
                <td>
                    <a href="{:url('admin/template/templatePlatform', ['template_id' => $vol['id']])}" class="btn btn-info">详情</a>
                </td>
            </tr>
            {/volist}
            </tbody>
        </table>
    </div>
</div>
<div class="row col-lg-6 col-xs-12">
    <div class="box">
        <div class="box-header with-border">
            <h3 class="box-title">添加机构模板消息</h3>
            <div class="box-tools"><a href="#" class="btn btn-block btn-info" data-toggle="modal" data-target="#campModal">选择机构</a></div>
        </div>
        <table class="table table-striped table-bordered table-hover" id="platformList">
            <thead>
                <tr>
                    <th></th>
                    <th>模板名称</th>
                    <th>机构ID</th>
                    <th>机构名称</th>
                    <th>模板ID</th>
                    <th>备注</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="box-footer">
            <button type="button" class="btn btn-success" id="submitBatch">提交批处理</button>
        </div>
    </div>
</div>
<!--</div>-->


<!-- Modal : Camp & AddForm -->
<div class="modal fade" id="campModal" tabindex="-1" role="dialog" aria-labelledby="campModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">请选择要添加的机构</h4>
            </div>
            <div class="modal-body">
                    <div class="input-group input-group-sm">
                        <input type="text" name="campKeyword" class="form-control campKeyword" placeholder="请输入机构名称...">
                        <span class="input-group-btn">
                          <button type="button" id="searchCampBtn" class="btn btn-default btn-flat"><i class="fa fa-search"></i> 搜索</button>
                        </span>
                    </div>
                    <div class="tableScroll">
                        <table id="campList" class="table table-bordered table-striped dataTable">
                            <thead>
                            <tr role="row">
                                <th>机构名称</th>
                                <th>所属地区</th>
                                <th>详情</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr role="row" class="nodata"><td colspan="4">请先搜索您要添加模板消息的机构</td></tr>
                            </tbody>
                        </table>
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>



</body>
{/block}
{block name='js'}
<!-- JQ -->
<script src="/static/plugins/jQuery/jquery-2.2.3.min.js"></script>
<script>


    $(function () {

        ////////////////////////////////////////////////////////////////////////机构模板关联表添加
        //搜索训练营
        $("#searchCampBtn").on("click", function () {
            var keyword = $(".campKeyword").val();
            if(keyword==""){
                alert("请输入机构名称！");
            }else{
                toCampList(keyword);
            }
        });

        $("#campList tbody").on("click",".btn", function () {
            var camp_id = $(this).attr("data-id");
            var camp = $(this).attr("data-camp");
            var template_id = '';
            var template = '';
            var tr = '';
            $(".tBox").each(function () {
                template_id = $(this).attr("data-template_id");
                template = $(this).attr("data-template");
                tr += '<tr data-template_id="'+template_id+'" data-template="'+template+'" data-platform_id="'+camp_id+'" data-platform="'+camp+'"><td></td><td>'+template+'</td><td>'+camp_id+'</td><td>'+camp+'</td><td><input type="text" name="t_id" placeholder="请输入模板ID..."></td><td><input type="text" name="remarks" placeholder="请输入备注..."></td></tr>';
            });
            $("#platformList tbody").empty().append(tr);

            $('#campModal').modal('hide');
        });


        var tPlatformList = [];

        $("#submitBatch").on("click","", function () {
            var pList = $("#platformList tbody").html();
            if(pList==""||pList==null){
                alert("请指定机构并填写模板ID和备注，谢谢！");
                return false;
            }
            var platform_id = '';
            var platform = '';
            var template_id = '';
            var template = '';
            var t_id = '';
            var remarks = '';
            var isPass = true;
            $("#platformList tbody tr").each(function (i) {
                template_id = $(this).attr("data-template_id");
                template = $(this).attr("data-template");
                platform_id = $(this).attr("data-platform_id");
                platform = $(this).attr("data-platform");
                t_id = $(this).find("input[name=t_id]").val();
                remarks = $(this).find("input[name=remarks]").val();
                //判断有无漏填信息
                if(t_id==""||remarks==""){
                    isPass = false;
                    alert("请填写完整模板ID和备注，谢谢！");
                    return false;
                }else{
                    tPlatformList[i] = { template_id: template_id, template: template, platform_id: platform_id, platform: platform, t_id: t_id, remarks: remarks};
                }
            });
            //最终判断没漏填就提交
            if(isPass==true){
                console.log(tPlatformList);
            }

            $('#campModal').modal('hide');
        });


    });


    //接口获取数据并追加到页面
    var toCampList = function (keyword) {
        //搜索关键字不能完全为空，否则查询为空
        var url = "{:url('api/camp/searchCampListAllApi','','',true)}";
        $.ajax({
            url: url,
            data: {
                status: 1,
                keyword: keyword
            },
            dataType: 'json',//服务器返回json格式数据
            type: 'post',//HTTP请求类型
            timeout: 10000,//超时时间设置为10秒；
            headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
            //processData:false,
            success: function (data) {
                var newli = '';
                if (data.code == 200) {
                    for (var i = 0; i <= data.data.length - 1; i++) {
                        var urls = "{:url('camp/campInfo')}" + '/camp_id/' + data.data[i].id;
                        newli += '<tr role="row" class="odd"><td>' + data.data[i].camp + '</td><td>' + data.data[i].city + '</td><td><a href="' + urls + '">查看详情</a></td><td><span class="btn btn-xs btn-info" data-camp="' + data.data[i].camp + '" data-id="' + data.data[i].id + '">确定</span></td></tr>';
                    }
                }
                if (newli == '') {
                    $("#campList tbody").html('<tr role="row" class="nodata"><td colspan="4">没有搜索到相关数据哦</td></tr>');
                }else{
                    $("#campList tbody").empty().append(newli);
                }


            },
            error: function (xhr, type, errerThrown) {
                alert('网络异常,请稍候再试');
            }
        });
    };

</script>
{/block}


