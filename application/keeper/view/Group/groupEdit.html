<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>编辑社群</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!--标准mui.css-->
    <link rel="stylesheet" href="/static/frontend/css/mui.min.css">
    <!--自定义style.css-->
    <link rel="stylesheet" type="text/css" href="/static/frontend/css/style.css" />
    <!--自定义多色图标icon.js-->
    <script src="/static/frontend/iconfont/iconfont.js"></script>
    <style>
        .borderStyle img {
            width: 70%;
        }

        .nav-list .nav-list-frame .navli {
            width: 20%;
            padding: 2px 0;
            border: 0;
        }
    </style>

</head>

<body>

    <header class="mui-bar mui-bar-nav subheader">
        <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left arrow"></a>
        <h1 class="mui-title">编辑社群</h1>
    </header>

    <div class="mui-content coach">

        <div class="nav-list borderStyle mb12">
            <ul class="mui-table-view mui-grid-view mui-grid-9 nav-list-frame ptb4">
                <li class="mui-table-view-cell navli memberList">
                    <a href="">
                        <p>
                            <i class="mui-icon mui-icon-plusempty" style="font-size: 2.7rem;border: 1px solid #ddd;"></i>
                        </p>
                    </a>
                </li>
                <li class="mui-table-view-cell navli">
                    <a href="#groupMember">
                        <p>
                            <i class="mui-icon mui-icon-minus" style="font-size: 2.7rem;border: 1px solid #ddd;"></i>
                        </p>
                    </a>
                </li>
            </ul>
        </div>

        <form action="" class="mui-input-group mt">
            <input type="hidden" class="data" name="group_id" value="{$groupInfo.id}">
            <div class="mui-input-row">
                <label>社群名称</label>
                <input type="text" name="group" class="data" value="{$groupInfo.group}" placeholder="社群名称">
            </div>
            <div class="mui-input-row h-auto">
                <a class="portraits filePicker mui-navigate-right" onclick="add_id(1)">
                    <label>社群Logo</label>
                    <img id="preview_1" class="upload-preview" src="{$groupInfo.logo}" alt="">
                    <input type="hidden" name="logo" value="{$groupInfo.logo}" class="data">
                </a>
            </div>
            <div class="mui-input-row">
                <div class="mui-navigate-right">
                    <label>社群类型</label>
                    <span class="select-row">
                        <select id="groupType" class="data" name="type">
                            <option value="">请选择</option>
                            <option value="1">单位</option>
                            <option value="2">球队</option>
                            <option value="3">同学</option>
                            <option value="4">朋友</option>
                            <option value="5">家族</option>
                            <option value="6">其他</option>
                        </select>
                    </span>
                </div>
            </div>
            <div class="mui-input-row">
                <label>最大人数</label>
                <input type="text" name="max" class="data" value="{$groupInfo.max}" placeholder="最大人数">
            </div>
            <div class="mui-input-row h-auto">
                <label>社群宗旨</label>
                <textarea name="tenet" rows="3" value="{$groupInfo.tenet}" class="tenet" placeholder="请填写内容">{$groupInfo.tenet}</textarea>
            </div>
            <div class="mui-input-row h-auto">
                <label>公告</label>
                <textarea name="notice" rows="3" value="{$groupInfo.notice}" class="notice" placeholder="请填写内容">{$groupInfo.notice}</textarea>
            </div>
        </form>

        <ul class="mui-table-view operation">
            <li class="mui-table-view-cell mui-col-xs-6 mui-col-sm-6 opli bgred deleteOut">
                删除并退出
            </li>
            <li class="mui-table-view-cell mui-col-xs-6 mui-col-sm-6 opli bggreen" onclick="submitAction()">
                保存修改
            </li>
        </ul>

    </div>


    <!--删除成员-->
    <div id="groupMember" class="mui-popover" style="margin: 0">
        <div class="mui-popover-arrow"></div>
        <div class="page-header">
            <span class="course wd45">
                <strong>社群成员</strong>
            </span>
            <span class="fr">
                <button class="mui-btn bgred" id="memberDel">删除</button>
            </span>
        </div>
        <div class="mui-scroll-wrapper" style="top:50px !important;">
            <div class="mui-scroll">
                <form class="mui-input-group delMemberList mb44"></form>
            </div>
        </div>
    </div>

    <script src="/static/frontend/js/mui.min.js"></script>
    <script src="/static/frontend/js/jquery-3.2.1.min.js"></script>
    <script src="/static/frontend/js/wooApi.js"></script>
    <script src="/static/frontend/js/common.js"></script>
    <script>
        mui(".mui-content").on("tap", "a", function () {
            window.top.location.href = this.href;
        });

        $(function () {
            var group_id = "{$groupInfo.id}";
            var member_id = "{$groupInfo.member_id}"
            // 设置社群类型默认值
            $('#groupType option[value="{$groupInfo.type}"]').prop("selected", true);

            //删除并退出
            // $(".deleteOut").on('tap', function () {
            //     mui.confirm("确认删除并退出社群吗？", "提示", function (e) {
            //         if (e.index == 1) {
            //             var group_id = "{$groupInfo.id}";
            //             var member_id = "{$groupInfo.member_id}"
            //             mui.ajax("{:url('api/group/dropGroup')}", {
            //                 data: {
            //                     group_id: group_id,
            //                     member_id: member_id
            //                 },
            //                 dataType: 'json',//服务器返回json格式数据
            //                 type: 'post',//HTTP请求类型
            //                 timeout: 10000,//超时时间设置为10秒；
            //                 headers: { 'Content-Type': 'application/json' },
            //                 success: function (data) {
            //                     console.log(data);
            //                     if (data.code == 200) {
            //                         mui.toast(data.msg);
            //                     } else {
            //                         mui.toast(data.msg);
            //                     }
            //                 },
            //                 error: function (xhr, type, errorThrown) {
            //                     //异常处理；
            //                     console.log(type);
            //                 }
            //             });
            //         }
            //     });
            // });

            $("#memberDel").on('tap', function () {
                var idList = [];
                var groupMember_id = ''
                $(".delMemberList input[type=checkbox]:checked").each(function (i) {
                    groupMember_id = $(this).val();
                    idList[i] = groupMember_id;
                })
                console.log(idList)
                mui.confirm("确认删除选中成员吗？", "提示", function (e) {
                    if (e.index == 1) {
                        mui.ajax("{:url('api/group/dropGroups')}", {
                            data: {
                                group_id: group_id,
                                idList: idList
                            },
                            dataType: 'json',//服务器返回json格式数据
                            type: 'post',//HTTP请求类型
                            timeout: 10000,//超时时间设置为10秒；
                            headers: { 'Content-Type': 'application/json' },
                            success: function (data) {
                                console.log(data);
                                if (data.code == 200) {
                                    mui.toast(data.msg);
                                } else {
                                    mui.toast(data.msg);
                                }
                            },
                            error: function (xhr, type, errorThrown) {
                                //异常处理；
                                console.log(type);
                            }
                        });
                    }
                });
            });

            groupMember();

        })

        //自定义列表
        function groupMember() {
            var url = "{:url('api/group/getGroupMemberListByPageApi','','',true)}";
            var group_id = "{$groupInfo.id}"
            mui.ajax({
                url: url,
                data: {
                    status: 1,
                    group_id: group_id
                },
                dataType: 'json',//服务器返回json格式数据
                type: 'post',//HTTP请求类型
                timeout: 10000,//超时时间设置为10秒；
                headers: { 'Content-Type': 'application/json' },
                success: function (data) {
                    console.log(data)
                    if (data.code == 200) {
                        var newli = '';
                        var div = '';
                        for (var i = 0; i <= data.data.data.length - 1; i++) {
                            newli += '<li class="mui-table-view-cell navli"><a href=""><img src="' + data.data.data[i].avatar + '" alt=""><p class="mui-ellipsis">' + data.data.data[i].member + '</p></a></li>'
                            div += '<div class="mui-input-row mui-checkbox mui-left"><label class="lineHeight20" style="width:85%">' + data.data.data[i].member + '</label><input name="checkbox1" value="' + data.data.data[i].id + '" data-member="' + data.data.data[i].member + '" type="checkbox"></div>';
                        }
                        $(".memberList").before(newli);
                        $(".delMemberList").append(div);
                    } else {
                        mui.toast('数据获取失败,请稍候再试');
                    }
                },
                error: function (xhr, type, errerThrown) {
                    mui.toast('网络异常,请稍候再试');
                }
            });
        };

        // 获取数据并进行提交
        function submitAction() {
            var data = wooApi.getInputData('input', 'data');
            datas = wooApi.getInputData('select', 'data', data);
            // 获取其他标签值
            arrData = wooApi.getDomData('domData', datas);
            var objData = wooApi.arrTOobj(arrData);
            objData.tenet = $(".tenet").val();
            objData.notice = $(".notice").val();
            var url = "{:url('api/group/updateGroupApi')}";
            var ajaxResult = wooApi.asyncF(url, objData);
            console.log(ajaxResult)
            if (ajaxResult.code == 200) {
                mui.alert(ajaxResult.msg, '修改成功', '确定', function () {
                    var goUrl = "{:url('group/groupInfo')}" + "/group_id/" + "{$groupInfo.id}";
                    window.top.location.href = goUrl;
                })
            } else {
                mui.alert(ajaxResult.msg, '修改失败');
                mui.get("{:url('api/frontend/reloadtoken')}", function (data) {
                    if (data.code === 200) {
                    }
                }, 'json');
            }
        };

    </script>
</body>

</html>