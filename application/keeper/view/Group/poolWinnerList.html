<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>擂主列表</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!--标准mui.css-->
    <link rel="stylesheet" href="/static/frontend/css/mui.min.css">
    <!--自定义style.css-->
    <link rel="stylesheet" type="text/css" href="/static/frontend/css/style.css" />
    <style>
        @media screen and (min-width: 320px) {
            #refreshContainer {
                margin-top: 246px !important;
            }
        }

        @media screen and (min-width: 360px) {
            #refreshContainer {
                margin-top: 260px !important;
            }
        }

        @media screen and (min-width: 375px) {
            #refreshContainer {
                margin-top: 264px !important;
            }
        }

        @media screen and (min-width: 411px) {
            #refreshContainer {
                margin-top: 274px !important;
            }
        }

        @media screen and (min-width: 414px) {
            #refreshContainer {
                margin-top: 275px !important;
            }
        }

        @media screen and (min-width: 768px) {
            #refreshContainer {
                margin-top: 386px !important;
            }
        }
        .mui-table-view-cell.mui-collapse .mui-table-view .mui-table-view-cell{
            padding-left: 37px;
        }
        .pool .avatar{
            float: right;
            margin-left: 8px;
            margin-top: 8px;
        }
        .pool a{
            padding-right: 35px !important;
        }
        .pool .avatar text{
            display: block;
            font-size: 11px;
        }
        .pool .avatar img {
            width: 45px !important;
            height: 45px !important;
            margin-top: 4px;
            border-radius: 50%;
        }
    </style>
</head>


<body>

    <header class="mui-bar mui-bar-transparent">
        <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
    </header>

    <div class="mui-content list">
        <div class="img4x3" style="background-image:url('/static/frontend/images/sport.jpg');padding-bottom: 31%"></div>
        <ul class="mui-table-view borderStyle" style="margin-top: 3px;">
            <li class="mui-table-view-cell listli" id="logoframe">
                <div class="mui-media-body  wd66">
                    <strong class="f16 tmName">{$groupInfo.group}</strong>
                    <img class="mui-media-object mui-pull-left logostyle" src="{$groupInfo.logo}" style="width:60px !important;height:60px !important;margin-top:5px">
                    <p class="mui-ellipsis lineHeight20">发起人：{$groupInfo.member}</p>
                    <p class="mui-ellipsis lineHeight20">成员:
                        <text class="colororange">{$groupInfo.members}</text>
                    </p>
                </div>
                <div class="price-frame" style="margin-top: 15px;">
                    <p class="f12">累计打卡
                        <text class="colororange f14 members">0</text>
                    </p>
                    <p class="f12">累计奖金
                        <text class="colororange f14  bonus">0</text>
                    </p>
                </div>
            </li>
        </ul>

        <ul class="mui-table-view mb">
            <li class="mui-table-view-cell listli">
                <label>
                    <span class="icon iconfont icon-activity-opponent colororange"></span>往届擂主
                </label>
                <span class="fr f14 colororange totalData">共0期</span>
            </li>
        </ul>

        <div id="refreshContainer" class="mui-scroll-wrapper">
            <div class="mui-scroll">
                <ul class="mui-table-view detalis-list list border-b pool"></ul>
            </div>
        </div>

    </div>

    <script src="/static/frontend/js/mui.min.js"></script>
    <script src="/static/frontend/js/jquery-3.2.1.min.js"></script>
    <script src="/static/frontend/js/wooApi.js"></script>
    <script>
        mui(".mui-content").on("tap", "a", function () {
            window.top.location.href = this.href;
        });

        $(function () {


            // 是否发布通知
            $(".pool").on("tap", 'a', function () {
                var listLi = $(this).parent();
                if (listLi.hasClass("mui-active")==false) {
                    $(this).find(".avatar").hide();
                } else {
                     $(this).find(".avatar").show();
                }
            });

            //初始化全局变量
            var count = 1;
            var teamId = wooApi.GetQueryString('team_id');
            mui.init({
                swipeBack: true, //启用右滑关闭功能
                pullRefresh: {
                    //下拉刷新上拉加载教练列表
                    container: "#refreshContainer",
                    down: {
                        //下拉刷新
                        height: 50,//可选.默认50.触发下拉刷新拖动距离
                        auto: true,//可选,默认false.自动下拉刷新一次
                        contentdown: "下拉可以刷新",//可选，在下拉可刷新状态时，下拉刷新控件上显示的标题内容
                        contentover: "释放立即刷新",//可选，在释放可刷新状态时，下拉刷新控件上显示的标题内容
                        contentrefresh: "正在刷新...",//可选，正在刷新状态时，下拉刷新控件上显示的标题内容
                        callback: pulldownRefresh
                    },
                    up: {
                        //上拉加载
                        height: 150,//可选.默认50.触发上拉加载拖动距离
                        //auto:true,//可选,默认false.自动上拉加载一次
                        contentrefresh: '正在加载...',
                        contentnomore: '没有更多数据了',//可选，请求完毕若没有更多数据时显示的提醒内容；
                        callback: pullupRefresh
                    }
                }
            });
            //下拉刷新具体业务实现
            function pulldownRefresh() {
                setTimeout(function () {
                    count = 1;//刷新并显示第一页
                    var page = count;
                    var gType = 1;//代表下拉刷新
                    toList(page, gType);//具体取数据的方法
                }, 100);
            }
            //上拉加载具体业务实现
            function pullupRefresh() {
                setTimeout(function () {
                    count++;//翻下一页
                    var page = count;
                    var gType = 2;//代表上拉加载
                    toList(page, gType);//具体取数据的方法
                }, 100);
            }

            //接口获取数据并追加到页面
            var toList = function (page, gType) {
                //搜索关键字不能完全为空，否则查询为空
                var url = "{:url('api/pool/getPoolListByPageApi','','',true)}" + '/?page=' + page;
                var group_id = "{$groupInfo.id}"
                mui.ajax({
                    url: url,
                    data: {
                        status: -1,
                        group_id: group_id
                    },
                    dataType: 'json',//服务器返回json格式数据
                    type: 'post',//HTTP请求类型
                    timeout: 10000,//超时时间设置为10秒；
                    headers: { 'Content-Type': 'application/json' },
                    success: function (msg) {
                        console.log(msg)
                        var newli = '';
                        var SumBonus = 0;
                        var SumMembers = 0;
                        if (msg.code == 200) {
                            let data = msg.data;
                            $(".totalData").text("共" + data.total + "期");
                            for (var i = 0; i <= data.data.length - 1; i++) {
                                SumBonus += parseInt(data.data[i].bonus)
                                SumMembers += parseInt(data.data[i].members)
                                $(".bonus").text(SumBonus);
                                $(".members").text(SumMembers);
                                var winner_list = JSON.parse(data.data[i].winner_list);
                         
                                let f_l = winner_list[0];//1
                                let s_l = winner_list[1];//2
                                let t_l = winner_list[2];//3
                                let f_l_s = '';
                                let s_l_s = '';
                                let t_l_s = '';
                                let sLi = '';
                                let tLi = '';
                                //第一名
                                for (var j = 0; j < f_l.length; j++) {
                                    //f_l_s += `${f_l[j].member}，`;
                                    f_l_s += `<div class="avatar"><img src="${f_l[j].avatar}" alt=""><text>${f_l[j].member}</text></div>`
                                    
                                }
                                //判断是否设置有第二名
                                if(data.data[i].second_scale>0){
                                    for (var j = 0; j < s_l.length; j++) {
                                        s_l_s += `<div class="avatar"><img src="${s_l[j].avatar}" alt=""><text>${s_l[j].member}</text></div>`
                                    }
                                    sLi = `<li class="mui-table-view-cell listli">
                                                        <label>
                                                            <span class="icon iconfont icon-th-data-a colororange"></span>第二名
                                                        </label>`
                                    if(s_l!=""){
                                        sLi+=`<span class="wd73">打卡次数：<text class="colororange">${s_l[0].punchs}</text>，获得奖金：<text class="colororange">${s_l[0].winner_bonus}</text><br />${s_l_s}</span>`
                                    }else{
                                        sLi+=` <span class="wd73">无</span>`
                                    }
                                    sLi+=`</li>`
                                }
                                //判断是否设置有第三名
                                if(data.data[i].third_scale>0){
                                    for (var j = 0; j < t_l.length; j++) {
                                        t_l_s += `<div class="avatar"><img src="${t_l[j].avatar}" alt=""><text>${t_l[j].member}</text></div>`
                                    }
                                    tLi = `<li class="mui-table-view-cell listli">
                                                        <label>
                                                            <span class="icon iconfont icon-th-data colororange"></span>第三名
                                                        </label>`
                                    if(t_l!=""){
                                        tLi+=` <span class="wd73">打卡次数：<text class="colororange">${t_l[0].punchs}</text>，获得奖金：<text class="colororange">${t_l[0].winner_bonus}</text><br />${t_l_s}</span>`
                                    }else{
                                        tLi+=` <span class="wd73">无</span>`
                                    }
                                    tLi+=`</li>`
                                }

                                //推算获取期数
                                let PoolNumber = data.total - (data.current_page-1)*data.per_page - i;

                                newli += `<li class="mui-table-view-cell mui-collapse listli">
                                            <a class="mui-navigate-right"  href="#">
                                                <label class="mui-ellipsis">第 ${PoolNumber} 期：${data.data[i].pool}</label>
                                                <div class="mui-pull-right">${f_l_s}</div>
                                            </a>
                                            <div class="mui-collapse-content">
                                                <ul class="mui-table-view mb list" style="margin-top:-8px;margin-left:-40px;">
                                                    <li class="mui-table-view-cell listli">
                                                        <label>
                                                            <span class="icon iconfont icon-p-game colororange"></span>擂主
                                                        </label>
                                                        <span class="wd73">打卡次数：<text class="colororange">${f_l[0].punchs}</text>，获得奖金：<text class="colororange">${f_l[0].winner_bonus}</text><br />${f_l_s}</span>
                                                    </li>`
                                                    +sLi+tLi+
                                                    `<li class="mui-table-view-cell listli">
                                                        <label>
                                                            <span class="icon iconfont icon-activity-Quantity colororange"></span>总打卡数
                                                        </label>
                                                        <span class="wd60">${data.data[i].members}</span>
                                                    </li>
                                                    <li class="mui-table-view-cell listli">
                                                        <label>
                                                            <span class="icon iconfont icon-activity-opponent colororange"></span>奖池总额（热币）
                                                        </label>
                                                        <span class="wd60">${data.data[i].bonus}</span>
                                                    </li>
                                                    <li class="mui-table-view-cell listli">
                                                        <label>
                                                            <span class="icon iconfont icon-activity-opponent colororange"></span>奖池余额（热币）
                                                        </label>
                                                        <span class="wd60">${data.data[i].mod}</span>
                                                    </li>
                                                    <li class="mui-table-view-cell listli">
                                                        <label>
                                                            <span class="icon iconfont icon-activity-opponent colororange"></span>单卡金额（热币）
                                                                </label>
                                                        <span class="wd60">${data.data[i].stake}</span>
                                                    </li>
                                                    <li class="mui-table-view-cell listli">
                                                        <label>
                                                            <span class="icon iconfont icon-activity-Startingtim colororange"></span>开始时间
                                                        </label>
                                                        <span class="wd60">${data.data[i].start}</span>
                                                    </li>
                                                    <li class="mui-table-view-cell listli">
                                                        <label>
                                                            <span class="icon iconfont icon-activity-EndTime colororange"></span>结束时间
                                                        </label>
                                                        <span class="wd60">${data.data[i].end}</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </li>`;
                            }
                        }
                        if (gType == 1) {
                            //上拉刷新
                            $("ul.pool").empty().append(newli);
                            mui('#refreshContainer').pullRefresh().endPulldownToRefresh();
                            mui('#refreshContainer').pullRefresh().refresh(true);
                            if (newli == '') {
                                $("ul.pool").html('<li class="nodata"><i class="icon iconfont icon-logo-Big"></i><p>没有相关数据哦</p></li>');
                            }
                        } else {
                            //下拉加载 gType==2
                            $("ul.pool").append(newli);
                        }
                        if (newli != '') {
                            mui('#refreshContainer').pullRefresh().endPullupToRefresh(false);
                        } else {
                            mui('#refreshContainer').pullRefresh().endPullupToRefresh(true);
                        }
                    },
                    error: function (xhr, type, errerThrown) {
                        mui.toast('网络异常,请稍候再试');
                        mui('#refreshContainer').pullRefresh().endPullupToRefresh(true);
                    }
                });
            };
        })
    </script>
</body>

</html>