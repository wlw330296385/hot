<!DOCTYPE html>
<html>
<head>
	<title>我的卡券</title>
	<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!--标准mui.css-->
    <link rel="stylesheet" href="/static/frontend/css/mui.min.css">
    <!--自定义style.css-->
    <link rel="stylesheet" type="text/css" href="/static/frontend/css/style.css"/>
	<link rel="stylesheet" type="text/css" href="/static/frontend/css/coupon.css" />
</head>
<body>


	<header id="header" class="mui-bar mui-bar-nav for-tab">
		<div class="camp-lesson-list">
			<div class="mui-segmented-control mb">
				<a class="mui-control-item mui-icon mui-icon-left-nav" href="{:url('member/index')}"></a>
				<a class="mui-control-item mui-active" href="#itemCouponList">礼品券</a>
			</div>
		</div>
	</header>

	<div class="mui-content">

		<div class="tab-pullRefresh">
			<div id="itemCouponList" class="mui-scroll-wrapper mui-control-content mui-active">
				<div class="mui-scroll" style="padding-top:15px;"></div>
			</div>
		</div>

	</div>

</body>
</html>
<script src="/static/frontend/js/mui.min.js"></script>
<script src="/static/frontend/js/jquery-3.2.1.min.js"></script>
<script src="/static/frontend/js/wooApi.js?v={:time()}"></script>

<script type="text/javascript">
	//初始化
    mui.init({
        swipeBack: true //启用右滑关闭功能
    });

    mui("body").on("tap", "a", function () {
        window.top.location.href = this.href;
    });

    $(function(){

    	$(document).on('tap','.useCard',function(){

    		var itemCouponID = $(this).attr("data-itemCouponID");
    		var itemCouponMemberID = $(this).attr("data-itemCouponMemberID");
    		var r = confirm('使用后不可在使用,确定使用吗?')
    		if(r===true){
	    		var objData = {
	    			item_coupon_id:itemCouponID,
	    			item_coupon_member_id : itemCouponMemberID
	    		}
	    		var ajaxResult = wooApi.asyncF("{:url('api/item_coupon/useItemCoupon')}", objData);
	    		if(ajaxResult.code == 200){
	    			$(this).attr("disabled", true);
	    			$(this).text('已使用');
	    			
	    		}
	    		mui.toast(ajaxResult.msg);    			
    		}
    	})

        //初始化全局变量
        var onItemCount = 1;

        mui('#itemCouponList').pullRefresh({
            down: {
                //下拉刷新
                height: 50,//可选.默认50.触发下拉刷新拖动距离
                auto: true,//可选,默认false.自动下拉刷新一次
                contentdown: "下拉可以刷新",//可选，在下拉可刷新状态时，下拉刷新控件上显示的标题内容
                contentover: "释放立即刷新",//可选，在释放可刷新状态时，下拉刷新控件上显示的标题内容
                contentrefresh: "正在刷新...",//可选，正在刷新状态时，下拉刷新控件上显示的标题内容
                callback: pulldownRefreshOn
            },
            up: {
                //上拉加载
                height: 150,//可选.默认50.触发上拉加载拖动距离
                //auto:true,//可选,默认false.自动上拉加载一次
                contentrefresh: '正在加载...',
                contentnomore: '没有更多数据了',//可选，请求完毕若没有更多数据时显示的提醒内容；
                callback: pullupRefreshOn
            }
        });

        //下拉刷新具体业务实现（上架）
        function pulldownRefreshOn() {
            setTimeout(function () {
                onItemCount = 1;//刷新并显示第一页
                var page = onItemCount;
                var gType = 1;//代表下拉刷新
                toItemCouponList('itemCouponList', page, gType);//具体取数据的方法
            }, 100);
        }

        //上拉加载具体业务实现（上架）
        function pullupRefreshOn() {
            setTimeout(function () {
                onItemCount++;//翻下一页
                var page = onItemCount;
                var gType = 2;//代表上拉加载
                toItemCouponList('itemCouponList', page, gType);//具体取数据的方法
            }, 100);
        }


    })

    //接口获取数据并追加到页面
    var toItemCouponList = function (wList, page, gType) {
        //搜索关键字不能完全为空，否则查询为空
        var url = "{:url('api/item_coupon/getItemCouponMemberListByPageApi','','',true)}" + '/?page=' + page;
        var memberID = "{$memberInfo.id}";
        mui.ajax({
            url: url,
            data: {
                member_id: memberID
            },
            dataType: 'json',//服务器返回json格式数据
            type: 'post',//HTTP请求类型
            timeout: 10000,//超时时间设置为10秒；
            headers: {'Content-Type': 'application/json'},
            //processData:false,
            success: function (data) {

                var newli = '';
                var btn = '';
                var currTimestamp = Date.parse(new Date());
                var startDate = '';
                var endDate = '';
                if (data.code == 200) {
                    for (var i = 0; i <= data.data.data.length - 1; i++) {

                        var urls = "{:url('frontend/Coupon/itemCouponInfo')}" + '/item_coupon_id/' + data.data.data[i].item_coupon.id;

                        startDate = data.data.data[i].item_coupon.start+' 00:00:00';
                        endDate = data.data.data[i].item_coupon.end+' 23:59:59';
                        startDate = new Date(Date.parse(startDate.replace(/-/g, "/")));
                        endDate = new Date(Date.parse(endDate.replace(/-/g, "/")));
                        startDate = startDate.getTime();
                        endDate = endDate.getTime();

                        if(data.data.data[i].price=='-1'){
                            btn = '<button type="button" class="mui-btn" disabled="true"  >已使用 </button>';
                        } else if(startDate>currTimestamp||endDate<currTimestamp) {
                            btn = '<button type="button" class="mui-btn"  disabled="true"  >无效期 </button>';
                        } else {
                            btn = '<button type="button" class="mui-btn bggreen useCard" data-itemCouponID="'+data.data.data[i].item_coupon.id+'"   data-itemCouponMemberID = "'+data.data.data[i].id+'"   >立即使用  </button>';
                        }
                        newli += '<div class="coupon"><div class="orangebg"><div class="cNum">' + data.data.data[i].item_coupon.price + '<span>元</span></div><div class="cFrom">' + data.data.data[i].item_coupon.organization + '</div><div class="cID">ID:' + data.data.data[i].coupon_number + '</div><div class="cName">' + data.data.data[i].item_coupon.coupon + '</div><div class="cDate">' + data.data.data[i].item_coupon.start +'至'+ data.data.data[i].item_coupon.end + '</div><i></i></div><div class="tips"><a href="'+urls+'">查看卡券详情<span class="mui-icon mui-icon-forward"></span></a>'+btn+'</div></div>'

                    }
                }
                if (gType == 1) {
                    //上拉刷新
                    $("#itemCouponList .mui-scroll").empty().append(newli);
                    mui('#' + wList).pullRefresh().endPulldownToRefresh();
                    mui('#' + wList).pullRefresh().refresh(true);
                    if (newli == '') {
                        $("#itemCouponList .mui-scroll").append('<li class="nodata"><p>没有相关数据哦</p></li>');
                    }
                } else {
                    //下拉加载 gType==2
                    $("#itemCouponList .mui-scroll").append(newli);
                }

                if (newli != '') {
                    mui('#' + wList).pullRefresh().endPullupToRefresh(false);
                } else {
                    mui('#' + wList).pullRefresh().endPullupToRefresh(true);
                }

            },
            error: function (xhr, type, errerThrown) {
                mui.toast('网络异常,请稍候再试');
                mui('#' + wList).pullRefresh().endPullupToRefresh(true);
            }
        });
    };

</script>