<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>快捷报名</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!--标准mui.css-->
    <link rel="stylesheet" href="/static/frontend/css/mui.min.css">
    <!--自定义style.css-->
    <link rel="stylesheet" type="text/css" href="/static/frontend/css/style.css" />
    <!--选择器样式-->
    <link href="/static/frontend/css/mui.picker.min.css" rel="stylesheet" />
    <link href="/static/frontend/css/mui.poppicker.css" rel="stylesheet" />
    <link href="/static/frontend/css/webuploader.css" rel="stylesheet">
    <style>
        .registerFrom {
            margin: 10px 25px 0px;
            background: none;
        }

        .registerFrom .mui-input-row {
            margin-top: 15px;
            background: #fff;
        }
       
    </style>
</head>

<body>

    <header class="mui-bar mui-bar-nav subheader">
        <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left arrow"></a>
        <h1 class="mui-title">联赛快捷报名</h1>
    </header>

    <div class="mui-content list">

        <ul class="mui-table-view mb" style="margin-top: -4px">
            <li class="mui-table-view-cell mui-media listli" style="padding:11px 15px;">
                <img class="img50 mui-pull-left" src="{$leagueInfo.logo}" style="width:60px !important;height:60px !important;margin-top:5px">
                <h4>{$leagueInfo.name}</h4>
                <div class="mui-media-body wd73" style="line-height:20px !important">
                    <p class="mui-ellipsis">主办单位：{$leagueInfo.match_org.name}</p>
                    <p>{$leagueInfo.city} {$leagueInfo.area} 参赛队：<strong class="colororange">{$leagueInfo.teams_count}</strong>支
                        | 关注：
                        <strong class="colororange">{$leagueInfo.fans_num}</strong></p>

                </div>
            </li>
        </ul>

        <form action="" class="mui-input-group registerFrom">
            <input type="hidden" name="__token__" class="data" value="{$Request.token}" />
            <input type="hidden" name="league_id" class="data" value="{$league_id}" />
            <input type="hidden" name="team_type" class="data" value="6" />
            <input type="hidden" name="province" class="data" value="" />
            <input type="hidden" name="city" class="data" value="" />
            <input type="hidden" name="area" class="data" value="" />

            <div class="mui-input-row">
                <label class="colororange">真实姓名</label>
                <input type="text" class="data" name="realname" value="" placeholder="真实姓名">
            </div>

            <div class="mui-input-row">
                <label class="colororange">联系电话</label>
                <input type="text" class="data telephone" name="telephone" value="" placeholder="联系电话">
            </div>

            <div class="mui-input-row smsValidate">
                <label class="colororange">短信验证码</label>
                <input type="button" class="code-btn" value="获取验证码" onclick="sendCode(this)" style="width: 30%;">
                <input id="code" type="text" name="smscode" class="input reg_code reg_validate data" placeholder="输入验证码"
                    style="width: 30%;">
            </div>

            <div class="mui-input-row ">
                <a class="mui-navigate-right">
                    <label class="colororange">性别</label>
                    <select name="sex" class="data" style="padding-right: 30px;">
                        <option value="1">男</option>
                        <option value="2">女</option>
                    </select>
                </a>
            </div>

            <div class="mui-input-row">
                <label class="colororange">球队名称</label>
                <input type="text" class="data" name="team" value="" placeholder="球队名称">
            </div>
            <div class="operation-box" style="padding: 15px">
                <div class="box" id="inactiveList"></div>
                <div class="operation-btn">
                    <span class="mui-badge">0</span>
                    <a class="all">全选</a>
                    <a class="cancel">取消</a>
                    <a class="del">[删除]</a>
                    <span class="colorblue fr" id="addTeammember">添加队员</span>
                </div>
            </div>

        </form>


        <ul class="mui-table-view operation">
            <li class="mui-table-view-cell mui-col-xs-12 opli bggreen" onclick="submitAction()">
                报名联赛
            </li>
        </ul>

    </div>

    <script src="/static/frontend/js/mui.min.js"></script>
    <script src="/static/frontend/js/jquery-3.2.1.min.js"></script>
    <script src="/static/frontend/js/common.js"></script>
    <script src="/static/frontend/js/wooApi.js"></script>
    <script src="/static/frontend/js/smsCode.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>

    <script>
        //初始化
        mui.init({
            swipeBack: true //启用右滑关闭功能
        });

        console.log($("input[name=__token__]").val())

        var leagueId = wooApi.GetQueryString('league_id');
        if ("{$memberInfo.id}" != 0) {
            mui.alert("你已是平台会员，前往报名联赛。", function () {
                window.location.href = "{:url('match/signupleague')}" + "/league_id/" + leagueId
            });
        }

        //获取定位省市区
        var getLocationTB = getLocationApi("{:url('api/Location/getLocation')}");
        var gCity = getLocationTB['city'];
        var gProvince = getLocationTB['province'];
        var gArea = getLocationTB['area'];
        if (gCity == null || gCity == "undefined") {
            gCity = "";
        }
        if (gProvince == null || gProvince == "undefined") {
            gProvince = "";
        }
        if (gArea == null || gArea == "undefined") {
            gArea = "";
        }
        $("input[name=province]").val(gProvince);
        $("input[name=city]").val(gCity);
        $("input[name=area]").val(gArea);


        //定义全局变量
        var flagPhone = false;
        var flagMember = false;
        var flagCreate = true;

        // 验证会员名是否存在
        $("input[name='realname']").on("blur", function () {
            var member = $.trim($(this).val());
            $(this).val(member);

            //判断会员名格式
            if (((/\s/).test(member)) === true) {
                flagMember = false;
                mui.alert("真实姓名不许有空格");
                return false;
            } else if ((/^[\u4E00-\u9FA5A-Za-z0-9_]{2,15}$/).test(member) === false) {
                flagMember = false;
                mui.alert("姓名只能包含英文或中文，长度为2-15位");
                return false;
            }

            // 赋值球队创建者名单
            var str =
                ` <div class="mui-input-row mui-checkbox checkboxCont" style="margin-top:0">
                        <label class="number" style="width:15%">1</label>
                        <span class="fr">领队</span>
                        <input type="text" name="teamMember" data-teamMember_id="" value="${member}" class="mui-text-left fr" style="padding-right:60px;width:51%" /> 
                    </div>`
            $("#inactiveList").empty().append(str)
        });


        //验证是否注册的手机号
        $('.telephone').on("blur", function () {
            var telephone = $(this).val();
            if (telephone != '') {
                if (!(/^1[34578]\d{9}$/).test(telephone)) {
                    //判断手机号码格式是否正确
                    mui.toast("请填写正确的手机格式");
                    flagPhone = false;
                    return false;
                } else {
                    //判断是否已经注册的会员手机号
                    mui.ajax("{:url('api/login/isFieldRegisterApi')}", {
                        data: {
                            'field': 'telephone',
                            'value': telephone
                        },
                        dataType: 'json', //服务器返回json格式数据
                        type: 'post', //HTTP请求类型
                        async: false,
                        timeout: 10000, //超时时间设置为10秒；
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        success: function (data) {
                            console.log(data);
                            //判断该手机号码是否已经是注册会员
                            if (data.msg == 1) {
                                mui.alert("该手机号码是本平台已注册会员、请重新填写。");
                                flagPhone = false;
                            } else {
                                flagPhone = true;
                            }
                        },
                        error: function (xhr, type, errorThrown) {
                            console.log(type);
                        }
                    });
                }
            }
        });


        //全选
        $(".all").click(function () {
            $(this).parents().siblings().find('.checkboxCont input').prop('checked', true)
        })

        //取消全选
        $(".cancel").click(function () {
            $(this).parents().siblings().find('.checkboxCont input').prop('checked', false)
        })

        //删除
        $(document).on('click', '.del', function () {
            $(this).parents().siblings().find("input[name='member']:checked").parents(
                ".checkboxCont").remove();
            changeIndex();
            totalNum = $("#inactiveList .checkboxCont").length;
            $(".mui-badge").text(totalNum);
        });

        //点击添加队员
        $("#addTeammember").on("tap", function () {
            var str =
                ` <div class="mui-input-row mui-checkbox checkboxCont" style="margin-top:0">
                        <label class="number" style="width:15%"></label>
                        <input type="text" name="teamMember" data-teamMember_id="-1" value=""  placeholder="队员名称" class="mui-text-left" style="padding-right:60px;" /> 
                        <input type="checkbox" name="member" value="">
                    </div>`
            $("#inactiveList").append(str)
            changeIndex(); //调用-更新序号
            totalNum = $("#inactiveList .checkboxCont").length;
            $(".mui-badge").text(totalNum);
        });

        // 发送短信验证码
        function sendCode(obj) {
            var telephone = $(".telephone").val();
            var telephoneReg = /^1[34578]\d{9}$/;
            if (!telephoneReg.test(telephone)) {
                mui.toast('请填写正确的手机号码');
            } else {
                var result = smsCode.getMobileCodeApi(obj, telephone, "{:url('api/sms/getMobileCodeApi','','',true)}");
                if (result.code == 200) {
                    mui.toast(result.msg);
                } else {
                    mui.toast(result.msg);

                }
            }
        }

        //更新序号
        function changeIndex() {
            var i = 1;
            $("#inactiveList .checkboxCont").each(function () { //循环checkboxCont
                $(this).find("label").text(i++); //更新序号
            });
        }
        var team_member_list = ''
        // 获取数据并进行提交
        function submitAction() {
            var realname = $("input[name=realname]").val();
            var telephone = $("input[name=telephone]").val();
            var team = $("input[name=team]").val();

            if (realname == '') {
                mui.toast("请填写真实姓名");
                return false;
            }
            if (telephone == '') {
                mui.toast("请填写联系电话");
                return false;
            }
            if (team == '') {
                mui.toast("请填写球队名称");
                return false;
            }

            if (flagPhone == false) {
                mui.toast("提交失败，手机号填写有误，请重新填写");
                return false;
            };


            team_member_list = [];
            $("#inactiveList .checkboxCont").each(function () {
                var realname = $(this).find("input[name=teamMember]").val();
                team_member_list.push({
                    realname: realname,
                });
            });
            console.log(team_member_list)

            var data = wooApi.getInputData('input', 'data');
            datas = wooApi.getInputData('select', 'data', data);
            // 获取其他标签值
            arrData = wooApi.getDomData('domData', datas);
            var objData = wooApi.arrTOobj(arrData);
            objData.team_member_list = JSON.stringify(team_member_list);
            var url = "{:url('api/Shortcut/leaderApplyLeagueTeam')}";
            var ajaxResult = wooApi.asyncF(url, objData);
            if (ajaxResult.code == 200) {
                mui.alert(ajaxResult.msg, '报名成功', '确定', function () {
                    var goUrl = "{:url('match/leagueInfo')}" + '/league_id/' + "{$league_id}";
                    window.top.location.href = goUrl;
                })
            } else {
                mui.alert(ajaxResult.msg, '报名失败');
                mui.get("{:url('api/frontend/reloadtoken')}", function (data) {
                    if (data.code === 200) {
                        $('input[name=__token__]').val(data.data);
                    }
                }, 'json');
            }

        };
    </script>


</body>

</html>