<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>快捷报名</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!--标准mui.css-->
    <link rel="stylesheet" href="/static/frontend/css/mui.min.css">
    <!--自定义style.css-->
    <link rel="stylesheet" type="text/css" href="/static/frontend/css/style.css" />
    <!--选择器样式-->
    <link href="/static/frontend/css/mui.picker.min.css" rel="stylesheet" />
    <link href="/static/frontend/css/mui.poppicker.css" rel="stylesheet" />
    <link href="/static/frontend/css/webuploader.css" rel="stylesheet">
    <style>
        .tipContent {
            margin: 25px 28px 0 28px;
            line-height: 54px;
            vertical-align: middle;
        }

        .tipContent .tipContentText p {
            line-height: 20px;
            color: #666;
        }

        .registerFrom {
            margin: 10px 25px 0px;
            background: none;
        }

        .registerFrom .mui-input-row {
            margin-top: 15px;
            background: #fff;
        }

        .tipBottom {
            margin: 30px;
            text-align: center;
        }
        .tipBottom p.f12 {
            color: #999;
            font-size: 12px;
        }
        #eventDes {
            margin-top: 0;
            display: none;
        }
        #showSuccess {
            display: none;
            padding: 20px;
            text-align: center;
            background-color: #FF9900;
        }
        #showSuccess h4,#showSuccess p{
            color:#FFF;
        }
        .nobg {
            background: transparent !important;
        }
        .nobg::after {
            background: none !important;
        }
        .selectTotal, .selectDom{
            padding: 5px 8px !important;
        }
    </style>
</head>

<body>

    <header class="mui-bar mui-bar-nav subheader">
        <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left arrow"></a>
        <h1 class="mui-title">联赛报名</h1>
    </header>

    <div class="mui-content">

        <form action="" class="mui-input-group registerFrom">
            <input type="hidden" name="__token__" class="data" value="{$Request.token}" />
            <input type="hidden" name="member" class="data" value="{$memberInfo.nickname}" />
            <input type="hidden" name="match" class="data" value="" />
            <input type="hidden" name="match_id" class="data" value="" />

            <div class="mui-input-row">
                <label class="colororange">真实姓名</label>
                <input type="text" class="data" name="realname" value="" placeholder="真实姓名">
            </div>

            <div class="mui-input-row">
                <label class="colororange">联系电话</label>
                <input type="text" class="data telephone" name="telephone" value="" placeholder="联系电话">
            </div>

            <div class="mui-input-row smsValidate">
                <label class="colororange">短信验证码</label>
                <input type="button" class="code-btn" value="获取验证码" onclick="sendCode(this)" style="width: 30%;">
                <input id="code" type="text" class="input reg_code reg_validate" placeholder="输入验证码" style="width: 30%;">
            </div>

            <div class="mui-input-row ">
                <a class="mui-navigate-right">
                    <label class="colororange">性别</label>
                    <select name="sexSelect" style="padding-right: 30px;">
                        <option value="男">男</option>
                        <option value="女">女</option>
                    </select>
                </a>
                <input type="hidden" name="sex" value="男">
            </div>

            <div class="mui-input-row">
                <label class="colororange">球队名称</label>
                <input type="text" class="data" name="team" value="" placeholder="球队名称">
            </div>
            <div class="operation-box" style="padding: 15px">
                <div class="box" id="inactiveList"></div>
                <div class="operation-btn">
                    <span class="mui-badge">0</span>
                    <a class="all">全选</a>
                    <a class="cancel">取消</a>
                    <a class="del">[删除]</a>
                    <span class="colorblue fr" id="addTeammember">添加队员</span>
                </div>
            </div>

            <div class="mui-input-row">
                <label class="colororange">当前联赛</label>
                <span>联赛名</span>
            </div>

        </form>

        <ul class="mui-table-view operation">
            <li class="mui-table-view-cell mui-col-xs-12 opli bggreen" onclick="submitAction()">
                报名联赛
            </li>
        </ul>

    </div>

    <script src="/static/frontend/js/mui.min.js"></script>
    <script src="/static/frontend/js/jquery-3.2.1.min.js"></script>
    <script src="/static/frontend/js/common.js"></script>
    <script src="/static/frontend/js/wooApi.js"></script>
    <script src="/static/frontend/js/smsCode.js"></script>

    <script>
        //初始化
        mui.init({
            swipeBack: true //启用右滑关闭功能
        });

        //定义全局变量
        var flagPhone = false;
        var flagSMS = false;
        var flagMember = false;
        var flagCreate = true;


        // 验证会员名是否存在
        $("input[name='realname']").on("blur", function () {
            var member = $.trim($(this).val());
            $(this).val(member);

            //判断会员名格式
            if (((/\s/).test(member)) === true) {
                flagMember = false;
                mui.alert("会员名不许有空格");
                return false;
            } else if ((/^[\u4E00-\u9FA5A-Za-z0-9_]{2,15}$/).test(member) === false) {
                flagMember = false;
                mui.alert("会员名只能包含英文、数字或中文，长度为2-15位");
                return false;
            }

            //判断用户名是否存在
            mui.ajax("{:url('api/login/isFieldRegisterApi')}", {
                data: {
                    'field': 'member',
                    'value': member
                },
                dataType: 'json', //服务器返回json格式数据
                type: 'post', //HTTP请求类型
                timeout: 10000, //超时时间设置为10秒；
                headers: {
                    'Content-Type': 'application/json'
                },
                success: function (data) {
                    console.log(data);
                    if (data.msg == 1) {
                        flagMember = false;
                        mui.alert("该会员名称已经存在，请使用其他名称！");
                        $("input[name=realname]").val("")
                        return false;
                    } else {
                        flagMember = true;
                    }
                },
                error: function (xhr, type, errorThrown) {
                    console.log(type);
                }
            });

            // 赋值球队创建者名单
            var str =
                ` <div class="mui-input-row mui-checkbox checkboxCont" style="margin-top:0">
                        <label class="number" style="width:15%">1</label>
                        <span class="fr">队长</span>
                        <input type="text" name="teamMember" data-teamMember_id="" value="${member}" class="mui-text-left fr" style="padding-right:60px;width:51%" /> 
                    </div>`
            $("#inactiveList").empty().append(str)
        });


        //验证是否注册的手机号
        $('.telephone').on("blur", function () {
            var telephone = $(this).val();
            if (telephone != '') {
                if (!(/^1[34578]\d{9}$/).test(telephone)) {
                    //判断手机号码格式是否正确
                    mui.toast("请填写正确的手机格式");
                    flagPhone = false;
                    return false;
                } else {
                    //判断是否已经注册的会员手机号
                    mui.ajax("{:url('api/login/isFieldRegisterApi')}", {
                        data: {
                            'field': 'telephone',
                            'value': telephone
                        },
                        dataType: 'json', //服务器返回json格式数据
                        type: 'post', //HTTP请求类型
                        async: false,
                        timeout: 10000, //超时时间设置为10秒；
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        success: function (data) {
                            console.log(data);
                            //判断该手机号码是否已经是注册会员
                            if (data.msg == 1) {
                                mui.alert("该手机号码是本平台已注册会员、请重新填写。");
                                flagPhone = false;
                            } else {
                                flagPhone = true;
                            }
                        },
                        error: function (xhr, type, errorThrown) {
                            console.log(type);
                        }
                    });
                }
            }
        });



        //验证短信验证码
        $('#code').on("blur", function () {
            var code = document.getElementById('code').value;
            var codeReg = /^\d{6,6}$/;
            if (!codeReg.test(code)) {
                mui.toast('请填写正确的验证码');
                flagSMS = false;
            } else {
                var telephone = $(".telephone").val();
                var result = smsCode.validateSmsCodeApi(telephone, code,
                    "{:url('api/sms/validateSmsCodeApi','','',true)}");
                if (result.code == 200) {
                    flagSMS = true;
                    mui.toast(result.msg);
                } else {
                    flagSMS = false;
                    mui.toast(result.msg);
                }
            }
        });

        //全选
        $(".all").click(function () {
            $(this).parents().siblings().find('.checkboxCont input').prop('checked', true)
        })

        //取消全选
        $(".cancel").click(function () {
            $(this).parents().siblings().find('.checkboxCont input').prop('checked', false)
        })

        //删除
        $(document).on('click', '.del', function () {
            $(this).parents().siblings().find("input[name='member']:checked").parents(
                ".checkboxCont").remove();
            changeIndex();
            totalNum = $("#inactiveList .checkboxCont").length;
            $(".mui-badge").text(totalNum);
        });

        //点击添加队员
        $("#addTeammember").on("tap", function () {
            var str =
                ` <div class="mui-input-row mui-checkbox checkboxCont" style="margin-top:0">
                        <label class="number" style="width:15%"></label>
                        <input type="text" name="teamMember" data-teamMember_id="-1" value=""  placeholder="队员名称" class="mui-text-left" style="padding-right:60px;" /> 
                        <input type="checkbox" name="member" value="">
                    </div>`
            $("#inactiveList").append(str)
            changeIndex(); //调用-更新序号
            totalNum = $("#inactiveList .checkboxCont").length;
            $(".mui-badge").text(totalNum);
        });

        // 发送短信验证码
        function sendCode(obj) {
            var telephone = $(".telephone").val();
            var telephoneReg = /^1[34578]\d{9}$/;
            if (!telephoneReg.test(telephone)) {
                mui.toast('请填写正确的手机号码');
            } else {
                var result = smsCode.getMobileCodeApi(obj, telephone, "{:url('api/sms/getMobileCodeApi','','',true)}");
                if (result.code == 200) {
                    mui.toast(result.msg);
                } else {
                    mui.toast(result.msg);

                }
            }
        }

        //更新序号
        function changeIndex() {
            var i = 1;
            $("#inactiveList .checkboxCont").each(function () { //循环checkboxCont
                $(this).find("label").text(i++); //更新序号
            });
        }
        var teamMemberList = ''
        // 获取数据并进行提交
        function submitAction() {
            var realname = $("input[name=realname]").val();
            var telephone = $("input[name=telephone]").val();
            var team = $("input[name=team]").val();

            if (realname == '') {
                mui.toast("请填写真实姓名");
                return false;
            }
            if (telephone == '') {
                mui.toast("请填写联系电话");
                return false;
            }
            if (team == '') {
                mui.toast("请填写球队名称");
                return false;
            }

            // if (flagMember == false) {
            //     mui.toast("提交失败，会员名填写有误，请重新填写！");
            //     return false;
            // };
            // if (flagPhone == false) {
            //     mui.toast("提交失败，手机号填写有误，请重新填写");
            //     return false;
            // };
            // if (flagSMS == false) {
            //     mui.toast("提交失败，验证码填写有误");
            //     return false;
            // };

            teamMemberList = [];
            $("#inactiveList input[name=teamMember]").each(function () {
                teamMember_id = $(this).attr("data-teamMember_id");
                teamMember = $(this).val();
                teamMemberList.push({
                    teamMember: teamMember,
                    teamMember_id: teamMember_id,
                });
            });
            console.log(teamMemberList)

            //如已经通过以上验证则创建会员账号
            // mui.ajax("{:url('api/login/registerApi')}", {
            //     data: {
            //         member: member,
            //         telephone: telephone,
            //         __token__: token,
            //     },
            //     dataType: 'json', //服务器返回json格式数据
            //     type: 'post', //HTTP请求类型
            //     async: false,
            //     timeout: 10000, //超时时间设置为10秒；
            //     headers: {
            //         'Content-Type': 'application/json'
            //     },
            //     success: function (data) {
            //         //服务器返回响应，根据响应结果，分析是否登录成功；
            //         console.log(data);
            //         if (data.code == 100) {
            //             flagCreate = false;
            //             mui.alert(data.msg, '提交失败', '确定', function () {
            //                 mui.get("{:url('api/frontend/reloadtoken')}", function (data) {
            //                     if (data.code === 200) {
            //                         $('input[name=__token__]').val(data.data);
            //                     }
            //                 }, 'json');
            //             })
            //         } else {
            //             flagCreate = true;
            //             $("input[name='member_id']").val(data.id)
            //             mui.toast("提交中...");
            //         }
            //     },
            //     error: function (xhr, type, errorThrown) {
            //         //异常处理；
            //         flagCreate = false;
            //         console.log(type);
            //     }
            // });

        };
    </script>


</body>

</html>