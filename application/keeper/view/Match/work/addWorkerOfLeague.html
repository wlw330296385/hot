<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>添加联赛工作人员</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!--标准mui.css-->
    <link rel="stylesheet" href="/static/frontend/css/mui.min.css">
    <!--自定义style.css-->
    <link rel="stylesheet" type="text/css" href="/static/frontend/css/style.css" />
    <!--选择器样式-->
    <link href="/static/frontend/css/mui.picker.min.css" rel="stylesheet" />
    <link href="/static/frontend/css/mui.poppicker.css" rel="stylesheet" />
</head>

<body class=whitebg>

    <header class="mui-bar mui-bar-nav search2">
        <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
        <h1 class="mui-title">
            <input type="search" class="mui-input-clear keyword" placeholder="请输入会员名称或手机号">
        </h1>
        <span class="mui-icon mui-icon-search searchicon" id="searchBtn"></span>
    </header>

    <div class="mui-content coach">
        <div id="refreshContainer" class="mui-scroll-wrapper" style="margin-top: 44px">
            <div class="mui-scroll">
                <ul class="mui-table-view detalis-list list border-b memberList">
                    <li class="nodata">
                        <i class="icon iconfont icon-logo-Big"></i>
                        <p>请搜索你要邀请的会员名称</p>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 工作人员角色popover -->
    <div id="typePopover" class="mui-popover">
        <div class="mui-popover-arrow"></div>
        <div class="page-header">
            <span class="course">
                <strong>请选择邀请成为的角色</strong>
            </span>
            <span class="fr">
                <button class="mui-btn-blue" id="typeConfirm">确认</button>
            </span>
        </div>
        <div class="mui-scroll-wrapper">
            <div class="mui-scroll">
                <form class="mui-input-group typeList">
                    {volist name="types" id="vo"}
                    <div class="mui-input-row mui-checkbox mui-left">
                        <label>{$vo}</label>
                        <input type="checkbox" name="type" value="{$vo}" data-type="{$key}">
                    </div>
                    {/volist}
                </form>
            </div>
        </div>
    </div>

    <script src="/static/frontend/js/mui.min.js"></script>
    <script src="/static/frontend/js/jquery-3.2.1.min.js"></script>
    <!-- 选择器 -->
    <script src="/static/frontend/js/mui.picker.min.js"></script>
    <script src="/static/frontend/js/mui.poppicker.js"></script>
    <script src="/static/frontend/js/wooApi.js"></script>
    <script src="/static/frontend/js/common.js"></script>
    <script>
        mui(".mui-content").on("tap", "a", function () {
            window.top.location.href = this.href;
        });

        //弹出框滚动必须写在mui专用的初始化
        (function ($) {
            $(".mui-scroll-wrapper").scroll({
                //bounce: false,//滚动条是否有弹力默认是true
                indicators: true //是否显示滚动条,默认是true
            });
            // 关闭弹出菜单
            $("body").on('tap', '.mui-backdrop', function () {
                mui(".mui-popover.mui-active").popover("toggle");
            })
        })(mui);

        $(function () {

            //初始化全局变量
            var count = 1;
            var keyword = wooApi.GetQueryString('keyword');
            $('.keyword').val(keyword);

            //搜索活动
            $("#searchBtn").on("tap", function () {
                keyword = $(".keyword").val();
                if (keyword != '') {
                    toList();
                } else {
                    mui.toast("请输入你要搜索的会员");
                    return false;
                }
            })

            // 检查是否已发送|是否存在
            $(document).on("tap", ".typePo", function () {
                var member_id = $(this).attr("data-member_id");
                var match_id = "{$leagueInfo.id}";
                mui.ajax("{:url('api/league/checkmatchmember')}", {
                    data: {
                        match_id: match_id,
                        member_id: member_id
                    },
                    dataType: 'json', //服务器返回json格式数据
                    type: 'post', //HTTP请求类型
                    timeout: 10000, //超时时间设置为10秒；
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    success: function (data) {
                        console.log(data);
                        if (data.code == 200) {
                            var btnArray = ['取消', '确认'];
                            mui.confirm('已发送邀请，是否再次邀请？', '', btnArray, function (e) {
                                if (e.index == 1) {
                                    $('#typePopover').attr('data-memberid',
                                        member_id).attr('data-matchid',
                                        match_id);
                                }
                            });
                        } else {
                            $('#typePopover').attr('data-memberid', member_id).attr(
                                'data-matchid', match_id);
                        }
                    },
                    error: function (xhr, type, errorThrown) {
                        //异常处理；
                        console.log(type);
                    }
                });
            })

            // 工作人员角色popover点击绑定
            $("#typeConfirm").on('tap', '', function () {
                var match_id = $('#typePopover').attr('data-matchid');
                var member_id = $('#typePopover').attr('data-memberid');
                var typeData = []
                $(".typeList input[type=checkbox]:checked").each(function () {
                    var type = $(this).val();
                    var type_num = $(this).attr("data-type");
                    typeData.push({
                        type,
                        type_num
                    });
                });
                console.log(typeData)
                mui.ajax("{:url('api/league/invitematchmebmer')}", {
                    data: {
                        match_id: match_id,
                        member_id: member_id,
                        type: typeData
                    },
                    dataType: 'json', //服务器返回json格式数据
                    type: 'post', //HTTP请求类型
                    timeout: 10000, //超时时间设置为10秒；
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    success: function (data) {
                        console.log(data);
                        if (data.code == 200) {
                            mui.toast("已经发送邀请，请耐心等待回复");
                            window.setTimeout("location.reload()", 2000)
                        } else {
                            mui.toast(data.msg);
                            window.setTimeout("location.reload()", 2000)
                        }
                    },
                    error: function (xhr, type, errorThrown) {
                        //异常处理；
                        console.log(type);
                    }
                });
                mui("#typePopover").popover("toggle");
            });

            // 工作人员角色popover点击绑定
            // $('.typeList').on('tap', 'li', function () {
            //     var type = $(this).attr('data-type');
            //     var match_id = $('#typePopover').attr('data-matchid');
            //     var member_id = $('#typePopover').attr('data-memberid');
            //     mui.ajax("{:url('api/league/invitematchmebmer')}", {
            //         data: {
            //             match_id: match_id,
            //             member_id: member_id,
            //             type: type
            //         },
            //         dataType: 'json', //服务器返回json格式数据
            //         type: 'post', //HTTP请求类型
            //         timeout: 10000, //超时时间设置为10秒；
            //         headers: {
            //             'Content-Type': 'application/json'
            //         },
            //         success: function (data) {
            //             console.log(data);
            //             if (data.code == 200) {
            //                 mui.toast("已经发送邀请，请耐心等待回复");
            //                 window.setTimeout("location.reload()", 2000)
            //             } else {
            //                 mui.toast(data.msg);
            //                 window.setTimeout("location.reload()", 2000)
            //             }
            //         },
            //         error: function (xhr, type, errorThrown) {
            //             //异常处理；
            //             console.log(type);
            //         }
            //     });
            // });

            // 接口获取数据并追加到页面
            function toList() {
                //搜索关键字不能完全为空，否则查询为空
                var url = "{:url('api/member/getmemberlistpage','','',true)}";
                mui.ajax({
                    url: url,
                    data: {
                        keyword: keyword,
                    },
                    dataType: 'json', //服务器返回json格式数据
                    type: 'post', //HTTP请求类型
                    timeout: 10000, //超时时间设置为10秒；
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    success: function (data) {
                        console.log(data)
                        var newli = '';
                        if (data.code == 200) {
                            for (var i = 0; i <= data.data.data.length - 1; i++) {
                                newli += '<li class="mui-table-view-cell mui-media listli">';
                                newli += '<img class="img45 mui-pull-left" src="' + data.data.data[
                                        i].avatar +
                                    '" style="margin-top: 4px;"><div class="mui-media-body wd60">' +
                                    data.data.data[i].member;
                                newli += '<p>' + data.data.data[i].province + '&nbsp;' + data.data.data[
                                        i].city + '&nbsp;' + data.data.data[i].area +
                                    '</p></div><div class="price-frame"><a href="#typePopover" class="btn bgred typePo" data-member_id="' +
                                    data.data.data[i].id +
                                    '" style="margin-top:5px;padding: 8px 10px;border-radius: 3px;" >邀请</a></div>'
                                newli += '</li>';
                            }
                        }
                        $("ul.memberList").empty().append(newli);
                        if (newli == '') {
                            $("ul.memberList").html(
                                '<li class="nodata"><i class="icon iconfont icon-logo-Big"></i><p>没有相关数据哦</p></li>'
                            );
                        }
                    },
                    error: function (xhr, type, errerThrown) {
                        mui.toast('网络异常,请稍候再试');
                    }
                });
            };
        })
    </script>
</body>

</html>