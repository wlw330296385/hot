<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>打卡</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!--标准mui.css-->
    <link rel="stylesheet" href="/static/frontend/css/mui.min.css">
    <link rel="stylesheet" type="text/css" href="/static/frontend/css/icons-extra.css">
    <!--自定义style.css-->
    <link rel="stylesheet" type="text/css" href="/static/frontend/css/style.css" />
    <!--自定义多色图标icon.js-->
    <script src="/static/frontend/iconfont/iconfont.js"></script>
    <link rel="stylesheet" href="/static/frontend/css/calendar.css">

    <style type="text/css">
        .coloricon {
            width: 2.3em;
            height: 2.3em;
            vertical-align: -0.7em;
            fill: currentColor;
            overflow: hidden;
        }

        .sportDk {
            position: fixed;
            bottom: 60px;
            padding: 12px;
            left: 0;
            right: 0;
            margin: 0 auto;
            width: 70%;
            text-align: center;
        }

        .sportDkText span {
            margin-top: 5px;
        }

        .mui-grid-view.mui-grid-9 .mui-table-view-cell {
            border: none;
        }

        .dragClass {
            width: 60px;
            height: 60px;
            line-height: 60px;
            position: fixed;
            background-color: #ff7f00;
            border-radius: 50%;
            text-align: center;
            font-size: 14px;
            box-shadow: 0 0 5px 0 #da7908;
            bottom: 90px;
            right: 48px;
            z-index: 11;
        }

        .dragClass a.punch {
            color: #fff;
            z-index: 999;
            position: relative;
            display: block;
            width: 60px;
            height: 60px;
            text-align: center;
        }

        .waveRaidus {
            opacity: 0;
            position: absolute;
            left: 50%;
            top: 50%;
            -webkit-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
            -webkit-animation: waveRaidus 2s ease-out 0s infinite;
            animation: waveRaidus 2s ease-out 0s infinite;
            background-color: #ff7f00;
            border-radius: 50%;
        }

        @-webkit-keyframes waveRaidus {
            0% {
                width: 100%;
                height: 100%;
                opacity: 0;
            }
            65% {
                width: 100%;
                height: 100%;
                opacity: 0;
            }
            66% {
                width: 100%;
                height: 100%;
                opacity: 0.8;
            }
            100% {
                width: 130%;
                height: 130%;
                opacity: 0;
            }
        }

        .punchList .colorgray {
            color: #CCC !important;
            margin-left: 5px;
            margin-right: 5px;
        }

        .punchList img {
            border-radius: 5px;
        }

        .others_punchList li {
            padding: 10px;
        }
        .others_punchList img {
            border-radius: 6px;
        }
        .others_punchList .mui-media-body {
            height: auto !important;
        }
        .others_punchList .mui-media-body p{
            font-size: 12px;
            margin: 8px;
        }

        .banner {
            background:url('/static/frontend/images/hot_gray.png');
            background-size:cover;
            height: 180px;
            position: relative;
        }

        /* 效果CSS开始 */
        .eye_wrapper{
            text-align: center;
            position: absolute;
            bottom: -20px;
            z-index: 9;
        }
        .eye_wrapper .head{
            width:90%;
        }
        .eye_wrapper2{
            text-align: center;
            position: absolute;
            bottom: -20px;
            z-index: 10;
        }
        .eye_wrapper2 .eye{
            width:90%;
        }
        .eye_wrapper .eye-left{
            position:absolute;
            top:97px;
            left:30px}
        .eye_wrapper .eye-right{
            position:absolute;
            top:95px;
            left:96px}
        /* 效果CSS结束 */

    </style>
</head>

<body>

    <div id="calendar" class="calendar"></div>
    <div class="hide punchTimeList"></div>

    <p class="pline"></p>
    <div class="mui-content">
        <div class="list" style="margin-bottom: 60px;">

            <ul class="mui-table-view mb">
                <li class="mui-table-view-cell listli">
                    <img src="{$memberInfo.avatar}" class="img40">
                    <text class="f16">{$memberInfo.member}</text>
                    <span style="margin-top: 9px; width: 54%;">本月打卡
                        <text class="colororange">{$monthPunch}</text> 次，<a href="{:url('score/myScore',['member_id'=>$memberInfo['id']])}" class="">获得 <text class="colororange">{$monthPunch*5}</text> 积分 </a>
                    </span>
                </li>
            </ul>

            <div class="nav-list borderStyle">
                <ul class="mui-table-view mui-grid-view mui-grid-9 nav-list-frame">
                    <li class="mui-table-view-cell mui-media mui-col-xs-3 mui-col-sm-3" style="opacity: 0.5;">
                        <div class="goConfirm">
                            <svg class="coloricon" aria-hidden="true">
                                <use xlink:href="#icon-punch-vs"></use>
                            </svg>
                            <div class="mui-media-body" style="font-size: 14px !important; margin-top: 11px;">挑战</div>
                        </div>
                    </li>
                    <li class="mui-table-view-cell mui-media mui-col-xs-3 mui-col-sm-3">
                        <a class="" href="{:url('Punch/sportPlanList')}">
                            <svg class="coloricon" aria-hidden="true">
                                <use xlink:href="#icon-punch-plan"></use>
                            </svg>
                            <div class="mui-media-body" style="font-size: 14px !important">计划</div>
                        </a>
                    </li>
                    <li class="mui-table-view-cell mui-media mui-col-xs-3 mui-col-sm-3">
                        <a class="group" href="{:url('Group/index')}">
                            <svg class="coloricon" aria-hidden="true">
                                <use xlink:href="#icon-punch-community"></use>
                            </svg>
                            <div class="mui-media-body" style="font-size: 14px !important">社群</div>
                        </a>
                    </li>
                    <li class="mui-table-view-cell mui-media mui-col-xs-3 mui-col-sm-3" style="opacity: 0.5;">
                        <div class="goConfirm">
                            <svg class="coloricon" aria-hidden="true">
                                <use xlink:href="#icon-punch-success"></use>
                            </svg>
                            <div class="mui-media-body" style="font-size: 14px !important; margin-top: 11px;">成就</div>
                        </div>
                    </li>
                </ul>
            </div>

            <div class="page-header">
                <span class="course">
                    我的打卡 <text style="color:#CCC;margin: 0px 5px;">|</text> <a href="{:url('Punch/punchPhotoWall')}" class="colororange"><span class="mui-badge mui-badge-danger">照片墙</span></a>
                </span>
                <span class="more pdr15">
                    <a href="{:url('punch/punchList')}" class="mui-navigate-right">更多</a>
                </span>
            </div>

            <ul class="mui-table-view mb punchList">
            </ul>
            <p class="moreRecord mui-text-center bggray2 f14" style="padding:10px;">
                <a href="{:url('punch/punchList')}">查看更多我的打卡记录</a>
            </p>

            <div class="banner">
                <div class="eye_wrapper">
                    <img alt="Head" class="head" src="/static/frontend/images/hotCartoon.png" />
                </div>
                <div class="eye_wrapper2">
                    <img alt="eye" class="eye" src="/static/frontend/images/hotCartoon2.png" />
                </div>
            </div>

            <div class="page-header whitebg mui-text-center">
                <span class="f14">
                    他/她们也在打卡哦！
                </span>
            </div>
            <ul class="mui-table-view mui-grid-view others_punchList"></ul> 
            <p class="moreOthers mui-text-center bggray2 f14" style="padding:10px;">
                查看更多...
            </p>   


            <div class="dragClass" id="drag">
                <a class="punch" href="{:url('Punch/createPunch')}">打卡</a>
                <div class="waveRaidus"></div>
            </div>
        </div>
    </div>

    <!--底部导航-->
    {layout name="Layout/footer"}
</body>
<script src="/static/frontend/js/mui.min.js"></script>
<script src="/static/frontend/js/jquery-3.2.1.min.js"></script>
<script src="/static/frontend/js/common.js"></script>
<script src="/static/frontend/js/mobile_date.js"></script>
<script src="/static/frontend/js/calendar.js"></script>
<script src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>

<script>

  $('#calendar').calendar({
    //setDate: '2018-8-1'
  });

    var oCount = 1;
    $(function () {
        
        toOtherList(1, 1);
        //点击查看更多别人的打卡记录
        $(".moreOthers").click(function () {
            pullupRefresh();
        })
        //下拉刷新具体业务实现
        function pulldownRefresh() {
            setTimeout(function () {
                oCount = 1;//刷新并显示第一页
                var page = oCount;
                var gType = 1;//代表下拉刷新
                toOtherList(page, gType);//具体取数据的方法
            }, 100);
        }
        //上拉加载具体业务实现
        function pullupRefresh() {
            setTimeout(function () {
                oCount++;//翻下一页
                var page = oCount;
                var gType = 2;//代表上拉加载
                toOtherList(page, gType);//具体取数据的方法
            }, 100);
        }

    })
        //接口获取数据并追加到页面
        var toOtherList = function (page, gType) {
                // 打卡首页的打卡记录列表
                var member_id = "{$memberInfo.id}"
                var url = "{:url('api/punch/getOtherPunchListApi','','',true)}" +'/member_id/'+ member_id+'/?page=' + page;
                mui.ajax({
                    url: url,
                    data: {
                    },
                    dataType: 'json',//服务器返回json格式数据
                    type: 'post',//HTTP请求类型
                    timeout: 10000,//超时时间设置为10秒；
                    headers: { 'Content-Type': 'application/json' },
                    success: function (data) {
                        console.log(data)
                        var newli = '';
                        if (data.code == 200) {
                            for (var i = 0; i <= data.data.length - 1; i++) {
                                var urls = "{:url('punch/punchInfo')}/" + 'punch_id/' + data.data[i].id + '/?punch=list';
                                newli += '<li class="mui-table-view-cell mui-media mui-col-xs-6"><a href="' + urls + '"><img class="mui-media-object" src="' + data.data[i].image_url + '"><div class="mui-media-body"><text class="colororange">' +  data.data[i].member +'</text> # '+ data.data[i].name +' '+ data.data[i].duration + 'min<p class="f12">'+data.data[i].punch_time+'</p></div></a></li>'
                            }
                        }
                        if (gType == 1) {
                            //上拉刷新
                            $("ul.others_punchList").empty().append(newli);
                            if (newli == '') {
                                $("ul.others_punchList").html('<li class="nodata"><i class="icon iconfont icon-logo-Big"></i><p>没有任何打卡记录，怪哉！</p></li>');
                            }
                        } else {
                            //下拉加载 gType==2
                            $("ul.others_punchList").append(newli);
                        }

                    },
                    error: function (xhr, type, errerThrown) {
                        mui.toast('网络异常,请稍候再试');
                    }
                });
        };
</script>

<script>
    var count = 1

    $(function () {
        if ("{$memberInfo.id}" == 0) {
            $(".group").attr("href", "javascript:;");
            $(".punch").attr("href", "javascript:;");
        }
        $(".punch").on("tap", function () {
            checkKogin()
        });
        $(".group").on("tap", function () {
            checkKogin()
        });
        $(".goConfirm").click(function () {
            mui.toast('暂未开放，敬请期待');
        });

        toPunchList(); //获取我的打卡记录列表 
        toMonthPunchList(); //输出月份的打卡记录列表

        $(document).on("tap", ".arrow-prev", function () {
            setTimeout(function () {
                var month_str = $("#calendar .title").text();
                toMonthPunchList();
            }, 100)


        });
        $(document).on("tap", ".arrow-next", function () {
            setTimeout(function () {
                var month_str = $("#calendar .title").text();
                toMonthPunchList();
            }, 100)
        });
    })

    function checkKogin() {
        if ("{$memberInfo.id}" == 0) {
            mui.confirm('请完善您的信息，以便进行后续操作，谢谢！', '提示', ['取消', '前往完善'], function (e) {
                if (e.index === 1) {
                    window.location.href = "{$fasturl}";
                }
            });
            return false;
        }
    }


    //输出月份的打卡记录列表
    function toMonthPunchList() {
        var url = "{:url('api/punch/getMonthPunchListApi','','',true)}";
        var month_str = $("#calendar .title").text();
        mui.ajax({
            url: url,
            data: {
                month_str: month_str,
            },
            dataType: 'json', //服务器返回json格式数据
            type: 'post', //HTTP请求类型
            timeout: 10000, //超时时间设置为10秒；
            headers: {
                'Content-Type': 'application/json'
            },
            success: function (data) {
                console.log(data)
                var newli = "";
                if (data.code == 200) {
                    for (var i = 0; i <= data.data.length - 1; i++) {
                        var punch_time = data.data[i].punch_time;
                        var clName = ".calendar-date .item-curMonth.c"+punch_time.substring(8);
                        $(clName).addClass("endDK");
                    }
                }
            },
            error: function (xhr, type, errerThrown) {
                mui.toast('网络异常,请稍候再试');
            }
        });
    };


    //获取我的打卡记录列表
    function toPunchList() {
        var url = "{:url('api/punch/getPunchListApi','','',true)}";
        var member_id = "{$memberInfo.id}"
        mui.ajax({
            url: url,
            data: {
                member_id: member_id,
            },
            dataType: 'json', //服务器返回json格式数据
            type: 'post', //HTTP请求类型
            timeout: 10000, //超时时间设置为10秒；
            headers: {
                'Content-Type': 'application/json'
            },
            success: function (data) {
                console.log(data)
                var newli = "";
                if (data.code == 200) {
                    for (var i = 0; i <= data.data.length - 1; i++) {
                        var urls = "{:url('punch/punchInfo')}/" + 'punch_id/' + data.data[i].id + '/?punch=index';
                        newli += ' <li class="mui-table-view-cell mui-media listli"><a href="' + urls +
                            '" class="mui-navigate-right">';
                        newli += '<img class="mui-media-object mui-pull-left" src="' + data.data[i].image_url +
                            '"><div class="mui-media-body wd f16">' + data.data[i].member +
                            ' <i class="colorgray">|</i> <strong>' + data.data[i].name + '</strong> <i class="colorgray">|</i> <text class="f12">' + data.data[i].duration + 'min</text>';
                        newli += '<p class="lineHeight20">' + data.data[i].punch_time +
                            ' &nbsp;<i class="icon iconfont icon-punch-bonuspool colororange f16"></i> 打卡金 <text class="colororange">' +
                            data.data[i].stakes + '</text> &nbsp;打赏 <text class="colororange">' + data.data[
                                i].rewards_money +
                            '</text> &nbsp; 评论 <text class="colororange">' + data.data[i].comments + '</text></p>';
                        newli += '</div></a></li>'
                        if(i==2){
                            break;
                        }
                    }
                    if (newli == '') {
                        newli = '<li class="nodata"><i class="icon iconfont icon-logo-Big"></i><p>没有打卡记录哦</p></li>'
                    }
                }
                $(".punchList").html(newli);

            },
            error: function (xhr, type, errerThrown) {
                mui.toast('网络异常,请稍候再试');
            }
        });
    };

    var int=self.setInterval("looklook()",2000)
    function looklook(){
        if($('.eye_wrapper2').hasClass('hide')){
            $('.eye_wrapper2').removeClass("hide");
        }else{
            $('.eye_wrapper2').addClass("hide");
        }
    }
    
</script>
<!-- 悬浮拖动按钮 -->
<script>
    window.onload = function () {
        var flag = 0; //标记是拖曳还是点击
        var oDiv = document.getElementById('drag');
        var disX, moveX, L, T, starX, starY, starXEnd, starYEnd;
        oDiv.addEventListener('touchstart', function (e) {
            flag = 0;
            e.preventDefault(); //阻止触摸时页面的滚动，缩放
            disX = e.touches[0].clientX - this.offsetLeft;
            disY = e.touches[0].clientY - this.offsetTop;
            //手指按下时的坐标
            starX = e.touches[0].clientX;
            starY = e.touches[0].clientY;
            //console.log(disX);
        });
        oDiv.addEventListener('touchmove', function (e) {
            flag = 1;
            L = e.touches[0].clientX - disX;
            T = e.touches[0].clientY - disY;
            //移动时 当前位置与起始位置之间的差值
            starXEnd = e.touches[0].clientX - starX;
            starYEnd = e.touches[0].clientY - starY;
            //console.log(L);
            if (L < 0) {
                //限制拖拽的X范围，不能拖出屏幕
                L = 0;
            } else if (L > document.documentElement.clientWidth - this.offsetWidth) {
                L = document.documentElement.clientWidth - this.offsetWidth;
            }
            if (T < 0) {
                //限制拖拽的Y范围，不能拖出屏幕
                T = 0;
            } else if (T > document.documentElement.clientHeight - this.offsetHeight) {
                T = document.documentElement.clientHeight - this.offsetHeight;
            }
            moveX = L + 'px';
            moveY = T + 'px';
            //console.log(moveX);
            this.style.left = moveX;
            this.style.top = moveY;
        });
        // window.addEventListener('touchend', function (e) {
        //     //alert(parseInt(moveX))
        //     //判断滑动方向
        //     if (flag === 0) {
        //         //点击

        //     }
        // });
    }
</script>

<script>
    wx.config({
        //debug: true,
        appId: "{$jsapi['appId']}",
        timestamp: "{$jsapi['timestamp']}",
        nonceStr: "{$jsapi['nonceStr']}",
        signature: "{$jsapi['signature']}",
        jsApiList: [
            // 所有要调用的 API 都要加到这个列表中
            'checkJsApi',
            'onMenuShareTimeline',
            'onMenuShareAppMessage',
            'onMenuShareQQ'
        ]
    });
    wx.ready(function () {
        // 分享到朋友圈
        wx.onMenuShareTimeline({
            title: '17运动，一起来运动吧！',
            desc: '{$memberInfo.member}邀你来PK！',
            link: "{$shareurl}/pid/{$mid}",
            imgUrl: "{:request()->root(true)}/static/frontend/images/sport.jpg",
            success: function () {},
            cancel: function () {}
        });
        // 分享给朋友
        wx.onMenuShareAppMessage({
            title: '17运动，一起来运动吧！',
            desc: '{$memberInfo.member}邀你来PK！',
            link: "{$shareurl}/pid/{$mid}",
            imgUrl: "{:request()->root(true)}/static/frontend/images/sport.jpg",
            type: "",
            dataUrl: '',
            success: function () {},
            cancel: function () {}
        });

    });
</script>

</html>