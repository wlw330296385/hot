<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>每月运动照片墙</title>
    <meta name="viewport" content="width=1000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!--标准mui.css-->
    <link rel="stylesheet" href="/static/frontend/css/mui.min.css">
    <link rel="stylesheet" type="text/css" href="/static/frontend/css/icons-extra.css">
    <!--自定义style.css-->
    <link rel="stylesheet" type="text/css" href="/static/frontend/css/style.css" />
    <!--选择器样式-->
    <link rel="stylesheet" href="/static/frontend/css/calendar.css">

    <style type="text/css">


        html,body { margin:0px 0px 90px; padding:0px; width:1000px; }
        p{ color:#FFF; }

        #popupShare { width:1000px; visibility:hidden; position: absolute; top:0; left: 0; z-index: 888; }
        #pageShare { width:1000px; font-family: "Microsoft Yahei", Arial, sans-serif; position:relative; }
        #canvasPic { display:none; }
        #fixTop{ width:1000px; height:100px; background-color:#F60; text-align:center; position:fixed; left:0; bottom:0; z-index:997; font-size:42px; }
        #fixTop span,#fixTop a { display:block; width:25%; height:100px; line-height:85px; color:#fff; text-decoration:none; float: left; }
        #fixTop a { width:50%; }
        #fixTop .mui-icon { font-size: 56px; }

        #fixTopAfter { display: none; background-color:#690; color:#fff; text-decoration:none; font-size: 42px; width:1000px; height:100px; line-height:95px; text-align:center; position:fixed; left:0; bottom:0; z-index:997; }
        #fixTopAfter .fr { display:block; float: left; width: 80%; }
        #fixTopAfter .fl { display:block; width: 10%; float: left; margin-top: 20px; color:#fff; font-size: 56px;  }

        #photoWall { position: relative; z-index: 10; }
        #photoWall>div { float: left; width: 25%; margin: -2px 0px; padding: 1px; }
        #photoWall img { width: 100%; margin: 0px; }
        #wallTop { position: absolute; left: 0px; top:0px; z-index: -1 }
        #wallbottom { position: absolute; left: 0px; bottom:0px; z-index: 1 }

        .mui-content { background:#FFF; padding-top: 30px; }
        #calendar { background: none !important; padding:30px 0px 0px; border: none !important; }
        .calendar{ border-radius: 0px; }
        .calendar-title { height: 120px; padding: 38px 25px; background:none; display: none; }
        .calendar-title .iconfont{ font-size: 80px; }
        .calendar-title .title{ font-size: 44px; }
        .calendar-title .hotTitle{ font-size: 44px; display: inline-block; color: #fff; vertical-align: top; text-indent: 20px; }
        .calendar-title .arrow { width: auto; top:30px; right: 20px; }
        .calendar-title .arrow .mui-icon{ font-size: 58px; }
        .calendar-week{ width: 100%; font-size: 32px; }
        .calendar-date .item{ font-size: 32px; }
        .calendar-date .item-curDay, .calendar-date .item-curDay:hover{ background-color: #FFFFFF; color: #ddd; }
        .calendar-date .item-curMonth.item-curDay, .calendar-date .item-curMonth.item-curDay:hover{ background-color: #FFFFFF; color: #333; }

        .page-header{ width:95%; margin:0px auto; padding: 60px 20px 20px; background: none !important; line-height: 60px; color:#FFF; text-align: right; }
        .page-header span { font-size: 42px; text-shadow: 1px 1px 1px #222; }
        .page-header .fl text { font-size: 48px; }
        .page-header .pCount { margin: 0px 10px; }
        .page-header img { margin-right: 15px; height: 100px; width:100px; border-radius: 50%; vertical-align: middle; }

        .shareInfo { width: 100%; padding: 50px 30px 50px; position: relative; z-index: 20; }
        .shareInfo .fr { margin-top: 90px; }
        .shareInfo .iconfont { font-size: 160px; opacity: 0.3; color:#FFF; }
        .sInfo { line-height: 52px; margin-top: 20px; font-size: 32px; color:#FFF; }
        .qrcode { float: left; color:#333; text-align: center; }
        .qrcode span { display:block; width:244px; height:40px; font-size:18px; }
        .qrcode img { width:200px; margin-right: 20px; }

        .s2000 { width: 2000px !important;  }
        .s2000 .calendar-title { height: 200px; padding: 80px 50px; }
        .s2000 .calendar-title .iconfont{ font-size: 160px; }
        .s2000 .calendar-title .title{ font-size: 86px; }
        .s2000 .calendar-title .hotTitle{ font-size: 86px; }
        .s2000 .calendar-title .arrow { width: auto; top:50px; right: 50px; }
        .s2000 .calendar-title .arrow .mui-icon{ font-size: 86px; }
        .s2000 .calendar-week{ width: 100%; font-size: 72px; }
        .s2000 .calendar-date .item{ font-size: 72px; }

        .s2000 .page-header{ width:95%; padding: 150px 60px 60px; line-height: 100px }
        .s2000 .page-header span { font-size: 72px; text-shadow: 8px 8px 8px #222; }
        .s2000 .page-header .fl text { font-size: 82px; }
        .s2000 .page-header .pCount { margin: 0px 20px; }
        .s2000 .page-header img { margin-right: 35px; height: 160px; width:160px; border-radius: 50%; vertical-align: middle; }

        .s2000 .shareInfo { width: 100%; padding: 150px 80px 150px;}
        .s2000 .shareInfo .fr { margin-top: 200px; }
        .s2000 .shareInfo .iconfont { font-size: 320px; opacity: 0.3; }
        .s2000 .sInfo { line-height: 110px; margin-top: 40px; font-size: 78px;}
        .s2000 .qrcode { float: left; color:#333; text-align: center; }
        .s2000 .qrcode img { width:400px; margin-right: 40px; }


        .mui-backdrop{ display: none; background-color: #000; opacity: 0.9; }

        @-webkit-keyframes rotate_pacman_half_up {
          0% {
            -webkit-transform: rotate(270deg);
                    transform: rotate(270deg); }

          50% {
            -webkit-transform: rotate(360deg);
                    transform: rotate(360deg); }

          100% {
            -webkit-transform: rotate(270deg);
                    transform: rotate(270deg); } }

        @keyframes rotate_pacman_half_up {
          0% {
            -webkit-transform: rotate(270deg);
                    transform: rotate(270deg); }

          50% {
            -webkit-transform: rotate(360deg);
                    transform: rotate(360deg); }

          100% {
            -webkit-transform: rotate(270deg);
                    transform: rotate(270deg); } }

        @-webkit-keyframes rotate_pacman_half_down {
          0% {
            -webkit-transform: rotate(90deg);
                    transform: rotate(90deg); }

          50% {
            -webkit-transform: rotate(0deg);
                    transform: rotate(0deg); }

          100% {
            -webkit-transform: rotate(90deg);
                    transform: rotate(90deg); } }

        @keyframes rotate_pacman_half_down {
          0% {
            -webkit-transform: rotate(90deg);
                    transform: rotate(90deg); }

          50% {
            -webkit-transform: rotate(0deg);
                    transform: rotate(0deg); }

          100% {
            -webkit-transform: rotate(90deg);
                    transform: rotate(90deg); } }

        @-webkit-keyframes pacman-balls {
          75% {
            opacity: 0.7; }

          100% {
            -webkit-transform: translate(-100px, -6.25px);
                    transform: translate(-100px, -6.25px); } }

        @keyframes pacman-balls {
          75% {
            opacity: 0.7; }

          100% {
            -webkit-transform: translate(-100px, -6.25px);
                    transform: translate(-100px, -6.25px); } }

        .pacman {
                position: fixed;
                left: 500px;
                top: 500px;
                z-index: 9999;
                display: none;
         }
          .pacman > div:nth-child(2) {
            -webkit-animation: pacman-balls 1s 0s infinite linear;
                    animation: pacman-balls 1s 0s infinite linear; }
          .pacman > div:nth-child(3) {
            -webkit-animation: pacman-balls 1s 0.33s infinite linear;
                    animation: pacman-balls 1s 0.33s infinite linear; }
          .pacman > div:nth-child(4) {
            -webkit-animation: pacman-balls 1s 0.66s infinite linear;
                    animation: pacman-balls 1s 0.66s infinite linear; }
          .pacman > div:nth-child(5) {
            -webkit-animation: pacman-balls 1s 0.99s infinite linear;
                    animation: pacman-balls 1s 0.99s infinite linear; }
          .pacman > div:first-of-type {
            width: 0px;
            height: 0px;
            border-right: 25px solid transparent;
            border-top: 25px solid #fff;
            border-left: 25px solid #fff;
            border-bottom: 25px solid #fff;
            border-radius: 25px;
            -webkit-animation: rotate_pacman_half_up 0.5s 0s infinite;
                    animation: rotate_pacman_half_up 0.5s 0s infinite; }
          .pacman > div:nth-child(2) {
            width: 0px;
            height: 0px;
            border-right: 25px solid transparent;
            border-top: 25px solid #fff;
            border-left: 25px solid #fff;
            border-bottom: 25px solid #fff;
            border-radius: 25px;
            -webkit-animation: rotate_pacman_half_down 0.5s 0s infinite;
                    animation: rotate_pacman_half_down 0.5s 0s infinite;
            margin-top: -50px; }
          .pacman > div:nth-child(3), .pacman > div:nth-child(4), .pacman > div:nth-child(5), .pacman > div:nth-child(6) {
            background-color: #fff;
            width: 15px;
            height: 15px;
            border-radius: 100%;
            margin: 2px;
            width: 10px;
            height: 10px;
            position: absolute;
            -webkit-transform: translate(0, -6.25px);
                -ms-transform: translate(0, -6.25px);
                    transform: translate(0, -6.25px);
            top: 25px;
            left: 100px; }


    </style>
</head>

<body>

<div class="loader">
    <div class="loader-inner pacman">
      <div></div>
      <div></div>
      <div></div>
      <div></div>
      <div></div>
    </div>
  </div>
  <div class="mui-backdrop"></div>

<div id="pageShare">
    <div id="wallTop"><img src="/static/frontend/images/photowalltop.jpg" width="100%" /></div>
    <div class="page-header">
            <span class="fl">
                <img src="{$userInfo.avatar}" style="border-radius: 50%; ">
                <text>{$userInfo.member}</text>
            </span>
            <span class="fr">
                <span class="wd49">
                    <text class="punchYM">{$currYear}-{$currMonth}</text> 运动 <strong class="colororange pCount"></strong> 次<br />
                    累计打卡 <strong class="colororange">{$totalPunch}</strong> 次
                </span>
            </span>
    </div>
    <div id="calendar" class="calendar">
    </div>
    <div class="mui-content">

        <div id="photoWall"></div>
        <div style="clear: both;"></div>
        <div class="shareInfo">
            <div class="fr"><span class="icon iconfont icon-logo-Big"></span></div>
            <div class="qrcode">
                <img src="{$qrcodeimg}" />
            </div>
            <div class="sInfo">17运动，一起运动<br />记录您运动的每一天！<br />篮球管家</div>
            <div style="clear: both;"></div>
        </div>
        <div id="wallbottom"><img src="/static/frontend/images/photowallbottom.jpg" width="100%" /></div>
    </div>
</div>

<div id="fixTop">
    <span class="month-prev"><i class="mui-icon mui-icon-back"></i> 上月</span>
    <a id="btnSave">合成图片并分享</a>
    <span class="month-next">下月 <i class="mui-icon mui-icon-forward"></i></span>
</div>

<div id="fixTopAfter">
    <span class="mui-icon mui-icon-close fl"></span>
    <span class="fr">请长按图片保存或转发朋友</span>
</div>


<!--canvasPic:页面转画布-->
<div id="canvasPic"></div>
<!--pageShare:画布转图片-->
<div id="popupShare">
    <img src="/static/frontend/images/images/blank.png" id="sharePic" />
</div>

</body>
<script src="/static/frontend/js/mui.min.js"></script>
<script src="/static/frontend/js/jquery-3.2.1.min.js"></script>
<script src="/static/frontend/js/common.js"></script>
<script src="/static/frontend/js/wooApi.js"></script>
<script src="/static/frontend/js/mobile_date.js"></script>
<script src="/static/frontend/js/calendar.js"></script>
<script src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
<script>


    //初始化
    mui.init({
        swipeBack: true //启用右滑关闭功能
    });

    var sInitDate = '';
    var getYM = wooApi.GetQueryString('ym');
    if(getYM!=''&&getYM!=null&&getYM!='undefined'){
        $("#calendar .title").text(getYM);
        sInitDate = getYM+'-01'
    }
    //日历控件:注意设置的日期的月日必须是两位数（如2018-08-08）
    $('#calendar').calendar({
        setDate: sInitDate
    });

    var wUrl = "{$shareurl}/member_id/{$userInfo.id}/pid/{$mid}";
    var punchYM = '{$currMonth}';
    var punchTimes = 0;



    $(function () {


        toMonthPunchList(); //输出月份的打卡记录列表


        $(document).on("tap", ".arrow-prev", function () {
            $(".pCount").text("0");
            setTimeout(function () {
                toMonthPunchList();
            }, 1000)
        });
        $(document).on("tap", ".arrow-next", function () {
            $(".pCount").text("0");
            setTimeout(function () {
                toMonthPunchList();
            }, 1000)
        });


        $(document).on("tap", ".month-prev", function () {
            $(".arrow-prev").trigger("click");
            $(".pCount").text("0");
            setTimeout(function () {
                toMonthPunchList();
            }, 1000)
        });
        $(document).on("tap", ".month-next", function () {
            $(".arrow-next").trigger("click");
            $(".pCount").text("0");
            setTimeout(function () {
                toMonthPunchList();
            }, 1000)
        });

        $(document).on("tap", ".mui-icon-close", function () {
            window.location.reload();

        });

    })

    function checkKogin() {
        if ("{$memberInfo.id}" == 0) {
            mui.confirm('请完善您的信息，以便进行后续操作，谢谢！', '提示', ['取消', '前往完善'], function (e) {
                if (e.index === 1) {
                    window.location.href = "{$fasturl}";
                }
            });
            return false;
        }
    }


    //输出月份的打卡记录列表
    function toMonthPunchList() {
        var url = "{:url('api/punch/getMonthPunchListApi','','',true)}";
        var month_str = $("#calendar .title").text();
        var userID = "{$userInfo.id}"
        $(".punchYM").text(month_str);
        console.log(punchYM)
        mui.ajax({
            url: url,
            data: {
                month_str: month_str,
                member_id: userID
            },
            dataType: 'json', //服务器返回json格式数据
            type: 'post', //HTTP请求类型
            timeout: 10000, //超时时间设置为10秒；
            async:false,
            headers: {
                'Content-Type': 'application/json'
            },
            success: function (data) {
                console.log(data)
                var newli = "";
                
                if (data.code === 200) {
                    // 返回为空 显示无数据
                    if (data.data.length != 0) {

                       for (var i = 0; i <= data.data.length - 1; i++) {
                            //标记日历
                            var punch_time = data.data[i].punch_time;
                            var clName = ".calendar-date .item-curMonth.c"+punch_time.substring(8);
                            $(clName).addClass("endDK");
                            //插入图片
                            var image_url = data.data[i].image_url
                            var urls = "{:url('punch/punchInfo')}/" + 'punch_id/' + data.data[i].id + '/?punch=punchInfo';
                            newli += '<div><a href="'+urls+'"><img src="'+image_url+'" /></a></div>';
                        }
                        $(".pCount").text(data.data.length);
                        punchTimes = data.data.length;
                        //补上缺少的方格
                        var buDiv = data.data.length%4;
                        if(buDiv>0){
                           for (var p = buDiv; p <= 4 - 1; p++) {
                                newli += '<div><a href="/keeper/punch/"><img src="/static/frontend/images/punch_default.jpeg" /></a></div>';
                            }
                        }
                    } else {
                        newli = '<ul class="mui-table-view detalis-list list" style="background: transparent;"><li class="nodata"><i class="icon iconfont icon-logo-Big"></i><p>这个月没有运动打卡哦</p></li></ul>';
                    }
                } else {
                    newli = '<ul class="mui-table-view detalis-list list" style="background: transparent;"><li class="nodata"><i class="icon iconfont icon-logo-Big"></i><p>这个月没有运动打卡哦</p></li></ul>';
                }

                $('#photoWall').html(newli);

            },
            error: function (xhr, type, errerThrown) {
                mui.toast('网络异常,请稍候再试');
            }
        });

        //更新到微信分享
        punchYM = month_str.substring(5);
        if(punchYM<10){
            punchYM = month_str.substring(6);
        }
        WeChatShare(wUrl+'?ym='+month_str,'{$memberInfo.member} # '+punchYM+'月运动照片墙','本月运动打卡'+punchTimes+'次，累计打卡{$totalPunch}次')
    };

</script>

<script type="text/javascript">

    // setTimeout(function() {
    //     document.getElementById("btnSave").click();
    // }, 2000);

    /*生成canvas图形*/

    // 获取按钮id
    var btnSave = document.getElementById("btnSave");
    // 获取内容id
    var content = $("#pageShare");
    // 进行canvas生成
    btnSave.onclick = function(){
        ////////////////////////////////////////////////
        var newTitle = $(".calendar-title .title").text()+' 运动'+$(".pCount").text()+'次';
        $(".calendar-title .title").css("float","right").text(newTitle);
        $(".calendar-title .title").before('<span class="hotTitle">篮球管家</span>');
        $(".calendar-title .arrow").hide();

        var getHeight = $("#pageShare").height();
        $("#pageShare").addClass("s2000");
          var width = $(".item").width()
          $(".item").css("height", width)
          $(".item").css("line-height", width + "px");

        ///////////////////////////////////////////////// 
        $(".mui-backdrop").show();
        $(".pacman").show();
                
        setTimeout(function () {
           
            var h = content.clientHeight;
            var w = content.clientWidth;
            html2canvas(content, {
                scale: 2,
                onrendered: function(canvas) {

                    //添加属性
                    canvas.setAttribute('id','thecanvas');
                    //读取属性值
                    // var value= canvas.getAttribute('id');
                    document.getElementById('canvasPic').appendChild(canvas);
                    var oCanvas = document.getElementById("thecanvas");
                    var img_data2 = Canvas2Image.saveAsJPEG(oCanvas, true, w, h).getAttribute('src');
                    var element = document.getElementById('sharePic');
                    element.src = img_data2;
                    $("#pageShare").hide();
                    $("#fixTop").hide();
                    $("#popupShare img").css("width","1000px")
                    $("#popupShare").css("visibility","visible");
                    $("#fixTopAfter").show();
                    $(".mui-backdrop").hide();
                    $(".pacman").hide();
                }
            });

        }, 2000)
    }



</script>

<!-- 将canvas图片保存成图片 -->
<script src="/static/frontend/js/html2canvas/html2canvas.min.js"></script>
<script src="/static/frontend/js/html2canvas/canvas2image.js"></script>
<script src="/static/frontend/js/html2canvas/base64.js"></script>

<script>

function WeChatShare(url,title,desc){

    wx.config({
        //debug: true,
        appId: "{$jsapi['appId']}",
        timestamp: "{$jsapi['timestamp']}",
        nonceStr: "{$jsapi['nonceStr']}",
        signature: "{$jsapi['signature']}",
        jsApiList: [
            // 所有要调用的 API 都要加到这个列表中
            'checkJsApi',
            'onMenuShareTimeline',
            'onMenuShareAppMessage',
            'onMenuShareQQ'
        ]
    });
    wx.ready(function () {
        // 分享到朋友圈
        wx.onMenuShareTimeline({
            title: title,
            desc: desc,
            link: url,
            imgUrl: "{:request()->root(true)}/{$memberInfo.avatar}",
            success: function () {},
            cancel: function () {}
        });
        // 分享给朋友
        wx.onMenuShareAppMessage({
            title: title,
            desc: desc,
            link: url,
            imgUrl: "{:request()->root(true)}/{$memberInfo.avatar}",
            type: "",
            dataUrl: '',
            success: function () {},
            cancel: function () {}
        });

    });

}

</script>

</html>