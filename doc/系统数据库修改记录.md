


1. 2018-8-17

	sql:
		update lesson set total_giftschedule = total_giftschedule -2,resi_giftschedule = resi_giftschedule+2 where id = 43;
		
		update lesson set total_giftschedule = total_giftschedule + 17,resi_giftschedule = resi_giftschedule-17 where id = 39;

		insert into schedule_giftbuy 
		(camp_id,camp,lesson_id,lesson,member_id,member,quantity,s_sys,status,remarks,create_time,update_time) 
		value (13,'AKcross训练营',39,'南外文华快艇队',-999,'初音快乐',-1,-1,1,'系统添加',unix_timestamp(now()),unix_timestamp(now()))
		,(13,'AKcross训练营',43,'塘朗追梦队',-999,'初音快乐',-3,-1,1,'系统添加',unix_timestamp(now()),unix_timestamp(now()))
		,(13,'AKcross训练营',38,'AKcross课程',-999,'初音快乐',-2,-1,1,'系统添加',unix_timestamp(now()),unix_timestamp(now()))
		,(13,'AKcross训练营',41,'塘朗低年级基础班',-999,'初音快乐',-10,-1,1,'系统添加',unix_timestamp(now()),unix_timestamp(now()))
		,(13,'AKcross训练营',42,'塘朗高年级综合班',-999,'初音快乐',-10,-1,1,'系统添加',unix_timestamp(now()),unix_timestamp(now()));


		update lesson set resi_giftschedule = resi_giftschedule-1 where id = 39;
		update lesson set resi_giftschedule = resi_giftschedule-3 where id = 43;
		update lesson set resi_giftschedule = resi_giftschedule-2 where id = 38;
		update lesson set resi_giftschedule = resi_giftschedule-10 where id = 41;
		update lesson set resi_giftschedule = resi_giftschedule-10 where id = 42;

		insert into schedule_giftbuy 
		(camp_id,camp,lesson_id,lesson,member_id,member,quantity,s_sys,status,remarks,create_time,update_time) 
		value 
		(13,'AKcross训练营',42,'塘朗高年级综合班',-999,'初音快乐',-2,-1,1,'系统添加',unix_timestamp(now()),unix_timestamp(now()));
		update lesson set resi_giftschedule = resi_giftschedule-2 where id = 42;

	目的:由于赠课购买和赠送等原始数据被刘伟霖手动修改,吴丽文与张雅路讨论之后,以最小损失,最小改动方式将刘伟霖修改的数据为准,修改lesson表记录;



2. 2018-8-22

	sql:
		update schedule_member set user_id = 14,member_id = 27,member = 'coachj' where schedule_id in(1167,1151,1150,1127);
		update schedule set coach_id = 14 where id in(1167,1151,1150,1127);

		UPDATE `schedule` SET can_settle_date = 20180822 WHERE can_settle_date in (20180815,20180816,20180817,20180818,20180819,20180820,20180821,20180822);

	目的: 
		1. 由于2018年8月8日-2018年8月20日在录课api做了调整,一切跟班级相关的数据,比如教练工资等,都从班级数据出来,所以录课的时候,用户对教练的更换不生效,只记录了教练的coach,然而coach_id还是以班级表的教练为准导致数据与实际情况不相符;

		2. 由于定时任务少了一个双引号,导致shell脚本没有执行,因此将未结算的课时记录;




3. 2018-8-28

	sql: 
		UPDATE schedule_member  ss 
		INNER JOIN
		(
			 SELECT
			 sm.id as sm_id,
				sm.schedule_id,
				s.student,
				s.id,
				s.member_id,
				s.member 
				FROM
					`schedule_member` AS sm
					INNER JOIN student AS s ON s.student = sm.`user` 
				WHERE
					sm.`schedule_id` IN ( 1167, 1151, 1150, 1127 ) and sm.type = 1
			) as r ON r.sm_id = ss.id
		SET ss.user_id = r.id, ss.member_id = r.member_id ,ss.member = r.member;

	目的: 
		1. 由于 第2条 2018-8-22 第一条sql的where条件少了type=2, 导致学生的数据也一并被修改,因此将学生数据修改回来;

		


4. 2018-8-29

	sql:
		UPDATE `schedule` as s INNER JOIN lesson as l 

		on l.id = s.lesson_id

		SET s.cost = l.cost

		WHERE s.can_settle_date=20180822
		AND s.cost = 0
		AND s.is_school =-1;

	目的: 
		由于2018年8月8日-2018年8月20日在录课api做了调整,一切跟班级相关的数据,比如教练工资等,都从班级数据出来,所以录课的时候,未知原因导致课程单价数据与实际情况不相符;

	result:
		Affected rows: 38



5. 2018-9-12

	sql:
		UPDATE camp_finance set schedule_rebate = 0.2 WHERE camp_id = 13;
	目的:
		存错数值;
	result:	
		Affected rows: 44


	php:
		$list = db('camp_finance')->field('schedule.cost*schedule.students as money2,camp_finance.money,camp_finance.id')->join('schedule','camp_finance.f_id = schedule.id')->where(['camp_finance.camp_id'=>13,'camp_finance.type'=>3])->order('camp_finance.id desc')->select();
        $ids = [];
        foreach ($list as $key => $value) {
            if(($value['money2'])==$value['money']){
                $ids[] = $value['id'];
            }
        }
        $res = db('camp_finance')->where(['id'=>['in',$ids],'camp_id'=>13])->dec('e_balance','money*schedule_rebate')->update();
        $res = db('camp_finance')->where(['id'=>['in',$ids],'camp_id'=>13])->dec('money','money*schedule_rebate')->update();

        $list = db('camp_finance')->field('schedule.cost*schedule.students as money2,camp_finance.money,camp_finance.id')->join('schedule','camp_finance.f_id = schedule.id')->where(['camp_finance.camp_id'=>17,'camp_finance.type'=>3])->order('camp_finance.id desc')->select();
        $ids = [];
        foreach ($list as $key => $value) {
            if(($value['money2'])==$value['money']){
                $ids[] = $value['id'];
            }
        }
        $res = db('camp_finance')->where(['id'=>['in',$ids],'camp_id'=>17])->dec('e_balance','money*schedule_rebate')->update();
        $res = db('camp_finance')->where(['id'=>['in',$ids],'camp_id'=>17])->dec('money','money*schedule_rebate')->update();


    sql:
    	UPDATE camp_finance set schedule_rebate = 0.2 WHERE camp_id = 17 AND date_str ='';
    	update `camp_finance` set date_str = FROM_UNIXTIME(create_time,'%Y%m%d') where date_str= '';

    目的:修复财务数据;(无法修复:安凯早期的数据schedule_rebate为0.2,计算结果仍为0.1,以当时的抽成为准)



6.2018-9-13
	sql:
		update lesson set total_giftschedule=total_giftschedule+1,resi_giftschedule=resi_giftschedule+1 where id = 38;

	目的:原来赠课没统计进去;





7. 2018-9-19
	
	sql:
		update camp_withdraw set point_in_time = 20180731;

	目的:
		因为20180731之前的收入,雅鹿都帮提过了,所以201808731之前的收入都禁止提现,如今提现只能从20180801开始;